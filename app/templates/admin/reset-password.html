<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Autonomite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: linear-gradient(135deg, #01a4a6 0%, #f56453 100%);
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-900">Set Your Password</h1>
            <p class="text-gray-600">Choose a password for your account</p>
        </div>

        <form id="resetForm" class="space-y-6">
            <!-- Token fields hidden by default; shown only if tokens not in URL -->
            <div id="tokenFields" class="hidden space-y-4">
                <div>
                    <label for="accessToken" class="block text-sm font-medium text-gray-700">Access Token</label>
                    <textarea
                        id="accessToken"
                        name="accessToken"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-[#01a4a6] focus:border-[#01a4a6] text-xs"
                        placeholder="Paste your access token here"
                        rows="3"
                    ></textarea>
                </div>
                <div>
                    <label for="refreshToken" class="block text-sm font-medium text-gray-700">Refresh Token</label>
                    <input
                        type="text"
                        id="refreshToken"
                        name="refreshToken"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-[#01a4a6] focus:border-[#01a4a6]"
                        placeholder="Paste your refresh token here"
                    >
                </div>
            </div>

            <div>
                <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
                <input
                    type="password"
                    id="newPassword"
                    name="newPassword"
                    required
                    minlength="6"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-[#01a4a6] focus:border-[#01a4a6]"
                    placeholder="Enter new password"
                >
            </div>

            <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                <input
                    type="password"
                    id="confirmPassword"
                    name="confirmPassword"
                    required
                    minlength="6"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-[#01a4a6] focus:border-[#01a4a6]"
                    placeholder="Confirm new password"
                >
            </div>

            <div>
                <button
                    type="submit"
                    id="resetBtn"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#01a4a6] hover:bg-[#018789] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#01a4a6] disabled:opacity-50"
                >
                    Set Password
                </button>
            </div>
        </form>

        <div id="errorMessage" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden"></div>
        <div id="successMessage" class="mt-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded hidden"></div>

        <div class="mt-6 text-center">
            <a href="/admin/login" class="text-sm text-[#01a4a6] hover:text-[#018789] underline">Back to Login</a>
        </div>
    </div>

    <script>
        const supabaseUrl = '{{ supabase_url }}';
        const supabaseKey = '{{ supabase_anon_key }}';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let autoAccessToken = null;
        let autoRefreshToken = null;

        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.substring(1);
            const urlParams = new URLSearchParams(hash);
            autoAccessToken = urlParams.get('access_token');
            autoRefreshToken = urlParams.get('refresh_token');

            if (!autoAccessToken || !autoRefreshToken) {
                // No tokens in URL — show manual fields
                document.getElementById('tokenFields').classList.remove('hidden');
                document.getElementById('accessToken').setAttribute('required', 'required');
                document.getElementById('refreshToken').setAttribute('required', 'required');
            }
        });

        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const accessToken = autoAccessToken || document.getElementById('accessToken').value.trim();
            const refreshToken = autoRefreshToken || document.getElementById('refreshToken').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resetBtn = document.getElementById('resetBtn');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'Passwords do not match.';
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
                return;
            }

            if (newPassword.length < 6) {
                errorMessage.textContent = 'Password must be at least 6 characters long.';
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
                return;
            }

            if (!accessToken || !refreshToken) {
                errorMessage.textContent = 'Missing authentication tokens. Please use the link from your email.';
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
                return;
            }

            resetBtn.disabled = true;
            resetBtn.textContent = 'Setting password...';

            try {
                const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken
                });

                if (sessionError) throw sessionError;

                const { error: updateError } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (updateError) throw updateError;

                // Store the new session token for admin access
                const newToken = sessionData?.session?.access_token || accessToken;
                localStorage.setItem('admin_token', newToken);
                document.cookie = `admin_token=${newToken}; path=/; max-age=28800`;

                successMessage.textContent = 'Password set successfully! Redirecting to login...';
                successMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');

                setTimeout(() => {
                    window.location.href = '/admin/login';
                }, 2000);

            } catch (error) {
                console.error('Password reset error:', error);
                errorMessage.textContent = error.message || 'Failed to set password. The link may have expired — please request a new one.';
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
                resetBtn.disabled = false;
                resetBtn.textContent = 'Set Password';
            }
        });
    </script>
</body>
</html>
