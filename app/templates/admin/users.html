{% extends "admin/base.html" %}

{% block title %}Users · Sidekick Forge Admin{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-semibold text-white">Users</h1>
  <div class="flex items-center gap-3">
    <button onclick="openAddUserModal()" class="btn-primary px-3 py-2 rounded text-sm">Add User</button>
    <a href="/admin/" class="text-sm text-gray-400 hover:text-brand-teal">Back to Dashboard</a>
  </div>
  </div>

<div class="bg-dark-surface border border-dark-border rounded-lg p-4">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-dark-border">
      <thead>
        <tr class="text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
          <th class="px-4 py-3">Email</th>
          <th class="px-4 py-3">User ID</th>
          <th class="px-4 py-3">Created</th>
          <th class="px-4 py-3">Platform Permissions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-dark-border">
        {% for u in users %}
        <tr>
          <td class="px-4 py-3 text-sm">{{ u.email }}</td>
          <td class="px-4 py-3 text-xs text-gray-400">{{ u.id }}</td>
          <td class="px-4 py-3 text-xs text-gray-400 timestamp" data-timestamp="{{ u.created_at }}">{{ u.created_at }}</td>
          <td class="px-4 py-3 text-xs">
            {% if u.permissions and u.permissions|length > 0 %}
              <div class="flex flex-wrap gap-1">
                {% for p in u.permissions %}
                  <span class="px-2 py-0.5 rounded bg-dark-elevated border border-dark-border text-gray-300">{{ p }}</span>
                {% endfor %}
              </div>
            {% else %}
              <span class="text-gray-500">none</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<!-- Add User Modal -->
<div id="addUserModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
  <div class="bg-dark-surface border border-dark-border rounded-lg p-6 w-full max-w-md">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-white">Add User</h2>
      <button onclick="closeAddUserModal()" class="text-gray-400 hover:text-white">✕</button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Email</label>
        <input type="email" id="newUserEmail" class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated" placeholder="user@example.com" required />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">Role</label>
        <select id="newUserRole" class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated" onchange="toggleClientPicker()">
          <option value="platform_admin">Super Admin</option>
          <option value="tenant_admin">Admin (per client)</option>
          <option value="subscriber">Subscriber (per client)</option>
        </select>
      </div>
      <div id="clientPicker" class="hidden">
        <label class="block text-sm text-gray-300 mb-1">Client(s)</label>
        <select id="newUserClientIds" multiple class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated min-h-[120px]">
          {% for c in clients %}
          <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
        <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple projects.</p>
      </div>
      <div class="flex items-center justify-end gap-2 mt-2">
        <button onclick="closeAddUserModal()" class="px-3 py-2 text-sm text-gray-300 hover:text-white">Cancel</button>
        <button onclick="addUser()" class="btn-primary px-3 py-2 rounded text-sm">Create</button>
      </div>
    </div>
  </div>
</div>

<script>
function openAddUserModal(){
  const m=document.getElementById('addUserModal'); if(m) m.classList.remove('hidden');
}
function closeAddUserModal(){
  const m=document.getElementById('addUserModal'); if(m) m.classList.add('hidden');
}
function toggleClientPicker(){
  const role = document.getElementById('newUserRole').value;
  const picker = document.getElementById('clientPicker');
  if(role === 'tenant_admin' || role === 'subscriber'){ picker.classList.remove('hidden'); }
  else { picker.classList.add('hidden'); }
}
async function addUser(){
  const email=document.getElementById('newUserEmail').value.trim();
  const role=document.getElementById('newUserRole').value;
  const clientIdsEl=document.getElementById('newUserClientIds');
  const selectedClientIds = (role === 'tenant_admin' || role === 'subscriber') && clientIdsEl ? Array.from(clientIdsEl.selectedOptions).map(o => o.value) : [];
  if(!email){ alert('Please enter an email'); return; }
  if((role === 'tenant_admin' || role === 'subscriber') && selectedClientIds.length === 0){ alert('Please select at least one client'); return; }
  try {
    if (window.showGlobalLoading) window.showGlobalLoading('/admin/users/create');
    const res = await fetch('/admin/users/create',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email, role_key: role, client_ids: selectedClientIds })
    });
    if(!res.ok){
      const txt = await res.text();
      console.error('Create user failed', res.status, txt);
      alert('Failed to create user');
      return;
    }
    closeAddUserModal();
    window.location.reload();
  } catch (e){
    console.error(e);
    alert('Error creating user');
  } finally {
    if (window.hideGlobalLoading) window.hideGlobalLoading();
  }
}
</script>
{% endblock %}


