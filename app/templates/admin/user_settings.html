{% extends "admin/base.html" %}

{% block title %}User Settings{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-dark-text">User Settings</h1>
        <p class="text-dark-text-secondary mt-2">Update your profile, security, and channel preferences.</p>
    </div>

    <form action="/admin/user-settings" method="POST">
        <!-- Profile -->
        <div class="bg-dark-surface border border-dark-border rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-dark-border flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-dark-text">Profile</h2>
                    <p class="text-sm text-dark-text-secondary">Basic info used across the platform.</p>
                </div>
                <button class="btn-primary px-4 py-2 rounded-md text-sm" type="submit">Save</button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-dark-text-secondary mb-1">Full Name</label>
                    <input name="full_name" type="text" value="{{ profile.get('full_name') or user.full_name or '' }}" class="w-full px-3 py-2 rounded bg-dark-elevated border border-dark-border text-dark-text">
                </div>
                <div>
                    <label class="block text-sm text-dark-text-secondary mb-1">Email</label>
                    <input name="email" type="email" value="{{ profile.get('email') or user.email or '' }}" class="w-full px-3 py-2 rounded bg-dark-elevated border border-dark-border text-dark-text">
                </div>
                <div>
                    <label class="block text-sm text-dark-text-secondary mb-1">Company</label>
                    <input name="company" type="text" value="{{ profile.get('company') or '' }}" class="w-full px-3 py-2 rounded bg-dark-elevated border border-dark-border text-dark-text">
                </div>
                <div>
                    <label class="block text-sm text-dark-text-secondary mb-1">Phone</label>
                    <input name="phone" type="text" value="{{ profile.get('phone') or '' }}" class="w-full px-3 py-2 rounded bg-dark-elevated border border-dark-border text-dark-text">
                </div>
                <div>
                    <label class="block text-sm text-dark-text-secondary mb-1">Telegram Username</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 bg-dark-elevated border border-dark-border border-r-0 rounded-l text-dark-text-secondary">@</span>
                        <input name="telegram_username" type="text" placeholder="yourhandle" value="{{ profile.get('telegram_username') or '' }}" class="w-full px-3 py-2 rounded-r bg-dark-elevated border border-dark-border text-dark-text">
                    </div>
                    <p class="text-xs text-dark-text-secondary mt-1">We will use this to show your handle; ownership is verified via Telegram deep link.</p>
                </div>
            </div>
            {% if success %}
            <div class="px-6 pb-4 text-sm text-green-400">{{ success }}</div>
            {% endif %}
            {% if error %}
            <div class="px-6 pb-4 text-sm text-red-400">{{ error }}</div>
            {% endif %}
        </div>

    <!-- Channels (Coming Soon) -->
    <div class="relative mb-6">
        <div class="absolute inset-0 z-10 flex items-center justify-center">
            <span class="bg-dark-bg/80 text-brand-teal border border-brand-teal/40 px-4 py-2 rounded-full text-sm font-semibold tracking-wide">Coming Soon</span>
        </div>
    <div class="bg-dark-surface border border-dark-border rounded-lg opacity-40 pointer-events-none">
        <div class="px-6 py-4 border-b border-dark-border flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-dark-text">Channels</h2>
                <p class="text-sm text-dark-text-secondary">Link your Telegram for bot interactions.</p>
            </div>
            <button class="btn-primary px-4 py-2 rounded-md text-sm"
                    type="submit"
                    formaction="/admin/user-settings/telegram/start"
                    formmethod="post">
                Verify Telegram
            </button>
        </div>
        <div class="p-6 space-y-3">
                <div class="flex items-center justify-between bg-dark-elevated border border-dark-border rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 rounded-full bg-sky-500/20 border border-sky-400/40 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" class="h-6 w-6 text-sky-400 fill-current">
                                <path d="M120 0C53.8 0 0 53.8 0 120s53.8 120 120 120 120-53.8 120-120S186.2 0 120 0zm58.3 83.7l-19.6 92.4c-1.5 6.7-5.7 8.3-11.5 5.2l-31.8-23.5-15.3 14.8c-1.7 1.7-3.1 3.1-6.3 3.1l2.3-32.6 59.4-53.6c2.6-2.3-0.6-3.6-4-1.3l-73.5 46.2-31.7-9.9c-6.9-2.2-7.1-6.9 1.5-10.2l124.1-47.8c5.7-2.1 10.7 1.3 8.9 10.1z"/>
                            </svg>
                    </div>
                    <div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-semibold text-dark-text">Telegram</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full {% if pending_code %}bg-brand-teal/20 text-brand-teal{% else %}bg-dark-elevated text-dark-text-secondary{% endif %}">
                                {% if pending_code %}Awaiting confirmation{% else %}Not linked{% endif %}
                            </span>
                        </div>
                        <p class="text-xs text-dark-text-secondary">
                            {% if pending_code %}
                                Open Telegram and tap the deep link below to verify.
                            {% else %}
                                Generate a code to link without typing commands.
                            {% endif %}
                        </p>
                    </div>
                </div>
                {% if pending_code %}
                <div class="flex flex-col items-end space-y-2">
                    <code class="text-sm text-brand-teal bg-dark-surface border border-brand-teal/40 rounded px-3 py-1">/start {{ pending_code }}</code>
                    <a href="https://t.me/{{ telegram_bot_username or '' }}?start={{ pending_code }}" target="_blank"
                       class="btn-primary px-4 py-2 rounded-md text-sm">Open in Telegram</a>
                </div>
                {% else %}
                <div class="flex items-center space-x-2 text-dark-text-secondary text-xs">
                    <span>No pending code</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    </div><!-- end Coming Soon wrapper -->

    <!-- Billing & Subscription -->
    <div class="bg-dark-surface border border-dark-border rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-dark-border flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-dark-text">Billing & Subscription</h2>
                <p class="text-sm text-dark-text-secondary">Manage your subscription and payment methods.</p>
            </div>
            {% if billing and billing.stripe_customer_id %}
            <form action="/admin/user-settings/billing/portal" method="POST" class="inline">
                <button type="submit" class="btn-primary px-4 py-2 rounded-md text-sm">
                    Manage Billing
                </button>
            </form>
            {% endif %}
        </div>
        <div class="p-6">
            {% if billing %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Current Plan -->
                <div class="bg-dark-elevated border border-dark-border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm text-dark-text-secondary">Current Plan</span>
                        {% if billing.subscription_status == 'active' or billing.stripe_subscription_id %}
                        <span class="text-xs px-2 py-0.5 rounded-full bg-green-500/20 text-green-400">Active</span>
                        {% elif billing.subscription_status == 'past_due' %}
                        <span class="text-xs px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-400">Past Due</span>
                        {% elif billing.subscription_status == 'canceled' %}
                        <span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400">Canceled</span>
                        {% elif billing.subscription_status == 'trialing' %}
                        <span class="text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400">Trial</span>
                        {% else %}
                        <span class="text-xs px-2 py-0.5 rounded-full bg-dark-border text-dark-text-secondary">No Subscription</span>
                        {% endif %}
                    </div>
                    <div class="flex items-baseline space-x-2">
                        <span class="text-2xl font-bold text-dark-text">{{ billing.tier_name }}</span>
                        {% if billing.tier_price > 0 %}
                        <span class="text-dark-text-secondary">${{ billing.tier_price }}/mo</span>
                        {% elif billing.tier == 'paragon' %}
                        <span class="text-dark-text-secondary">Custom</span>
                        {% elif billing.stripe_subscription_id %}
                        <span class="text-dark-text-secondary text-green-400">Free (Promo)</span>
                        {% endif %}
                    </div>
                    {% if billing.cancel_at_period_end %}
                    <p class="text-xs text-yellow-400 mt-2">
                        Your subscription will end on {{ billing.subscription_end[:10] if billing.subscription_end else 'the end of your billing period' }}
                    </p>
                    {% elif billing.subscription_end and (billing.subscription_status == 'active' or billing.stripe_subscription_id) %}
                    <p class="text-xs text-dark-text-secondary mt-2">
                        Next billing date: {{ billing.subscription_end[:10] }}
                    </p>
                    {% endif %}
                </div>

                <!-- Workspace Info -->
                <div class="bg-dark-elevated border border-dark-border rounded-lg p-4">
                    <span class="text-sm text-dark-text-secondary block mb-3">Workspace</span>
                    <div class="text-lg font-semibold text-dark-text">{{ billing.client_name or 'My Workspace' }}</div>
                    <p class="text-xs text-dark-text-secondary mt-2">
                        {% if billing.tier == 'adventurer' %}
                        1 Sidekick included
                        {% elif billing.tier == 'champion' %}
                        Up to 5 Sidekicks
                        {% elif billing.tier == 'paragon' %}
                        Unlimited Sidekicks
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Upgrade/Downgrade Options -->
            {% if (billing.subscription_status == 'active' or billing.stripe_subscription_id) and billing.tier != 'paragon' %}
            <div class="mt-6 pt-6 border-t border-dark-border">
                <h3 class="text-sm font-semibold text-dark-text mb-3">Change Your Plan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% if billing.tier == 'adventurer' %}
                    <!-- Upgrade to Champion -->
                    <div class="bg-dark-elevated border border-brand-teal/30 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-dark-text">Champion</span>
                            <span class="text-brand-teal text-sm">$199/mo</span>
                        </div>
                        <p class="text-xs text-dark-text-secondary mb-3">Up to 5 sidekicks, unlimited documents, dedicated database, video chat</p>
                        <form action="/admin/user-settings/upgrade" method="POST">
                            <input type="hidden" name="target_tier" value="champion">
                            <button type="submit" class="w-full btn-primary py-2 rounded-md text-sm">
                                Upgrade to Champion
                            </button>
                        </form>
                        <p class="text-xs text-dark-text-secondary mt-2 text-center">Prorated billing applies</p>
                    </div>
                    {% elif billing.tier == 'champion' %}
                    <!-- Downgrade to Adventurer -->
                    <div class="bg-dark-elevated border border-dark-border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-dark-text">Adventurer</span>
                            <span class="text-dark-text-secondary text-sm">$49/mo</span>
                        </div>
                        <p class="text-xs text-dark-text-secondary mb-3">1 sidekick, 50 documents, shared database</p>
                        <form action="/admin/user-settings/downgrade" method="POST">
                            <input type="hidden" name="target_tier" value="adventurer">
                            <button type="submit" class="w-full px-4 py-2 rounded-md text-sm border border-dark-border text-dark-text-secondary hover:bg-dark-elevated transition-colors">
                                Downgrade to Adventurer
                            </button>
                        </form>
                        <p class="text-xs text-dark-text-secondary mt-2 text-center">Effective at end of billing period</p>
                    </div>
                    {% endif %}

                    <!-- Upgrade to Paragon (shown for both Adventurer and Champion) -->
                    <div class="bg-dark-elevated border border-purple-500/30 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-dark-text">Paragon</span>
                            <span class="text-purple-400 text-sm">Custom</span>
                        </div>
                        <p class="text-xs text-dark-text-secondary mb-3">Unlimited everything, priority support, white-label, custom domain</p>
                        <a href="mailto:sales@autonomite.net?subject=Paragon%20Tier%20Inquiry" class="block w-full text-center px-4 py-2 rounded-md text-sm bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 transition-colors">
                            Contact Sales
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if billing.stripe_customer_id %}
            <div class="mt-6 pt-6 border-t border-dark-border">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div>
                        <p class="text-sm text-dark-text-secondary">
                            Manage payment methods, view invoices, or update billing information.
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <form action="/admin/user-settings/billing/portal" method="POST" class="inline">
                            <button type="submit" class="px-4 py-2 rounded-md text-sm border border-dark-border text-dark-text hover:bg-dark-elevated transition-colors">
                                Billing Portal
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Cancel Subscription -->
                {% if (billing.subscription_status == 'active' or billing.stripe_subscription_id) and not billing.cancel_at_period_end %}
                <div class="mt-4 pt-4 border-t border-dark-border/50">
                    <details class="group">
                        <summary class="text-sm text-dark-text-secondary cursor-pointer hover:text-dark-text transition-colors">
                            Cancel my subscription
                        </summary>
                        <div class="mt-3 p-4 bg-red-500/5 border border-red-500/20 rounded-lg">
                            <p class="text-sm text-dark-text-secondary mb-3">
                                Your subscription will remain active until the end of your current billing period ({{ billing.subscription_end[:10] if billing.subscription_end else 'end of period' }}).
                                You can reactivate anytime before then.
                            </p>
                            <form action="/admin/user-settings/cancel-subscription" method="POST" onsubmit="return confirm('Are you sure you want to cancel your subscription?');">
                                <button type="submit" class="px-4 py-2 rounded-md text-sm border border-red-500/50 text-red-400 hover:bg-red-500/10 transition-colors">
                                    Cancel Subscription
                                </button>
                            </form>
                        </div>
                    </details>
                </div>
                {% elif billing.cancel_at_period_end %}
                <div class="mt-4 pt-4 border-t border-dark-border/50">
                    <div class="p-4 bg-yellow-500/5 border border-yellow-500/20 rounded-lg">
                        <p class="text-sm text-yellow-400 mb-3">
                            Your subscription is set to cancel on {{ billing.subscription_end[:10] if billing.subscription_end else 'the end of your billing period' }}.
                        </p>
                        <form action="/admin/user-settings/reactivate-subscription" method="POST">
                            <button type="submit" class="px-4 py-2 rounded-md text-sm bg-brand-teal text-white hover:bg-brand-teal/80 transition-colors">
                                Keep My Subscription
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="mt-6 pt-6 border-t border-dark-border text-center">
                <p class="text-sm text-dark-text-secondary mb-4">
                    No active subscription found. Contact support if you believe this is an error.
                </p>
                <a href="/checkout" class="btn-primary px-6 py-2 rounded-md text-sm inline-block">
                    View Plans
                </a>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-8">
                <div class="h-12 w-12 rounded-full bg-dark-elevated border border-dark-border flex items-center justify-center mx-auto mb-4">
                    <svg class="w-6 h-6 text-dark-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                </div>
                <p class="text-dark-text-secondary mb-4">No billing information available.</p>
                <a href="/checkout" class="btn-primary px-6 py-2 rounded-md text-sm inline-block">
                    Get Started
                </a>
            </div>
            {% endif %}

            <!-- Success Messages -->
            {% if request.query_params.get('upgrade_success') == 'true' %}
            <div class="mt-4 p-3 bg-green-500/10 border border-green-500/30 rounded-lg text-sm text-green-400">
                Your plan has been upgraded! The prorated charge has been applied to your account.
            </div>
            {% elif request.query_params.get('downgrade_scheduled') == 'true' %}
            <div class="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-sm text-blue-400">
                Your downgrade has been scheduled. It will take effect at the end of your current billing period.
            </div>
            {% elif request.query_params.get('cancel_scheduled') == 'true' %}
            <div class="mt-4 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-sm text-yellow-400">
                Your subscription has been scheduled to cancel at the end of your billing period. You can reactivate anytime before then.
            </div>
            {% elif request.query_params.get('reactivated') == 'true' %}
            <div class="mt-4 p-3 bg-green-500/10 border border-green-500/30 rounded-lg text-sm text-green-400">
                Your subscription has been reactivated! You'll continue to be billed normally.
            </div>
            {% endif %}

            <!-- Error Messages -->
            {% if request.query_params.get('billing_error') == 'no_subscription' %}
            <div class="mt-4 p-3 bg-yellow-500/10 border border-yellow-500/30 rounded-lg text-sm text-yellow-400">
                No active Stripe subscription found. Please contact support if you need assistance.
            </div>
            {% elif request.query_params.get('billing_error') == 'portal_failed' %}
            <div class="mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                Failed to open billing portal. Please try again or contact support.
            </div>
            {% elif request.query_params.get('billing_error') == 'upgrade_failed' %}
            <div class="mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                Failed to upgrade your subscription. Please try again or contact support.
            </div>
            {% elif request.query_params.get('billing_error') == 'downgrade_failed' %}
            <div class="mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                Failed to schedule downgrade. Please try again or contact support.
            </div>
            {% elif request.query_params.get('billing_error') == 'cancel_failed' %}
            <div class="mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                Failed to cancel subscription. Please try again or contact support.
            </div>
            {% elif request.query_params.get('billing_error') == 'stripe_error' %}
            <div class="mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                A payment processing error occurred. Please try again or contact support.
            </div>
            {% elif request.query_params.get('billing_error') %}
            <div class="mt-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                An error occurred. Please try again or contact support.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Security -->
    <div class="bg-dark-surface border border-dark-border rounded-lg">
        <div class="px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-dark-text">Security</h2>
            <p class="text-sm text-dark-text-secondary">Change your password.</p>
        </div>
        <form action="/admin/user-settings/change-password" method="POST">
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm text-dark-text-secondary mb-1">Current Password</label>
                    <input type="password" name="current_password" required
                           class="w-full px-3 py-2 rounded bg-dark-elevated border border-dark-border text-dark-text focus:border-brand-teal focus:outline-none"
                           placeholder="Enter your current password">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-dark-text-secondary mb-1">New Password</label>
                        <input type="password" name="new_password" required minlength="8"
                               class="w-full px-3 py-2 rounded bg-dark-elevated border border-dark-border text-dark-text focus:border-brand-teal focus:outline-none"
                               placeholder="Min. 8 characters">
                    </div>
                    <div>
                        <label class="block text-sm text-dark-text-secondary mb-1">Confirm New Password</label>
                        <input type="password" name="confirm_password" required minlength="8"
                               class="w-full px-3 py-2 rounded bg-dark-elevated border border-dark-border text-dark-text focus:border-brand-teal focus:outline-none"
                               placeholder="Confirm new password">
                    </div>
                </div>

                {% if request.query_params.get('password_success') == 'true' %}
                <div class="p-3 bg-green-500/10 border border-green-500/30 rounded-lg text-sm text-green-400">
                    Password changed successfully.
                </div>
                {% endif %}

                {% if request.query_params.get('password_error') == 'current_required' %}
                <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                    Please enter your current password.
                </div>
                {% elif request.query_params.get('password_error') == 'new_required' %}
                <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                    Please enter a new password.
                </div>
                {% elif request.query_params.get('password_error') == 'too_short' %}
                <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                    New password must be at least 8 characters.
                </div>
                {% elif request.query_params.get('password_error') == 'mismatch' %}
                <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                    New passwords do not match.
                </div>
                {% elif request.query_params.get('password_error') == 'wrong_current' %}
                <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                    Current password is incorrect.
                </div>
                {% elif request.query_params.get('password_error') == 'failed' %}
                <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-sm text-red-400">
                    Failed to change password. Please try again.
                </div>
                {% endif %}
            </div>
            <div class="px-6 pb-6">
                <button type="submit" class="btn-primary px-4 py-2 rounded-md text-sm">
                    Change Password
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
