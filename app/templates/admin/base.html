<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sidekick Forge Admin{% endblock %}</title>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Futura PT Font from Adobe Fonts -->
    <link rel="stylesheet" href="https://use.typekit.net/oqv5jkr.css">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind config with brand colors
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'futura': ['"futura-pt"', 'sans-serif'],
                    },
                    colors: {
                        // Brand colors
                        'brand-teal': '#01a4a6',
                        'brand-orange': '#fc7244',
                        'brand-salmon': '#f56453',
                        // Dark mode colors
                        'dark-bg': '#000000',
                        'dark-surface': 'rgb(20, 20, 20)',
                        'dark-elevated': '#252525',
                        'dark-border': '#2a2a2a',
                        'dark-text': '#e0e0e0',
                        'dark-text-secondary': '#a0a0a0'
                    }
                }
            }
        }
    </script>

    <!-- Custom admin styles -->
    <style>
        /* Dark mode base styles */
        body {
            background: #000000;
            color: #e0e0e0;
            font-family: "futura-pt", sans-serif;
        }

        /* Logo text - Futura PT Light, all caps, single line */
        .logo-text {
            font-family: "futura-pt", sans-serif;
            font-weight: 300;
            font-style: normal;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-size: 18px;
            white-space: nowrap;
        }

        /* Navigation labels - all caps */
        .nav-label {
            text-transform: uppercase;
        }

        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #01a4a6;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #018789;
        }

        /* Status indicators with better dark mode colors */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-running { background-color: #01a4a6; }
        .status-stopped { background-color: #f56453; }
        .status-starting { background-color: #fc7244; }
        .status-pending { background-color: #fc7244; }
        .status-error { background-color: #dc2626; }

        /* Metric cards with brand gradient */
        .metric-card {
            background: linear-gradient(135deg, #01a4a6 0%, #018789 100%);
            color: white;
            border: 1px solid rgba(1, 164, 166, 0.3);
        }

        /* Glassmorphic surfaces */
        .bg-dark-surface {
            background: rgba(20, 20, 20, 0.55) !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-color: rgba(255, 255, 255, 0.08) !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        }
        .bg-dark-elevated {
            background: rgba(28, 28, 28, 0.5) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-color: rgba(255, 255, 255, 0.06) !important;
        }
        .border-dark-border {
            border-color: rgba(255, 255, 255, 0.08) !important;
        }
        /* Inputs on glass */
        input.bg-dark-elevated, textarea.bg-dark-elevated, select.bg-dark-elevated {
            background: rgba(32, 32, 32, 0.55) !important;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-color: rgba(255, 255, 255, 0.08) !important;
        }

        /* Card hover effects */
        .client-card {
            transition: all 0.2s ease-in-out;
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
        }
        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(1, 164, 166, 0.2);
            border-color: #01a4a6;
        }

        /* Form inputs dark mode */
        input, textarea, select {
            background-color: #252525 !important;
            border-color: #2a2a2a !important;
            color: #e0e0e0 !important;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #01a4a6 !important;
            box-shadow: 0 0 0 3px rgba(1, 164, 166, 0.1) !important;
        }

        /* Button styles */
        .btn-primary {
            background-color: #01a4a6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #018789;
        }
        .btn-secondary {
            background-color: #fc7244;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #e05d34;
        }
        .btn-danger {
            background-color: #f56453;
            color: white;
        }
        .btn-danger:hover {
            background-color: #e34c3a;
        }

        /* HTMX indicators */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 500ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .htmx-request.htmx-indicator {
            opacity: 1;
        }

        /* Loading spinner with brand color */
        .spinner {
            border: 2px solid #2a2a2a;
            border-top: 2px solid #01a4a6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        /* Button inline loading state */
        button.loading, a.button.loading {
            position: relative;
            pointer-events: none;
            opacity: 0.9;
        }
        button.loading > *, a.button.loading > * {
            visibility: hidden;
        }
        button.loading::after, a.button.loading::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid #2a2a2a;
            border-top-color: #01a4a6;
            border-radius: 9999px;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animated logo - rotating gem */
        @keyframes gem-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .logo-container {
            position: relative;
            width: 44px;
            height: 44px;
            flex-shrink: 0;
        }
        .logo-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .logo-gem {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            animation: gem-rotate 8s linear infinite;
        }

        /* Sidebar navigation styles */
        .sidebar {
            transition: width 0.3s ease;
            overflow-x: hidden;
        }
        .sidebar.collapsed {
            width: 64px;
        }
        .sidebar.expanded {
            width: 240px;
        }
        /* Auto-expand sidebar on hover (when collapsed and not pinned) */
        .sidebar.collapsed:not(.pinned):hover {
            width: 240px;
        }
        .sidebar.collapsed:not(.pinned):hover .nav-label {
            opacity: 1;
            width: auto;
        }
        .sidebar.collapsed:not(.pinned):hover .sidebar-tooltip {
            opacity: 0 !important;
        }
        .sidebar.collapsed:not(.pinned):hover .logo-text {
            opacity: 1;
            width: auto;
        }
        .sidebar-nav-item {
            transition: all 0.2s ease;
        }
        .sidebar-nav-item:hover {
            background-color: rgba(1, 164, 166, 0.1);
        }
        .sidebar-nav-item.active {
            background-color: rgba(1, 164, 166, 0.15);
            border-left: 3px solid #01a4a6;
        }
        .sidebar-nav-item.active .nav-icon {
            color: #01a4a6;
        }
        .sidebar-nav-item.active .nav-label {
            color: #01a4a6;
        }
        .nav-label {
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }
        .sidebar.collapsed .nav-label {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }
        .sidebar.expanded .nav-label {
            opacity: 1;
        }
        /* Logo text sidebar transitions */
        .sidebar.collapsed .logo-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }
        .sidebar.expanded .logo-text {
            opacity: 1;
        }

        /* Tooltip for collapsed sidebar */
        .sidebar-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 8px;
            padding: 6px 12px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }
        .sidebar.collapsed .sidebar-nav-item:hover .sidebar-tooltip {
            opacity: 1;
        }

        /* Main content adjustment for sidebar */
        .main-content {
            transition: margin-left 0.3s ease;
        }
        .main-content.sidebar-collapsed {
            margin-left: 64px;
        }
        .main-content.sidebar-expanded {
            margin-left: 240px;
        }

        /* Links - override for sidebar */
        .sidebar a {
            color: #1f2937;
        }
        .sidebar a:hover {
            color: #111827;
        }

        /* Hide sidebar on mobile, show on desktop */
        @media (max-width: 1023px) {
            .sidebar {
                display: none !important;
            }
            .main-content {
                margin-left: 0 !important;
                padding-top: 80px !important;
            }
        }

        @media (min-width: 1024px) {
            .main-content {
                padding-top: 24px !important;
            }
        }
    </style>

    <!-- Video Background CSS -->
    <link rel="stylesheet" href="/static/css/video-background.css?v=2">
    {% block extra_head %}{% endblock %}
</head>
<body class="video-background-body text-dark-text">
    <!-- Video Background - loaded after page load to prevent infinite loading indicator -->
    <video class="admin-video-background" muted loop playsinline></video>
    <script>
        // Load video AFTER window.load (not DOMContentLoaded) to prevent browser loading indicator from spinning
        window.addEventListener('load', function() {
            const video = document.querySelector('.admin-video-background');
            if (video) {
                video.playbackRate = 0.50;
                // Set the source after page load to prevent it from blocking page load completion
                video.src = "/static/videos/sfbg-smallest.mp4";
                video.load();
                // Play with error handling (some browsers block autoplay)
                video.play().catch(function(err) {
                    console.log('Video autoplay prevented:', err.message);
                });
            }
        });
    </script>
    <!-- 95% Opacity Overlay -->
    <div class="admin-video-overlay"></div>

    <!-- Left Sidebar Navigation -->
    <aside id="sidebar" class="sidebar collapsed fixed left-0 top-0 h-full z-30 bg-white border-r border-gray-200 flex flex-col overflow-x-hidden">
        <!-- Logo Section -->
        <div class="flex items-center h-14 border-b border-gray-200 px-2">
            <a href="/admin/" class="flex items-center gap-2 overflow-hidden">
                <div class="logo-container">
                    <img src="/static/images/Logos/SF-Symbol-Medium-bg.jpg" alt="" class="logo-bg" />
                    <img src="/static/images/Logos/SF-Symbol-Medium-Gem.png" alt="Sidekick Forge" class="logo-gem" />
                </div>
                <span class="logo-text text-gray-900">Sidekick Forge</span>
            </a>
        </div>

        <!-- Toggle Button -->
        <button id="sidebar-toggle" onclick="toggleSidebar()"
                class="absolute -right-3 top-20 w-6 h-6 bg-white border border-gray-200 rounded-full flex items-center justify-center hover:bg-brand-teal/20 transition-all z-40">
            <svg id="sidebar-toggle-icon" class="w-3 h-3 text-gray-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </button>

        <!-- Navigation Items -->
        <nav class="flex-1 py-4 px-2 space-y-1 overflow-y-auto overflow-x-hidden">
            {# Subscribers get minimal navigation - only chat access and settings #}
            {% if user.role == 'subscriber' %}
            <!-- My Sidekicks (Chat Access) -->
            <a href="/admin/my-sidekicks"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/my-sidekicks' in request.url.path or '/admin/agents' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <span class="nav-label text-sm">My Sidekicks</span>
                <span class="sidebar-tooltip">Chat with Sidekicks</span>
            </a>
            {# Adventurer ADMIN users get simplified navigation #}
            {% elif user.is_adventurer_only %}
            <!-- My Sidekick -->
            <a href="/admin/agents"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/agents' in request.url.path and '/admin/wizard' not in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <span class="nav-label text-sm">My Sidekick</span>
                <span class="sidebar-tooltip">My Sidekick</span>
            </a>
            <!-- Create Sidekick Wizard -->
            {% if user.can_create_sidekick %}
            <a href="/admin/wizard"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/wizard' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/>
                </svg>
                <span class="nav-label text-sm">Create Sidekick</span>
                <span class="sidebar-tooltip">Create Sidekick</span>
            </a>
            {% else %}
            <a href="/admin/agents?upgrade=1"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg text-amber-500">
                <svg class="nav-icon w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <span class="nav-label text-sm">Create Sidekick</span>
                <span class="sidebar-tooltip">Upgrade to create more</span>
            </a>
            {% endif %}
            <!-- Users -->
            <a href="/admin/users"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/users' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span class="nav-label text-sm">Users</span>
                <span class="sidebar-tooltip">Users</span>
            </a>
            <!-- Knowledge Base -->
            <a href="/admin/knowledge-base"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/knowledge-base' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                <span class="nav-label text-sm">Knowledge Base</span>
                <span class="sidebar-tooltip">Knowledge Base</span>
            </a>
            <!-- Abilities -->
            <a href="/admin/tools"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/tools' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <span class="nav-label text-sm">Abilities</span>
                <span class="sidebar-tooltip">Abilities</span>
            </a>
            <!-- Monitoring -->
            <a href="/admin/monitoring"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/monitoring' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <span class="nav-label text-sm">Monitoring</span>
                <span class="sidebar-tooltip">Monitoring</span>
            </a>
            <!-- Settings -->
            <a href="/admin/clients/{{ user.primary_client_id }}"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/clients/' in request.url.path and user.primary_client_id in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="nav-label text-sm">Settings</span>
                <span class="sidebar-tooltip">Settings</span>
            </a>
            {% else %}
            {# Full navigation for Champion/Paragon/SuperAdmin #}
            {% if user.role == 'superadmin' %}
            <!-- Dashboard -->
            <a href="/admin/"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if request.url.path == '/admin/' %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span class="nav-label text-sm">Dashboard</span>
                <span class="sidebar-tooltip">Dashboard</span>
            </a>
            {% endif %}
            {% if user.is_super_admin %}
            <!-- Clients -->
            <a href="/admin/clients"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/clients' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                <span class="nav-label text-sm">Clients</span>
                <span class="sidebar-tooltip">Clients</span>
            </a>
            {% endif %}
            <!-- Sidekicks -->
            <a href="/admin/agents"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/agents' in request.url.path and '/admin/wizard' not in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <span class="nav-label text-sm">Sidekicks</span>
                <span class="sidebar-tooltip">Sidekicks</span>
            </a>
            <!-- Create Sidekick Wizard -->
            {% if user.can_create_sidekick %}
            <a href="/admin/wizard"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/wizard' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/>
                </svg>
                <span class="nav-label text-sm">Create Sidekick</span>
                <span class="sidebar-tooltip">Create Sidekick</span>
            </a>
            {% else %}
            <a href="/admin/agents?upgrade=1"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg text-amber-500">
                <svg class="nav-icon w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <span class="nav-label text-sm">Create Sidekick</span>
                <span class="sidebar-tooltip">Upgrade to create more</span>
            </a>
            {% endif %}
            {% if user.role in ['superadmin','admin'] %}
            <!-- Users -->
            <a href="/admin/users"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/users' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span class="nav-label text-sm">Users</span>
                <span class="sidebar-tooltip">Users</span>
            </a>
            {% endif %}
            {% if user.role in ['superadmin','admin'] %}
            <!-- Knowledge Base -->
            <a href="/admin/knowledge-base"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/knowledge-base' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                <span class="nav-label text-sm">Knowledge Base</span>
                <span class="sidebar-tooltip">Knowledge Base</span>
            </a>
            {% endif %}
            {% if user.role in ['superadmin','admin'] %}
            <!-- Abilities -->
            <a href="/admin/tools"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/tools' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <span class="nav-label text-sm">Abilities</span>
                <span class="sidebar-tooltip">Abilities</span>
            </a>
            {% endif %}
            {% if user.role in ['superadmin','admin'] %}
            <!-- Monitoring -->
            <a href="/admin/monitoring"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/monitoring' in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <span class="nav-label text-sm">Monitoring</span>
                <span class="sidebar-tooltip">Monitoring</span>
            </a>
            {% endif %}
            <!-- Settings (for non-superadmin users with primary_client_id) -->
            {% if user.role != 'superadmin' and user.primary_client_id %}
            <a href="/admin/clients/{{ user.primary_client_id }}"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/clients/' in request.url.path and user.primary_client_id|string in request.url.path %}active{% endif %}">
                <svg class="nav-icon w-5 h-5 flex-shrink-0 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="nav-label text-sm">Settings</span>
                <span class="sidebar-tooltip">Settings</span>
            </a>
            {% endif %}
            {% endif %}
        </nav>

        <!-- Bottom Section: User Profile & Logout -->
        <div class="border-t border-white/10 p-2 space-y-1">
            {% set avatar_initial = (user.first_name[:1] if user and user.first_name)
                or (user.full_name[:1] if user and user.full_name)
                or (user.email[:1] if user and user.email)
                or 'U' %}
            {% set avatar_url = user.avatar_url if user and user.avatar_url else '' %}

            <!-- User Settings -->
            <a href="/admin/user-settings"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg {% if '/admin/user-settings' in request.url.path %}active{% endif %}">
                {% if avatar_url %}
                <span class="w-5 h-5 rounded-full bg-center bg-cover flex-shrink-0 border border-brand-teal/50" style="background-image: url('{{ avatar_url }}');"></span>
                {% else %}
                <span class="w-5 h-5 rounded-full bg-gradient-to-br from-brand-teal to-brand-orange text-white text-xs font-semibold flex items-center justify-center flex-shrink-0">
                    {{ avatar_initial }}
                </span>
                {% endif %}
                <span class="nav-label text-sm" id="current-user-display">{{
                    user.first_name
                    or (user.full_name.split(' ')[0] if user and user.full_name)
                    or (user.email.split('@')[0] if user and user.email)
                    or (user.username if user and user.username)
                    or 'Admin'
                }}</span>
                <span class="sidebar-tooltip">Profile Settings</span>
            </a>

            <!-- Logout -->
            <a href="/admin/login" id="logout-btn-desktop"
               class="sidebar-nav-item relative flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-900 hover:text-red-500"
               style="cursor: pointer;">
                <svg class="nav-icon w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span class="nav-label text-sm">Logout</span>
                <span class="sidebar-tooltip">Logout</span>
            </a>
        </div>
    </aside>

    <!-- Mobile Header (shows only on small screens) -->
    <header class="lg:hidden fixed top-0 left-0 right-0 z-20 bg-white border-b border-gray-200 h-14 flex items-center px-4">
        <button type="button" onclick="toggleMobileMenu()"
                class="p-2 text-gray-600 hover:text-gray-900 rounded-lg"
                id="mobile-nav-toggle">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
        <div class="flex-1 flex items-center justify-center gap-2">
            <div class="logo-container" style="width:36px;height:36px;">
                <img src="/static/images/Logos/SF-Symbol-Medium-bg.jpg" alt="" class="logo-bg" />
                <img src="/static/images/Logos/SF-Symbol-Medium-Gem.png" alt="Sidekick Forge" class="logo-gem" />
            </div>
            <span class="text-gray-900 font-semibold text-base">Sidekick Forge</span>
        </div>
        <!-- Spacer to balance the hamburger button for true centering -->
        <div class="w-10"></div>
    </header>

    <!-- Mobile Navigation Overlay -->
    <div id="mobile-nav-overlay" class="lg:hidden hidden fixed inset-0 bg-black/50 z-40" onclick="closeMobileMenu()"></div>

    <!-- Mobile Navigation Menu -->
    <div id="mobile-nav-menu" class="lg:hidden hidden fixed left-0 top-0 bottom-0 w-64 bg-white border-r border-gray-200 z-50 transform -translate-x-full transition-transform">
        <div class="h-14 flex items-center justify-between px-4 border-b border-gray-200">
            <div class="flex items-center gap-2">
                <div class="logo-container" style="width:36px;height:36px;">
                    <img src="/static/images/Logos/SF-Symbol-Medium-bg.jpg" alt="" class="logo-bg" />
                    <img src="/static/images/Logos/SF-Symbol-Medium-Gem.png" alt="Sidekick Forge" class="logo-gem" />
                </div>
                <span class="text-gray-900 font-semibold text-base">Sidekick Forge</span>
            </div>
            <button onclick="closeMobileMenu()" class="p-2 text-gray-400 hover:text-gray-900">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <nav class="p-4 space-y-2">
            {# Mobile navigation items - same structure as sidebar #}
            {% if user.is_adventurer_only %}
            <a href="/admin/agents" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/agents' in request.url.path and '/admin/wizard' not in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                <span>My Sidekick</span>
            </a>
            {% if user.can_create_sidekick %}
            <a href="/admin/wizard" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/wizard' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/></svg>
                <span>Create Sidekick</span>
            </a>
            {% else %}
            <a href="/admin/agents?upgrade=1" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-amber-500 hover:bg-gray-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                <span>Create Sidekick</span>
            </a>
            {% endif %}
            <a href="/admin/users" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/users' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                <span>Users</span>
            </a>
            <a href="/admin/knowledge-base" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/knowledge-base' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                <span>Knowledge Base</span>
            </a>
            <a href="/admin/tools" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/tools' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                <span>Abilities</span>
            </a>
            <a href="/admin/monitoring" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/monitoring' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                <span>Monitoring</span>
            </a>
            <a href="/admin/clients/{{ user.primary_client_id }}" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/clients/' in request.url.path and user.primary_client_id in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span>Settings</span>
            </a>
            {% else %}
            {% if user.role == 'superadmin' %}
            <a href="/admin/" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if request.url.path == '/admin/' %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span>Dashboard</span>
            </a>
            {% endif %}
            {% if user.is_super_admin %}
            <a href="/admin/clients" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/clients' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                <span>Clients</span>
            </a>
            {% endif %}
            <a href="/admin/agents" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/agents' in request.url.path and '/admin/wizard' not in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                <span>Sidekicks</span>
            </a>
            {% if user.can_create_sidekick %}
            <a href="/admin/wizard" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/wizard' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/></svg>
                <span>Create Sidekick</span>
            </a>
            {% else %}
            <a href="/admin/agents?upgrade=1" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-amber-500 hover:bg-gray-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                <span>Create Sidekick</span>
            </a>
            {% endif %}
            {% if user.role in ['superadmin','admin'] %}
            <a href="/admin/users" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/users' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                <span>Users</span>
            </a>
            {% endif %}
            {% if user.role in ['superadmin','admin'] %}
            <a href="/admin/knowledge-base" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/knowledge-base' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                <span>Knowledge Base</span>
            </a>
            {% endif %}
            {% if user.role in ['superadmin','admin'] %}
            <a href="/admin/tools" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/tools' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                <span>Abilities</span>
            </a>
            {% endif %}
            {% if user.role in ['superadmin','admin'] %}
            <a href="/admin/monitoring" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/monitoring' in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                <span>Monitoring</span>
            </a>
            {% endif %}
            <!-- Settings (for non-superadmin users with primary_client_id) -->
            {% if user.role != 'superadmin' and user.primary_client_id %}
            <a href="/admin/clients/{{ user.primary_client_id }}" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50 {% if '/admin/clients/' in request.url.path and user.primary_client_id|string in request.url.path %}bg-brand-teal/10 text-brand-teal{% endif %}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span>Settings</span>
            </a>
            {% endif %}
            {% endif %}

            <div class="border-t border-gray-200 my-4"></div>

            <a href="/admin/user-settings" onclick="closeMobileMenu()" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-700 hover:bg-gray-50">
                {% if avatar_url %}
                <span class="w-5 h-5 rounded-full bg-center bg-cover border border-brand-teal/50" style="background-image: url('{{ avatar_url }}');"></span>
                {% else %}
                <span class="w-5 h-5 rounded-full bg-gradient-to-br from-brand-teal to-brand-orange text-white text-xs font-semibold flex items-center justify-center">{{ avatar_initial }}</span>
                {% endif %}
                <span id="current-user-display-mobile">{{
                    user.first_name
                    or (user.full_name.split(' ')[0] if user and user.full_name)
                    or (user.email.split('@')[0] if user and user.email)
                    or (user.username if user and user.username)
                    or 'Admin'
                }}</span>
            </a>
            <a href="/admin/login" id="logout-btn-mobile" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-900 hover:text-red-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                <span>Logout</span>
            </a>
        </nav>
    </div>

    <!-- Global Loading Overlay - Disabled -->
    <div id="globalLoading" class="hidden" style="display:none !important"></div>
    <div id="global-indicator" style="display:none;"></div>

    <!-- Main Content -->
    <main id="main-content" class="main-content sidebar-collapsed relative z-10 py-6 px-4 sm:px-6 lg:px-8 lg:pt-6 pt-20">
        <div class="max-w-7xl mx-auto">
            {% block content %}{% endblock %}
        </div>
    </main>

    {% if not disable_stats_poll %}
    <!-- Global Auto-refresh Stats (every 30 seconds) -->
    <div hx-get="/admin/partials/stats" 
         hx-trigger="every 30s" 
         hx-target="#stats-container"
         hx-swap="innerHTML">
    </div>
    <!-- Hidden container to satisfy HTMX target on pages that don't render stats -->
    <div id="stats-container" class="hidden"></div>
    {% endif %}

    <!-- HTMX Configuration -->
    <script>
        // Configure HTMX
        htmx.config.globalViewTransitions = true;
        htmx.config.timeout = 10000; // 10 second timeout

        // Attach Supabase admin token to all HTMX requests
        document.addEventListener('htmx:configRequest', function (event) {
            try {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    event.detail.headers['Authorization'] = `Bearer ${token}`;
                }
            } catch (e) {
                console.warn('Could not attach Authorization header:', e);
            }
        });
        
        // Loading states disabled - removed to fix infinite loading issue
        document.addEventListener('htmx:afterRequest', async function(event) {
            // Handle errors
            if (event.detail.xhr && event.detail.xhr.status >= 400) {
                console.error('HTMX request failed:', event.detail.xhr.status);

                // On 401/403, try to refresh token and retry, or redirect to login
                if (event.detail.xhr.status === 401 || event.detail.xhr.status === 403) {
                    // Try to refresh the token
                    if (window.refreshAdminToken) {
                        const newToken = await window.refreshAdminToken();
                        if (newToken) {
                            console.log('[auth] Token refreshed after 401, please retry');
                            // Token was refreshed, next request should work
                            return;
                        }
                    }
                    // Token refresh failed - redirect to login
                    console.log('[auth] Token refresh failed, redirecting to login');
                    window.location.href = '/admin/login?redirect=session_expired';
                }
            }
        });

        // Loading functions disabled - removed to fix infinite loading issue
        window.showGlobalLoading = function(path) {
            // Disabled
        }
        window.hideGlobalLoading = function() {
            // Disabled
        };

        // Helper to create cookie with conditional Secure flag
        // Some staging setups terminate SSL at proxy, so Secure flag breaks cookies
        function setAdminCookie(token, maxAge = 28800) {
            const securePart = window.location.protocol === 'https:' ? '; Secure' : '';
            document.cookie = `admin_token=${token}; path=/; max-age=${maxAge}${securePart}; SameSite=Lax`;
        }

        // Initialize Supabase client for logout
        // Use window._adminSupabase to avoid conflicts with Supabase SDK's global export
        ;(function() {
            const supabaseUrl = '{{ supabase_url }}';
            const supabaseKey = '{{ supabase_anon_key }}';
            try {
                if (window.supabase && supabaseUrl && supabaseKey) {
                    window._adminSupabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    // Expose the admin Supabase client for child iframes (embed preview) to read session
                    window.__adminSupabaseClient = window._adminSupabase;
                } else {
                    console.warn('[auth] Supabase client not initialized - missing URL or key');
                }
            } catch (e) {
                console.error('[auth] Failed to create Supabase client:', e);
            }
        })();

        // Token refresh helper - gets fresh token from Supabase and updates storage
        async function refreshAdminToken() {
            if (!window._adminSupabase || !window._adminSupabase.auth) {
                console.log('[auth] Supabase client not ready for token refresh');
                return null;
            }
            try {
                // Use refreshSession() to force a token refresh from Supabase servers
                // This ensures we get a new token signed with current keys (handles key rotation)
                const { data: { session }, error } = await window._adminSupabase.auth.refreshSession();
                if (error) {
                    // Refresh failed - try getSession as fallback
                    console.warn('[auth] Session refresh error, trying getSession:', error.message);
                    const fallback = await window._adminSupabase.auth.getSession();
                    if (fallback.data?.session) {
                        const token = fallback.data.session.access_token;
                        localStorage.setItem('admin_token', token);
                        setAdminCookie(token, 28800);
                        return token;
                    }
                    return null;
                }
                if (!session) {
                    // No session in Supabase - this is a real logout, check if we have an existing token
                    const existingToken = document.cookie.split('; ').find(row => row.startsWith('admin_token='));
                    if (existingToken && existingToken.split('=')[1]) {
                        // User has a token but Supabase doesn't have a session
                        // This can happen if the session expired - don't clear yet, let backend verify
                        console.log('[auth] No Supabase session but token exists - letting backend verify');
                        return null;
                    }
                    console.log('[auth] No valid session and no existing token');
                    return null;
                }
                // Update stored token with fresh one from Supabase
                const token = session.access_token;
                localStorage.setItem('admin_token', token);
                setAdminCookie(token, 28800);  // 8 hours - must match login cookie expiry
                console.log('[auth] Token refreshed successfully');
                return token;
            } catch (e) {
                console.error('[auth] Token refresh failed (keeping existing tokens):', e);
                return null;
            }
        }

        // Expose globally for use in other templates
        window.refreshAdminToken = refreshAdminToken;

        // Auto-refresh token every 5 minutes to prevent expiration
        setInterval(async () => {
            const token = await refreshAdminToken();
            if (token) {
                console.log('[auth] Token auto-refreshed');
            }
        }, 5 * 60 * 1000);

        // Refresh token when user returns to tab (handles long idle periods)
        let lastVisibilityChange = Date.now();
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                const timeSinceLastChange = Date.now() - lastVisibilityChange;
                // If tab was hidden for more than 1 minute, refresh the token
                if (timeSinceLastChange > 60 * 1000) {
                    console.log('[auth] Tab became visible after', Math.round(timeSinceLastChange / 1000), 'seconds - refreshing token');
                    const token = await refreshAdminToken();
                    if (token) {
                        console.log('[auth] Token refreshed on tab visibility');
                    }
                }
            }
            lastVisibilityChange = Date.now();
        });

        // Refresh token once on page load to ensure we have fresh tokens
        // This helps recover from stale tokens after key rotation
        setTimeout(async () => {
            console.log('[auth] Initial token refresh on page load');
            const token = await refreshAdminToken();
            if (token) {
                console.log('[auth] Initial token refresh successful');
            }
        }, 1000);  // Small delay to ensure Supabase client is ready

        // Logout function - clears auth state before navigation
        function doLogout(e) {
            // Prevent default link behavior - we'll redirect after cleanup
            if (e) e.preventDefault();

            console.log('[logout] Starting logout...');

            // Clear admin token cookie immediately
            document.cookie = 'admin_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            document.cookie = 'admin_token=; path=/admin; expires=Thu, 01 Jan 1970 00:00:00 GMT';

            // Clear local storage
            try {
                localStorage.removeItem('admin_token');
            } catch (e) {
                console.warn('[logout] localStorage clear failed:', e);
            }

            // Sign out from Supabase (non-blocking)
            try {
                if (window._adminSupabase && window._adminSupabase.auth) {
                    window._adminSupabase.auth.signOut().catch(function(err) {
                        console.warn('[logout] Supabase signOut error (non-fatal):', err);
                    });
                }
            } catch (error) {
                console.warn('[logout] Supabase signOut failed (non-fatal):', error);
            }

            console.log('[logout] Redirecting to login...');
            // Redirect to login page
            window.location.href = '/admin/login';
        }

        // Attach logout handlers to both buttons
        document.addEventListener('DOMContentLoaded', function() {
            var desktopBtn = document.getElementById('logout-btn-desktop');
            var mobileBtn = document.getElementById('logout-btn-mobile');
            if (desktopBtn) desktopBtn.addEventListener('click', doLogout);
            if (mobileBtn) mobileBtn.addEventListener('click', doLogout);
        });

        // Also assign to window for any explicit calls
        window.logout = doLogout;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Skip auth check on login and reset-password pages
            const currentPath = window.location.pathname;
            if (currentPath.includes('/admin/login') || currentPath.includes('/admin/reset-password')) {
                return;
            }

            // IMPORTANT: If this page rendered, server-side auth already succeeded.
            // Skip aggressive client-side auth checks that cause redirect loops.
            // The server will handle 401s if the token expires.
            console.log('[auth] Page rendered by server - skipping client-side auth redirect checks');
            return;

            // Check if in development mode - check for DEVELOPMENT_MODE cookie or specific hosts
            const devModeCookie = document.cookie.split('; ').find(row => row.startsWith('DEVELOPMENT_MODE='));
            const isDevelopment = (devModeCookie && devModeCookie.split('=')[1] === 'true') ||
                                window.location.hostname === 'localhost' ||
                                window.location.hostname === '127.0.0.1' ||
                                window.location.hostname.includes('.local');

            // Check for admin token in cookies first
            const adminToken = document.cookie.split('; ').find(row => row.startsWith('admin_token='));
            const hasAdminToken = adminToken && adminToken.split('=')[1] && adminToken.split('=')[1] !== '';

            // Debug cookie state
            console.log('[auth] document.cookie length:', document.cookie.length);
            console.log('[auth] adminToken found:', !!adminToken);
            console.log('[auth] hasAdminToken:', hasAdminToken);

            // In development mode with a token (including dev-token), skip Supabase check
            if (isDevelopment && hasAdminToken) {
                const displayName = 'Dev';
                const userDisplay = document.getElementById('current-user-display');
                if (userDisplay) {
                    userDisplay.textContent = displayName;
                }
                const userDisplayMobile = document.getElementById('current-user-display-mobile');
                if (userDisplayMobile) {
                    userDisplayMobile.textContent = displayName;
                }
                return;
            }

            // Always refresh token on page load to ensure it's current
            const freshToken = await refreshAdminToken();

            // If we have an admin_token cookie, trust the server-side auth
            // The server already verified the token before rendering this page
            if (hasAdminToken) {
                console.log('[auth] Cookie exists, trusting server-side auth');
                // Try to refresh from Supabase but don't redirect if it fails
                if (!freshToken && window._adminSupabase && window._adminSupabase.auth) {
                    try {
                        const { data: { session } } = await window._adminSupabase.auth.getSession();
                        if (session && session.access_token) {
                            // Update cookie with fresh token
                            setAdminCookie(session.access_token);
                            localStorage.setItem('admin_token', session.access_token);
                        }
                    } catch (e) {
                        console.warn('[auth] Token refresh failed, continuing with existing cookie');
                    }
                }
            } else if (!freshToken) {
                // No cookie and no fresh token - check if Supabase has a session we can use
                if (window._adminSupabase && window._adminSupabase.auth) {
                    try {
                        const { data: { session } } = await window._adminSupabase.auth.getSession();
                        if (!session) {
                            // No token and no session - redirect to login
                            console.log('No authentication found, redirecting to login');
                            window.location.href = '/admin/login?redirect=auth_required';
                            return;
                        } else if (session.access_token) {
                            // Has session but no cookie - set it and reload
                            setAdminCookie(session.access_token);
                            localStorage.setItem('admin_token', session.access_token);
                            window.location.reload();
                            return;
                        }
                    } catch (sessionErr) {
                        console.warn('[auth] Session check failed:', sessionErr);
                        // Don't redirect on error - let backend handle auth
                    }
                }
            }

            // Update user display if we have a session
            if (!window._adminSupabase || !window._adminSupabase.auth) {
                console.warn('[auth] Supabase client not available for display update');
                return;
            }

            let session = null;
            try {
                const result = await window._adminSupabase.auth.getSession();
                session = result.data?.session;
            } catch (displayErr) {
                console.warn('[auth] Failed to get session for display:', displayErr);
                return;
            }
            if (session && session.user) {
                const metadata = session.user.user_metadata || {};
                const fullName = metadata.full_name || metadata.name || metadata.display_name;
                let displayName = metadata.first_name;
                if (!displayName && typeof fullName === 'string' && fullName.trim()) {
                    displayName = fullName.trim().split(/\s+/)[0];
                }
                if (!displayName && typeof metadata.nickname === 'string' && metadata.nickname.trim()) {
                    displayName = metadata.nickname.trim();
                }
                if (!displayName && session.user.email) {
                    displayName = session.user.email.split('@')[0];
                }
                if (!displayName && metadata.username) {
                    displayName = metadata.username;
                }
                if (!displayName) {
                    displayName = 'Admin';
                }

                const userDisplay = document.getElementById('current-user-display');
                if (userDisplay) {
                    userDisplay.textContent = displayName;
                }
                const userDisplayMobile = document.getElementById('current-user-display-mobile');
                if (userDisplayMobile) {
                    userDisplayMobile.textContent = displayName;
                }
            }
            
            // Update timestamp every second
            function updateTimestamp() {
                const timestampElements = document.querySelectorAll('.timestamp');
                timestampElements.forEach(element => {
                    const timestamp = element.getAttribute('data-timestamp');
                    if (timestamp) {
                        const date = new Date(timestamp);
                        element.textContent = date.toLocaleString();
                    }
                });
            }
            
            setInterval(updateTimestamp, 1000);
            updateTimestamp();
        });

        // Sidebar toggle function
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const toggleIcon = document.getElementById('sidebar-toggle-icon');

            if (!sidebar || !mainContent) return;

            const isPinned = sidebar.classList.contains('pinned');

            if (isPinned) {
                // Unpin: go back to collapsed state with hover expansion
                sidebar.classList.remove('pinned');
                sidebar.classList.remove('expanded');
                sidebar.classList.add('collapsed');
                mainContent.classList.remove('sidebar-expanded');
                mainContent.classList.add('sidebar-collapsed');
                if (toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';
                localStorage.setItem('sidebar_pinned', 'false');
            } else {
                // Pin: keep expanded permanently
                sidebar.classList.add('pinned');
                sidebar.classList.remove('collapsed');
                sidebar.classList.add('expanded');
                mainContent.classList.remove('sidebar-collapsed');
                mainContent.classList.add('sidebar-expanded');
                if (toggleIcon) toggleIcon.style.transform = 'rotate(180deg)';
                localStorage.setItem('sidebar_pinned', 'true');
            }
        };

        // Restore sidebar state on page load
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const toggleIcon = document.getElementById('sidebar-toggle-icon');

            // Only show sidebar on desktop
            if (window.innerWidth >= 1024 && sidebar) {
                sidebar.classList.remove('hidden');

                // Check saved pinned state
                const savedPinned = localStorage.getItem('sidebar_pinned');
                if (savedPinned === 'true') {
                    sidebar.classList.add('pinned');
                    sidebar.classList.remove('collapsed');
                    sidebar.classList.add('expanded');
                    if (mainContent) {
                        mainContent.classList.remove('sidebar-collapsed');
                        mainContent.classList.add('sidebar-expanded');
                    }
                    if (toggleIcon) toggleIcon.style.transform = 'rotate(180deg)';
                }
            }
        });

        // Mobile menu functions
        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobile-nav-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const toggle = document.getElementById('mobile-nav-toggle');

            if (!menu) return;

            const isOpen = !menu.classList.contains('hidden');

            if (isOpen) {
                menu.classList.add('hidden');
                menu.style.transform = 'translateX(-100%)';
                if (overlay) overlay.classList.add('hidden');
                if (toggle) toggle.setAttribute('aria-expanded', 'false');
            } else {
                menu.classList.remove('hidden');
                menu.style.transform = 'translateX(0)';
                if (overlay) overlay.classList.remove('hidden');
                if (toggle) toggle.setAttribute('aria-expanded', 'true');
            }
        };

        window.closeMobileMenu = function() {
            const menu = document.getElementById('mobile-nav-menu');
            const overlay = document.getElementById('mobile-nav-overlay');
            const toggle = document.getElementById('mobile-nav-toggle');

            if (menu && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
                menu.style.transform = 'translateX(-100%)';
                if (overlay) overlay.classList.add('hidden');
                if (toggle) toggle.setAttribute('aria-expanded', 'false');
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1024) {
                    closeMobileMenu();
                }
            });
        });
        
        // Reusable button loading helpers
        window.setButtonLoading = function(btn, isLoading) {
            try {
                if (!btn) return;
                if (isLoading) {
                    btn.classList.add('loading');
                    try { btn.disabled = true; } catch (e) {}
                } else {
                    btn.classList.remove('loading');
                    try { btn.disabled = false; } catch (e) {}
                }
            } catch (e) { console.warn('setButtonLoading error', e); }
        }
        
        window.withButtonLoading = async function(btn, fn) {
            if (!fn || typeof fn !== 'function') return;
            try { window.setButtonLoading(btn, true); } catch {}
            try { return await fn(); }
            finally { try { window.setButtonLoading(btn, false); } catch {} }
        }
    </script>

    <!-- Load LiveKit Client SDK globally for HTMX modal use -->
    <script src="/static/livekit-client.min.js" onload="console.log(' LiveKit SDK loaded successfully'); window.livekitSDKLoaded = true; window.LiveKitSDK = window.LivekitClient || window.LiveKit || window.livekit;" onerror="console.error(' LiveKit SDK failed to load'); window.livekitSDKLoaded = false;"></script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
