{% extends "admin/base.html" %}

{% block title %}Users · Sidekick Forge Admin{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-semibold text-white">Users</h1>
  <div class="flex items-center gap-3">
    <button onclick="openAddUserModal()" class="btn-primary px-3 py-2 rounded text-sm">Add User</button>
    <a href="/admin/" class="text-sm text-gray-400 hover:text-brand-teal">Back to Dashboard</a>
  </div>
</div>

<!-- Search and Stats Bar -->
<div class="bg-dark-surface border border-dark-border rounded-lg p-4 mb-4">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <form method="GET" action="/admin/users" class="flex items-center gap-2 flex-1 max-w-md">
      <div class="relative flex-1">
        <input type="text" name="search" value="{{ search }}" placeholder="Search by email..."
               class="w-full pl-10 pr-4 py-2 bg-dark-elevated border border-dark-border rounded-md text-dark-text focus:outline-none focus:ring-2 focus:ring-brand-teal focus:border-transparent">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
      </div>
      <button type="submit" class="btn-primary px-4 py-2 rounded text-sm">Search</button>
      {% if search %}
      <a href="/admin/users" class="px-3 py-2 text-sm text-gray-400 hover:text-white border border-dark-border rounded">Clear</a>
      {% endif %}
    </form>
    <div class="text-sm text-gray-400">
      {% if search %}
      Found <span class="text-white font-medium">{{ total_users }}</span> user{% if total_users != 1 %}s{% endif %} matching "{{ search }}"
      {% else %}
      <span class="text-white font-medium">{{ total_users }}</span> total user{% if total_users != 1 %}s{% endif %}
      {% endif %}
    </div>
  </div>
</div>

<div class="bg-dark-surface border border-dark-border rounded-lg p-4">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-dark-border">
      <thead>
        <tr class="text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
          <th class="px-4 py-3">Email</th>
          <th class="px-4 py-3">User ID</th>
          <th class="px-4 py-3">Created</th>
          <th class="px-4 py-3">Roles</th>
          <th class="px-4 py-3">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-dark-border">
        {% for u in users %}
        <tr>
          <td class="px-4 py-3 text-sm">{{ u.email }}</td>
          <td class="px-4 py-3 text-xs text-gray-400">{{ u.id }}</td>
          <td class="px-4 py-3 text-xs text-gray-400 timestamp" data-timestamp="{{ u.created_at }}">{{ u.created_at }}</td>
          <td class="px-4 py-3 text-xs">
            {% if u.roles and u.roles|length > 0 %}
              <div class="flex flex-wrap gap-1">
                {% for r in u.roles %}
                  <span class="px-2 py-0.5 rounded bg-dark-elevated border border-dark-border text-gray-300">{{ r }}</span>
                {% endfor %}
              </div>
            {% else %}
              <span class="text-gray-500">none</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-xs">
            <button class="px-2 py-1 rounded border border-dark-border hover:border-brand-teal" onclick="openEditUserModal({{ u.id|tojson }}, {{ u.email|tojson }})">Edit</button>
            <button class="ml-2 px-2 py-1 rounded border border-dark-border hover:border-brand-teal js-set-password" data-user-id="{{ u.id }}" data-email="{{ u.email }}">Set Password</button>
            {% if u.id != user.user_id %}
            <button class="ml-2 px-2 py-1 rounded border border-red-800 text-red-400 hover:border-red-500 hover:text-red-300 js-delete-user" data-user-id="{{ u.id }}" data-email="{{ u.email }}">Delete</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if total_pages > 1 %}
  <div class="mt-4 pt-4 border-t border-dark-border flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div class="text-sm text-gray-400">
      Showing {{ (page - 1) * per_page + 1 }} - {{ [(page * per_page), total_users] | min }} of {{ total_users }} users
    </div>
    <div class="flex items-center gap-2">
      {% if page > 1 %}
      <a href="/admin/users?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}"
         class="px-3 py-1.5 text-sm border border-dark-border rounded hover:border-brand-teal text-gray-300 hover:text-white transition-colors">
        Previous
      </a>
      {% else %}
      <span class="px-3 py-1.5 text-sm border border-dark-border rounded text-gray-600 cursor-not-allowed">Previous</span>
      {% endif %}

      <div class="flex items-center gap-1">
        {% for p in range(1, total_pages + 1) %}
          {% if p == page %}
          <span class="px-3 py-1.5 text-sm bg-brand-teal text-white rounded font-medium">{{ p }}</span>
          {% elif p == 1 or p == total_pages or (p >= page - 1 and p <= page + 1) %}
          <a href="/admin/users?page={{ p }}{% if search %}&search={{ search }}{% endif %}"
             class="px-3 py-1.5 text-sm border border-dark-border rounded hover:border-brand-teal text-gray-300 hover:text-white transition-colors">
            {{ p }}
          </a>
          {% elif p == page - 2 or p == page + 2 %}
          <span class="px-1 text-gray-500">...</span>
          {% endif %}
        {% endfor %}
      </div>

      {% if page < total_pages %}
      <a href="/admin/users?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}"
         class="px-3 py-1.5 text-sm border border-dark-border rounded hover:border-brand-teal text-gray-300 hover:text-white transition-colors">
        Next
      </a>
      {% else %}
      <span class="px-3 py-1.5 text-sm border border-dark-border rounded text-gray-600 cursor-not-allowed">Next</span>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
  <div class="bg-dark-surface border border-dark-border rounded-lg p-6 w-full max-w-md">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-white">Add User</h2>
      <button onclick="closeAddUserModal()" class="text-gray-400 hover:text-white">✕</button>
    </div>
    <div class="space-y-4">
      <div>
        <label class="block text-sm text-gray-300 mb-1">Name</label>
        <input type="text" id="newUserName" class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated" placeholder="Full name" required />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">Email</label>
        <input type="email" id="newUserEmail" class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated" placeholder="user@example.com" required />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">Role</label>
        <select id="newUserRole" class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated" onchange="toggleClientPicker()">
          <option value="admin" selected>Admin (per client)</option>
          <option value="subscriber">Subscriber (per client)</option>
        </select>
      </div>
      {% if not user.is_adventurer_only %}
      <div id="clientPicker" class="hidden">
        <label class="block text-sm text-gray-300 mb-1">Client(s)</label>
        <select id="newUserClientIds" multiple class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated min-h-[120px]">
          {% for c in clients %}
          <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
        <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple projects.</p>
      </div>
      {% endif %}
      <div class="flex items-center justify-end gap-2 mt-2">
        <button onclick="closeAddUserModal()" class="px-3 py-2 text-sm text-gray-300 hover:text-white">Cancel</button>
        <button onclick="addUser()" class="btn-primary px-3 py-2 rounded text-sm">Create</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
  <div class="bg-dark-surface border border-dark-border rounded-lg p-6 w-full max-w-md">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-white">Edit User</h2>
      <button onclick="closeEditUserModal()" class="text-gray-400 hover:text-white">✕</button>
    </div>
    <div class="space-y-4">
      <input type="hidden" id="editUserId" />
      <div>
        <label class="block text-sm text-gray-300 mb-1">Email</label>
        <input type="text" id="editUserEmail" disabled class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated" />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">Role</label>
        <select id="editUserRole" class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated" onchange="toggleEditClientPicker()">
          <option value="admin">Admin (per client)</option>
          <option value="subscriber">Subscriber (per client)</option>
        </select>
      </div>
      <div id="editClientPicker" class="hidden">
        <label class="block text-sm text-gray-300 mb-1">Client(s)</label>
        <select id="editUserClientIds" multiple class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated min-h-[120px]">
          {% for c in clients %}
          <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
        <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple projects.</p>
      </div>
      <div class="flex items-center justify-end gap-2 mt-2">
        <button onclick="closeEditUserModal()" class="px-3 py-2 text-sm text-gray-300 hover:text-white">Cancel</button>
        <button onclick="saveUserEdits()" class="btn-primary px-3 py-2 rounded text-sm">Save</button>
      </div>
    </div>
  </div>
  </div>

<!-- Set Password Modal -->
<div id="setPasswordModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
  <div class="bg-dark-surface border border-dark-border rounded-lg p-6 w-full max-w-md">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-white">Set Password</h2>
      <button onclick="closeSetPasswordModal()" class="text-gray-400 hover:text-white">✕</button>
    </div>
    <div class="space-y-4">
      <input type="hidden" id="setPasswordUserId" />
      <div>
        <label class="block text-sm text-gray-300 mb-1">User</label>
        <input type="text" id="setPasswordEmail" disabled class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated text-gray-400" />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-1">New Password</label>
        <input type="password" id="setPasswordInput" class="w-full px-3 py-2 rounded border border-dark-border bg-dark-elevated text-white" placeholder="Minimum 8 characters" />
      </div>
      <div id="setPasswordError" class="hidden text-red-400 text-sm"></div>
      <div class="flex items-center justify-end gap-2 mt-2">
        <button onclick="closeSetPasswordModal()" class="px-3 py-2 text-sm text-gray-300 hover:text-white">Cancel</button>
        <button onclick="submitSetPassword()" id="setPasswordSubmitBtn" class="btn-primary px-3 py-2 rounded text-sm">Set Password</button>
      </div>
    </div>
  </div>
</div>

<script>
function openAddUserModal(){
  const m=document.getElementById('addUserModal');
  if(m){
    m.classList.remove('hidden');
    // Ensure correct visibility based on current role selection
    toggleClientPicker();
  }
}
function closeAddUserModal(){
  const m=document.getElementById('addUserModal'); if(m) m.classList.add('hidden');
}
const IS_ADVENTURER = {{ 'true' if user.is_adventurer_only else 'false' }};
function toggleClientPicker(){
  const picker = document.getElementById('clientPicker');
  if(!picker || IS_ADVENTURER) return;
  const role = document.getElementById('newUserRole').value;
  if(role === 'admin' || role === 'subscriber'){ picker.classList.remove('hidden'); }
  else { picker.classList.add('hidden'); }
}
async function addUser(){
  const email=document.getElementById('newUserEmail').value.trim();
  const full_name=document.getElementById('newUserName').value.trim();
  const role=document.getElementById('newUserRole').value;
  const clientIdsEl=document.getElementById('newUserClientIds');
  const selectedClientIds = !IS_ADVENTURER && (role === 'admin' || role === 'subscriber') && clientIdsEl ? Array.from(clientIdsEl.selectedOptions).map(o => o.value) : [];
  if(!full_name){ alert('Please enter a name'); return; }
  if(!email){ alert('Please enter an email'); return; }
  if(!IS_ADVENTURER && (role === 'admin' || role === 'subscriber') && selectedClientIds.length === 0){ alert('Please select at least one client'); return; }
  try {
    if (window.showGlobalLoading) window.showGlobalLoading('/admin/users/create');
    const res = await fetch('/admin/users/create',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ full_name, email, role_key: role, client_ids: selectedClientIds })
    });
    if(!res.ok){
      const txt = await res.text();
      console.error('Create user failed', res.status, txt);
      alert('Failed to create user');
      return;
    }
    closeAddUserModal();
    window.location.reload();
  } catch (e){
    console.error(e);
    alert('Error creating user');
  } finally {
    if (window.hideGlobalLoading) window.hideGlobalLoading();
  }
}

function openEditUserModal(userId, email){
  const m=document.getElementById('editUserModal');
  if(!m) return;
  document.getElementById('editUserId').value = userId;
  document.getElementById('editUserEmail').value = email;
  // Prefill assignments
  fetch(`/admin/users/${userId}/assignments`).then(async r => {
    if(!r.ok){ throw new Error(await r.text()); }
    return r.json();
  }).then(data => {
    const roleSel = document.getElementById('editUserRole');
    const clientSel = document.getElementById('editUserClientIds');
    roleSel.value = data.role_key || 'subscriber';
    // Clear selections
    for (const opt of clientSel.options) { opt.selected = false; }
    (data.client_ids || []).forEach(id => {
      const opt = Array.from(clientSel.options).find(o => o.value === id);
      if (opt) opt.selected = true;
    });
    toggleEditClientPicker();
    m.classList.remove('hidden');
  }).catch(err => {
    console.error('Failed to load assignments', err);
    alert('Failed to load user');
  });
}
function closeEditUserModal(){
  const m=document.getElementById('editUserModal'); if(m) m.classList.add('hidden');
}
function toggleEditClientPicker(){
  const role = document.getElementById('editUserRole').value;
  const picker = document.getElementById('editClientPicker');
  if(role === 'admin' || role === 'subscriber'){ picker.classList.remove('hidden'); }
  else { picker.classList.add('hidden'); }
}
async function saveUserEdits(){
  const user_id = document.getElementById('editUserId').value;
  const role_key = document.getElementById('editUserRole').value;
  const clientSel = document.getElementById('editUserClientIds');
  const client_ids = (role_key === 'admin' || role_key === 'subscriber') ? Array.from(clientSel.selectedOptions).map(o => o.value) : [];
  if ((role_key === 'admin' || role_key === 'subscriber') && client_ids.length === 0) {
    alert('Please select at least one client for this role.');
    return;
  }
  try {
    const res = await fetch('/admin/users/update', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id, role_key, client_ids })
    });
    if(!res.ok){
      const txt = await res.text();
      console.error('Update user failed', res.status, txt);
      alert('Failed to update user');
      return;
    }
    closeEditUserModal();
    window.location.reload();
  } catch(e){
    console.error(e);
    alert('Error updating user');
  }
}

// Password update UI (modal-based)
function openSetPasswordModal(userId, email) {
  console.log('[SetPassword] openSetPasswordModal called with:', userId, email);
  try {
    const userIdEl = document.getElementById('setPasswordUserId');
    const emailEl = document.getElementById('setPasswordEmail');
    const inputEl = document.getElementById('setPasswordInput');
    const errorEl = document.getElementById('setPasswordError');
    const modalEl = document.getElementById('setPasswordModal');

    console.log('[SetPassword] Elements found:', {
      userIdEl: !!userIdEl,
      emailEl: !!emailEl,
      inputEl: !!inputEl,
      errorEl: !!errorEl,
      modalEl: !!modalEl
    });

    if (!modalEl) {
      console.error('[SetPassword] Modal element not found!');
      alert('Error: Set Password modal not found in page');
      return;
    }

    userIdEl.value = userId;
    emailEl.value = email;
    inputEl.value = '';
    errorEl.classList.add('hidden');
    modalEl.classList.remove('hidden');
    console.log('[SetPassword] Modal should now be visible');
    // Focus the password input
    setTimeout(() => inputEl.focus(), 100);
  } catch (err) {
    console.error('[SetPassword] Error:', err);
    alert('Error opening Set Password modal: ' + err.message);
  }
}

// Keyboard support for Set Password modal
document.addEventListener('keydown', function(e) {
  const modal = document.getElementById('setPasswordModal');
  if (modal && !modal.classList.contains('hidden')) {
    if (e.key === 'Escape') {
      closeSetPasswordModal();
    } else if (e.key === 'Enter' && e.target.id === 'setPasswordInput') {
      e.preventDefault();
      submitSetPassword();
    }
  }
});

function closeSetPasswordModal() {
  document.getElementById('setPasswordModal').classList.add('hidden');
  document.getElementById('setPasswordInput').value = '';
  document.getElementById('setPasswordError').classList.add('hidden');
}

async function submitSetPassword() {
  const user_id = document.getElementById('setPasswordUserId').value;
  const email = document.getElementById('setPasswordEmail').value;
  const pwd = document.getElementById('setPasswordInput').value;
  const errorEl = document.getElementById('setPasswordError');
  const submitBtn = document.getElementById('setPasswordSubmitBtn');

  // Validate
  if (!pwd) {
    errorEl.textContent = 'Please enter a password';
    errorEl.classList.remove('hidden');
    return;
  }
  if (pwd.length < 8) {
    errorEl.textContent = 'Password must be at least 8 characters';
    errorEl.classList.remove('hidden');
    return;
  }

  // Disable button during submit
  submitBtn.disabled = true;
  submitBtn.textContent = 'Setting...';
  errorEl.classList.add('hidden');

  try {
    const res = await fetch('/admin/users/set-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id, email, password: pwd })
    });
    if (!res.ok) {
      const txt = await res.text();
      console.error('Set password failed', res.status, txt);
      errorEl.textContent = txt || 'Failed to set password';
      errorEl.classList.remove('hidden');
      return;
    }
    // Success - close modal and show confirmation
    closeSetPasswordModal();
    alert('Password updated successfully');
  } catch (e) {
    console.error(e);
    errorEl.textContent = 'Error updating password';
    errorEl.classList.remove('hidden');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Set Password';
  }
}

// Attach delete handlers via event delegation
document.addEventListener('click', async function(e) {
  const btn = e.target.closest('.js-delete-user');
  if (!btn) return;
  const userId = btn.getAttribute('data-user-id');
  const email = btn.getAttribute('data-email');
  if (!confirm('Are you sure you want to delete ' + email + '? This cannot be undone.')) return;
  try {
    if (window.showGlobalLoading) window.showGlobalLoading('/admin/users/delete');
    const res = await fetch('/admin/users/delete', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId })
    });
    if (!res.ok) {
      const txt = await res.text();
      console.error('Delete user failed', res.status, txt);
      alert('Failed to delete user');
      return;
    }
    window.location.reload();
  } catch (err) {
    console.error(err);
    alert('Error deleting user');
  } finally {
    if (window.hideGlobalLoading) window.hideGlobalLoading();
  }
});

// Verify functions are defined (debugging)
console.log('[Users page] Script loaded. Functions defined:', {
  openSetPasswordModal: typeof openSetPasswordModal,
  closeSetPasswordModal: typeof closeSetPasswordModal,
  submitSetPassword: typeof submitSetPassword
});

// Set Password button handler via event delegation (more robust than inline onclick)
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.js-set-password');
  if (!btn) return;
  console.log('[SetPassword] Button clicked via delegation');
  const userId = btn.getAttribute('data-user-id');
  const email = btn.getAttribute('data-email');
  console.log('[SetPassword] data:', userId, email);
  openSetPasswordModal(userId, email);
});
</script>
{% endblock %}


