{% extends "admin/base.html" %}

{% block title %}Clients Management - Autonomite Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Success/Error Messages -->
    {% if request.query_params.get('message') %}
    <div class="mb-6 rounded-md bg-green-50 p-4 border border-green-200">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-green-800">{{ request.query_params.get('message').replace('+', ' ') }}</p>
            </div>
            <div class="ml-auto pl-3">
                <button type="button" onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex rounded-md p-1.5 text-green-500 hover:bg-green-100">
                    <span class="sr-only">Dismiss</span>
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if request.query_params.get('error') %}
    <div class="mb-6 rounded-md bg-red-50 p-4 border border-red-200">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-red-800">{{ request.query_params.get('error').replace('+', ' ') }}</p>
            </div>
            <div class="ml-auto pl-3">
                <button type="button" onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex rounded-md p-1.5 text-red-500 hover:bg-red-100">
                    <span class="sr-only">Dismiss</span>
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-dark-text">Client Management</h1>
                <p class="text-dark-text-secondary">Manage client configurations and API keys</p>
            </div>
            <button class="btn-primary px-4 py-2 rounded text-sm font-medium transition-all"
                    onclick="showAddClientModal()">
                Add Client
            </button>
        </div>
    </div>

    <!-- Clients Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for client in clients %}
        <div class="client-card bg-dark-surface rounded-lg border border-dark-border p-6" data-client-id="{{ client.id }}">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-medium text-dark-text">{{ client.name }}</h3>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if client.active %}bg-brand-teal/20 text-brand-teal{% else %}bg-dark-elevated text-dark-text-secondary{% endif %}">
                    {% if client.active %}Active{% else %}Inactive{% endif %}
                </span>
            </div>
            
            <div class="text-sm text-dark-text-secondary space-y-2">
                <p><strong class="text-dark-text">ID:</strong> {{ client.id }}</p>
                {% if client.slug %}
                <p><strong class="text-dark-text">Slug:</strong> {{ client.slug }}</p>
                {% endif %}
                {% if client.domain %}
                <p><strong class="text-dark-text">Domain:</strong> {{ client.domain }}</p>
                {% endif %}
                {% if client.description %}
                <p class="mt-2 text-dark-text-secondary">{{ client.description }}</p>
                {% endif %}
            </div>

            <div class="mt-4 pt-4 border-t border-dark-border space-y-2">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-medium text-dark-text-secondary uppercase tracking-wide">Provisioning</span>
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-semibold"
                          data-role="provisioning-badge"
                          data-status="{{ client.provisioning_status | default('unknown') }}">
                        {{ client.provisioning_status | default('unknown') | replace('_', ' ') | title }}
                    </span>
                </div>
                {% if client.auto_provision %}
                <p class="text-xs text-dark-text-secondary">Automatically provisioned tenant</p>
                {% endif %}
                <p class="text-xs text-brand-salmon bg-brand-salmon/10 border border-brand-salmon/30 rounded p-2 {% if not client.provisioning_error %}hidden{% endif %}"
                   data-role="provisioning-error">
                    {{ client.provisioning_error or '' }}
                </p>
                <p class="text-xs text-dark-text-secondary truncate {% if not client.supabase_project_url %}hidden{% endif %}"
                   data-role="supabase-url">
                    <strong class="text-dark-text">Supabase:</strong> <span>{{ client.supabase_project_url or '' }}</span>
                </p>
            </div>

            <div class="mt-4 pt-4 border-t border-dark-border">
                <div class="text-xs text-dark-text-secondary mb-2">Service Configuration</div>
                <div class="flex gap-2 flex-wrap">
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                        {% if client.supabase_ready %}bg-brand-teal/20 text-brand-teal{% else %}bg-brand-salmon/20 text-brand-salmon{% endif %}">
                        Supabase
                    </span>
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                        {% if client.livekit_ready %}bg-brand-teal/20 text-brand-teal{% else %}bg-brand-salmon/20 text-brand-salmon{% endif %}">
                        LiveKit
                    </span>
                </div>
            </div>
            
            <div class="mt-4 flex justify-between">
                <a href="/admin/clients/{{ client.id }}"
                   class="text-brand-teal hover:text-brand-teal/80 text-sm font-medium transition-colors">
                    Edit
                </a>
                <button onclick="confirmDeleteClient({{ client.id|tojson }}, {{ client.name|tojson }})" class="text-brand-salmon hover:text-brand-salmon/80 text-sm font-medium transition-colors">
                    Delete
                </button>
            </div>
        </div>
        {% else %}
        <div class="col-span-full">
            <div class="bg-dark-surface rounded-lg border border-dark-border p-8 text-center">
                <svg class="mx-auto h-12 w-12 text-dark-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4c0-1.313-.253-2.566-.712-3.714M14 40H4v-4a6 6 0 0110.712-3.714M14 40v-4c0-1.313.253-2.566.712-3.714m0 0A8.002 8.002 0 0122 6a8.002 8.002 0 017.288 11.286" />
                </svg>
                <p class="text-dark-text-secondary mb-4 mt-4">No clients found. Click "Add Client" to create your first client.</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Client Modal -->
<div id="addClientModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="closeAddClientModal()"></div>
        
        <div class="inline-block align-bottom bg-dark-surface rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full border border-dark-border">
            <form id="addClientForm">
                <div class="bg-dark-surface px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-dark-text mb-4">
                        Add New Client
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client Slug*</label>
                            <input type="text" id="clientSlug" required pattern="[a-z0-9\-]+"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal"
                                   placeholder="e.g., my-client">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client Name*</label>
                            <input type="text" id="clientName" required
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal"
                                   placeholder="e.g., My Client Name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Domain</label>
                            <input type="text" id="clientDomain"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal"
                                   placeholder="e.g., myclient.com">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="clientDescription" rows="2"
                                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal"></textarea>
                        </div>
                    </div>
                    <div class="md:col-span-2 mt-6 bg-dark-elevated border border-dark-border rounded-lg p-4 flex items-start gap-3">
                        <input type="checkbox" id="autoProvisionToggle" class="mt-1 h-4 w-4 text-brand-teal border-gray-300 rounded focus:ring-brand-teal" checked onchange="toggleProvisionMode()">
                        <div>
                            <label for="autoProvisionToggle" class="text-sm font-medium text-dark-text">Automatically provision Supabase project</label>
                            <p class="text-xs text-dark-text-secondary mt-1">Enable to spin up a dedicated Supabase project for this client. Disable if you need to supply credentials for an existing Supabase account.</p>
                        </div>
                    </div>

                    <div id="manualConfigSection" class="mt-6 space-y-6 hidden">
                        <div class="space-y-4">
                            <h4 class="text-md font-medium text-gray-900">Supabase Configuration</h4>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Supabase URL*</label>
                                <input type="url" id="supabaseUrl"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal"
                                       placeholder="https://xxxxx.supabase.co"
                                       onchange="enableSyncButton()">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Anon Key*</label>
                                    <input type="password" id="supabaseAnonKey"
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Service Role Key*</label>
                                    <input type="password" id="supabaseServiceKey"
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal"
                                           onchange="enableSyncButton()">
                                </div>
                            </div>

                            <div class="flex justify-end">
                                <button type="button" id="syncSettingsBtn" onclick="syncSettingsFromSupabase()"
                                        disabled
                                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-teal disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Sync Settings from Supabase
                                </button>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h4 class="text-md font-medium text-gray-900">LiveKit Configuration</h4>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">LiveKit Server URL*</label>
                                <input type="url" id="livekitUrl"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal"
                                       placeholder="https://your-livekit-server.com">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">API Key*</label>
                                    <input type="text" id="livekitApiKey"
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">API Secret*</label>
                                    <input type="password" id="livekitApiSecret"
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-brand-teal focus:border-brand-teal">
                                </div>
                            </div>
                        </div>

                        <div id="apiKeysSection" class="hidden">
                            <h4 class="text-md font-medium text-gray-900">API Keys (From Supabase)</h4>
                            <div class="bg-brand-teal/10 border border-brand-teal/30 rounded-md p-4 mb-4">
                                <p class="text-sm text-brand-teal">These API keys were retrieved from your Supabase project and will be saved with this client configuration.</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="apiKeysList">
                                <!-- API keys will be populated here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="addClient()"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-brand-teal text-base font-medium text-white hover:bg-brand-teal/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-teal sm:ml-3 sm:w-auto sm:text-sm">
                        Create Client
                    </button>
                    <button type="button" onclick="closeAddClientModal()"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="modal-container"></div>
{% endblock %}

{% block extra_scripts %}
<script>
const MANUAL_FIELDS = [
    'supabaseUrl',
    'supabaseAnonKey',
    'supabaseServiceKey',
    'livekitUrl',
    'livekitApiKey',
    'livekitApiSecret'
];

function showAddClientModal() {
    const form = document.getElementById('addClientForm');
    form.reset();
    document.getElementById('apiKeysSection').classList.add('hidden');
    document.getElementById('apiKeysList').innerHTML = '';
    document.getElementById('autoProvisionToggle').checked = true;
    toggleProvisionMode();
    document.getElementById('addClientModal').classList.remove('hidden');
}

function closeAddClientModal() {
    document.getElementById('addClientModal').classList.add('hidden');
}

function toggleProvisionMode() {
    const autoProvision = document.getElementById('autoProvisionToggle').checked;
    const manualSection = document.getElementById('manualConfigSection');
    const syncBtn = document.getElementById('syncSettingsBtn');

    manualSection.classList.toggle('hidden', autoProvision);
    setManualFieldRequired(!autoProvision);

    if (autoProvision) {
        syncBtn.disabled = true;
        document.getElementById('apiKeysSection').classList.add('hidden');
        document.getElementById('apiKeysList').innerHTML = '';
    } else {
        enableSyncButton();
    }
}

function setManualFieldRequired(required) {
    MANUAL_FIELDS.forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;
        if (required) {
            field.setAttribute('required', 'required');
        } else {
            field.removeAttribute('required');
        }
    });
}

async function addClient() {
    const form = document.getElementById('addClientForm');
    const autoProvision = document.getElementById('autoProvisionToggle').checked;

    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const slug = document.getElementById('clientSlug').value.trim();
    const name = document.getElementById('clientName').value.trim();
    const description = document.getElementById('clientDescription').value.trim();
    const domain = document.getElementById('clientDomain').value.trim();

    const additionalSettings = {};
    if (slug) additionalSettings.slug = slug;
    if (domain) additionalSettings.domain = domain;
    if (description) additionalSettings.description = description;

    const payload = {
        name,
        auto_provision: autoProvision
    };

    const settingsPayload = {};
    if (Object.keys(additionalSettings).length > 0) {
        settingsPayload.additional_settings = additionalSettings;
    }

    if (!autoProvision) {
        const supabaseUrl = document.getElementById('supabaseUrl').value;
        const supabaseAnonKey = document.getElementById('supabaseAnonKey').value;
        const supabaseServiceKey = document.getElementById('supabaseServiceKey').value;
        const livekitUrl = document.getElementById('livekitUrl').value;
        const livekitApiKey = document.getElementById('livekitApiKey').value;
        const livekitApiSecret = document.getElementById('livekitApiSecret').value;

        payload.supabase_project_url = supabaseUrl;
        payload.supabase_service_role_key = supabaseServiceKey;
        if (supabaseAnonKey) {
            payload.supabase_anon_key = supabaseAnonKey;
        }

        settingsPayload.livekit_config = {
            url: livekitUrl,
            api_key: livekitApiKey,
            api_secret: livekitApiSecret
        };

        const apiKeyInputs = document.querySelectorAll('#apiKeysList input[data-api-key]');
        if (apiKeyInputs.length > 0) {
            const apiKeys = {};
            apiKeyInputs.forEach(input => {
                const key = input.getAttribute('data-api-key');
                const value = input.value;
                if (value) {
                    apiKeys[key] = value;
                }
            });
            if (Object.keys(apiKeys).length > 0) {
                settingsPayload.api_keys = apiKeys;
            }
        }
    }

    if (Object.keys(settingsPayload).length > 0) {
        payload.settings = settingsPayload;
    }

    try {
        if (window.showGlobalLoading) window.showGlobalLoading('/api/v2/clients');
        const response = await fetch('/api/v2/clients', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            window.location.reload();
            return;
        }

        const error = await response.json().catch(() => ({}));
        console.error('Error response:', error);

        if (error.detail && Array.isArray(error.detail)) {
            const messages = error.detail.map(err => `${err.loc.join('.')}: ${err.msg}`).join('\n');
            alert('Validation error:\n' + messages);
        } else {
            alert('Error creating client: ' + (error.detail || JSON.stringify(error)));
        }
    } catch (error) {
        console.error('Request error:', error);
        alert('Error creating client: ' + error.message);
    } finally {
        if (window.hideGlobalLoading) window.hideGlobalLoading();
    }
}

async function confirmDeleteClient(clientId, clientName) {
    if (!confirm(`Are you sure you want to delete client "${clientName}"? This action cannot be undone.`)) {
        return;
    }

    console.log('Deleting client:', clientId, clientName);

    try {
        const url = `/api/v2/clients/${clientId}`;
        console.log('DELETE request to:', url);

        let response = await fetch(url, { method: 'DELETE' });
        console.log('Response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Delete failed:', response.status, errorText);

            // Try v1 fallback
            console.log('Trying v1 fallback...');
            response = await fetch(`/api/v1/clients/${clientId}`, { method: 'DELETE' });
            console.log('v1 Response status:', response.status);

            if (!response.ok) {
                const v1ErrorText = await response.text();
                console.error('v1 Delete also failed:', response.status, v1ErrorText);
                alert(`Error deleting client: ${response.status} - ${v1ErrorText}`);
                return;
            }
        }

        console.log('Delete successful, reloading...');
        window.location.reload();
    } catch (error) {
        console.error('Delete error:', error);
        alert('Error deleting client: ' + error.message);
    }
}

function enableSyncButton() {
    const autoProvision = document.getElementById('autoProvisionToggle').checked;
    const syncBtn = document.getElementById('syncSettingsBtn');

    if (autoProvision) {
        syncBtn.disabled = true;
        return;
    }

    const url = document.getElementById('supabaseUrl').value;
    const key = document.getElementById('supabaseServiceKey').value;
    syncBtn.disabled = !(url && key);
}

async function syncSettingsFromSupabase() {
    if (document.getElementById('autoProvisionToggle').checked) {
        alert('Disable automatic provisioning to sync settings from an existing Supabase project.');
        return;
    }

    const url = document.getElementById('supabaseUrl').value;
    const serviceKey = document.getElementById('supabaseServiceKey').value;

    if (!url || !serviceKey) {
        alert('Please enter both Supabase URL and Service Role Key first');
        return;
    }

    const syncBtn = document.getElementById('syncSettingsBtn');
    syncBtn.disabled = true;
    syncBtn.innerHTML = '<svg class="animate-spin -ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Syncing...';

    try {
        const response = await fetch('/api/v1/clients/sync-settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url, service_role_key: serviceKey })
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            alert('Error syncing settings: ' + (error.detail || 'Unknown error'));
            return;
        }

        const settings = await response.json();

        if (settings.api_keys && Object.keys(settings.api_keys).some(k => settings.api_keys[k])) {
            const apiKeysSection = document.getElementById('apiKeysSection');
            const apiKeysList = document.getElementById('apiKeysList');
            apiKeysList.innerHTML = '';

            const apiKeyLabels = {
                'openai_api_key': 'OpenAI API Key',
                'groq_api_key': 'Groq API Key',
                'deepinfra_api_key': 'DeepInfra API Key',
                'replicate_api_key': 'Replicate API Key',
                'deepgram_api_key': 'Deepgram API Key',
                'elevenlabs_api_key': 'ElevenLabs API Key',
                'cartesia_api_key': 'Cartesia API Key',
                'speechify_api_key': 'Speechify API Key',
                'novita_api_key': 'Novita API Key',
                'cohere_api_key': 'Cohere API Key',
                'siliconflow_api_key': 'SiliconFlow API Key',
                'jina_api_key': 'Jina API Key'
            };

            for (const [key, value] of Object.entries(settings.api_keys)) {
                if (!value) continue;
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">${apiKeyLabels[key] || key}</label>
                    <input type="password" value="${value}" readonly
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border bg-gray-50"
                           data-api-key="${key}">
                `;
                apiKeysList.appendChild(div);
            }

            apiKeysSection.classList.remove('hidden');
        }

        if (settings.livekit) {
            if (settings.livekit.server_url) {
                document.getElementById('livekitUrl').value = settings.livekit.server_url;
            }
            if (settings.livekit.api_key) {
                document.getElementById('livekitApiKey').value = settings.livekit.api_key;
            }
            if (settings.livekit.api_secret) {
                document.getElementById('livekitApiSecret').value = settings.livekit.api_secret;
            }
        }

        alert('Successfully synced settings from Supabase');
    } catch (error) {
        alert('Error syncing settings: ' + error.message);
    } finally {
        const autoProvision = document.getElementById('autoProvisionToggle').checked;
        syncBtn.disabled = autoProvision;
        syncBtn.innerHTML = '<svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Sync Settings from Supabase';
        if (!autoProvision) enableSyncButton();
    }
}

const CLIENT_PROVISIONING_POLL_INTERVAL = 8000;
const CLIENT_PROVISIONING_STATUS_CLASSES = {
    ready: 'bg-brand-teal/20 text-brand-teal',
    queued: 'bg-yellow-500/20 text-yellow-500',
    creating_project: 'bg-yellow-500/20 text-yellow-500',
    schema_syncing: 'bg-yellow-500/20 text-yellow-500',
    failed: 'bg-brand-salmon/20 text-brand-salmon',
    unknown: 'bg-dark-elevated text-dark-text-secondary'
};

function formatProvisioningLabel(status) {
    if (!status) return 'Unknown';
    return status.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

function applyCardProvisioningStatus(card, status) {
    if (!card) return;
    const badge = card.querySelector('[data-role="provisioning-badge"]');
    if (badge) {
        const classes = CLIENT_PROVISIONING_STATUS_CLASSES[status] || CLIENT_PROVISIONING_STATUS_CLASSES.unknown;
        badge.className = `inline-flex items-center px-2 py-1 rounded text-xs font-semibold ${classes}`;
        badge.textContent = formatProvisioningLabel(status);
        badge.dataset.status = status;
    }
}

function updateClientCardFromSnapshot(snapshot) {
    const card = document.querySelector(`.client-card[data-client-id="${snapshot.id}"]`);
    if (!card) return;

    applyCardProvisioningStatus(card, snapshot.provisioning_status || 'unknown');

    const errorBlock = card.querySelector('[data-role="provisioning-error"]');
    if (errorBlock) {
        if (snapshot.provisioning_error) {
            errorBlock.textContent = snapshot.provisioning_error;
            errorBlock.classList.remove('hidden');
        } else {
            errorBlock.textContent = '';
            errorBlock.classList.add('hidden');
        }
    }

    const supabaseRow = card.querySelector('[data-role="supabase-url"] span');
    const supabaseWrapper = supabaseRow ? supabaseRow.closest('[data-role="supabase-url"]') : null;
    if (supabaseRow && supabaseWrapper) {
        const url = snapshot.supabase_project_url || '';
        supabaseRow.textContent = url;
        if (url) {
            supabaseWrapper.classList.remove('hidden');
        } else {
            supabaseWrapper.classList.add('hidden');
        }
    }
}

let clientProvisioningPollHandle = null;

async function pollClientProvisioningStatuses() {
    try {
        const response = await fetch('/api/v2/clients');
        if (!response.ok) {
            throw new Error(`Failed to fetch clients (${response.status})`);
        }
        const clientSnapshots = await response.json();
        clientSnapshots.forEach(updateClientCardFromSnapshot);
    } catch (error) {
        console.debug('Client provisioning poll skipped:', error.message || error);
    }
}

function startClientProvisioningPolling() {
    if (clientProvisioningPollHandle) return;
    pollClientProvisioningStatuses();
    clientProvisioningPollHandle = setInterval(pollClientProvisioningStatuses, CLIENT_PROVISIONING_POLL_INTERVAL);
}

document.addEventListener('DOMContentLoaded', () => {
    startClientProvisioningPolling();
});
</script>
{% endblock %}
