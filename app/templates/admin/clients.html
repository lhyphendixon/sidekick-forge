{% extends "admin/base.html" %}

{% block title %}Clients Management - Autonomite Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-dark-text">Client Management</h1>
                <p class="text-dark-text-secondary">Manage client configurations and API keys</p>
            </div>
            <button class="btn-primary px-4 py-2 rounded text-sm font-medium transition-all"
                    onclick="showAddClientModal()">
                Add Client
            </button>
        </div>
    </div>

    <!-- Clients Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for client in clients %}
        <div class="client-card bg-dark-surface rounded-lg border border-dark-border p-6">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-medium text-dark-text">{{ client.name }}</h3>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if client.active %}bg-brand-teal/20 text-brand-teal{% else %}bg-dark-elevated text-dark-text-secondary{% endif %}">
                    {% if client.active %}Active{% else %}Inactive{% endif %}
                </span>
            </div>
            
            <div class="text-sm text-dark-text-secondary space-y-2">
                <p><strong class="text-dark-text">ID:</strong> {{ client.id }}</p>
                {% if client.domain %}
                <p><strong class="text-dark-text">Domain:</strong> {{ client.domain }}</p>
                {% endif %}
                {% if client.description %}
                <p class="mt-2">{{ client.description }}</p>
                {% endif %}
            </div>
            
            <div class="mt-4 pt-4 border-t border-dark-border">
                <div class="text-xs text-dark-text-secondary mb-2">Configuration Status</div>
                <div class="flex gap-2 flex-wrap">
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium {% if client.settings.supabase %}bg-brand-teal/20 text-brand-teal{% else %}bg-brand-salmon/20 text-brand-salmon{% endif %}">
                        Supabase
                    </span>
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium {% if client.settings.livekit %}bg-brand-teal/20 text-brand-teal{% else %}bg-brand-salmon/20 text-brand-salmon{% endif %}">
                        LiveKit
                    </span>
                </div>
            </div>
            
            <div class="mt-4 flex justify-between">
                <a href="/admin/clients/{{ client.id }}" class="text-brand-teal hover:text-brand-teal/80 text-sm font-medium transition-colors">
                    Edit
                </a>
                <button onclick="confirmDeleteClient('{{ client.id }}', '{{ client.name }}')" class="text-brand-salmon hover:text-brand-salmon/80 text-sm font-medium transition-colors">
                    Delete
                </button>
            </div>
        </div>
        {% else %}
        <div class="col-span-full">
            <div class="bg-dark-surface rounded-lg border border-dark-border p-8 text-center">
                <svg class="mx-auto h-12 w-12 text-dark-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4c0-1.313-.253-2.566-.712-3.714M14 40H4v-4a6 6 0 0110.712-3.714M14 40v-4c0-1.313.253-2.566.712-3.714m0 0A8.002 8.002 0 0122 6a8.002 8.002 0 017.288 11.286" />
                </svg>
                <p class="text-dark-text-secondary mb-4 mt-4">No clients found. Click "Add Client" to create your first client.</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Client Modal -->
<div id="addClientModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-black bg-opacity-75 transition-opacity" onclick="closeAddClientModal()"></div>
        
        <div class="inline-block align-bottom bg-dark-surface rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full border border-dark-border">
            <form id="addClientForm">
                <div class="bg-dark-surface px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-dark-text mb-4">
                        Add New Client
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client Slug*</label>
                            <input type="text" id="clientSlug" required pattern="[a-z0-9\-]+"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="e.g., my-client">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client Name*</label>
                            <input type="text" id="clientName" required
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="e.g., My Client Name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Domain</label>
                            <input type="text" id="clientDomain"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="e.g., myclient.com">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="clientDescription" rows="2"
                                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>
                    
                    <h4 class="text-md font-medium text-gray-900 mt-6 mb-4">Supabase Configuration</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Supabase URL*</label>
                            <input type="url" id="supabaseUrl" required
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="https://xxxxx.supabase.co"
                                   onchange="enableSyncButton()">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Anon Key*</label>
                                <input type="password" id="supabaseAnonKey" required
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Service Role Key*</label>
                                <input type="password" id="supabaseServiceKey" required
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500"
                                       onchange="enableSyncButton()">
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="button" id="syncSettingsBtn" onclick="syncSettingsFromSupabase()"
                                    disabled
                                    class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Sync Settings from Supabase
                            </button>
                        </div>
                    </div>
                    
                    <h4 class="text-md font-medium text-gray-900 mt-6 mb-4">LiveKit Configuration</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">LiveKit Server URL*</label>
                            <input type="url" id="livekitUrl" required
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="https://your-livekit-server.com">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">API Key*</label>
                                <input type="text" id="livekitApiKey" required
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">API Secret*</label>
                                <input type="password" id="livekitApiSecret" required
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Keys Section (hidden by default, shown when synced) -->
                    <div id="apiKeysSection" class="hidden">
                        <h4 class="text-md font-medium text-gray-900 mt-6 mb-4">API Keys (From Supabase)</h4>
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                            <p class="text-sm text-blue-700">These API keys were retrieved from your Supabase project and will be saved with this client configuration.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="apiKeysList">
                            <!-- API keys will be populated here dynamically -->
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="addClient()"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Create Client
                    </button>
                    <button type="button" onclick="closeAddClientModal()"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function showAddClientModal() {
    document.getElementById('addClientForm').reset();
    document.getElementById('addClientModal').classList.remove('hidden');
}

function closeAddClientModal() {
    document.getElementById('addClientModal').classList.add('hidden');
}

async function addClient() {
    const form = document.getElementById('addClientForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const clientData = {
        slug: document.getElementById('clientSlug').value,
        name: document.getElementById('clientName').value,
        description: document.getElementById('clientDescription').value || null,
        domain: document.getElementById('clientDomain').value || null,
        settings: {
            supabase: {
                url: document.getElementById('supabaseUrl').value,
                anon_key: document.getElementById('supabaseAnonKey').value,
                service_role_key: document.getElementById('supabaseServiceKey').value
            },
            livekit: {
                server_url: document.getElementById('livekitUrl').value,
                api_key: document.getElementById('livekitApiKey').value,
                api_secret: document.getElementById('livekitApiSecret').value
            }
        }
    };
    
    // Add API keys if they were synced
    const apiKeyInputs = document.querySelectorAll('#apiKeysList input[data-api-key]');
    if (apiKeyInputs.length > 0) {
        clientData.settings.api_keys = {};
        apiKeyInputs.forEach(input => {
            const key = input.getAttribute('data-api-key');
            const value = input.value;
            if (value) {
                clientData.settings.api_keys[key] = value;
            }
        });
    }
    
    try {
        if (window.showGlobalLoading) window.showGlobalLoading('/api/v1/clients/');
        const response = await fetch('/api/v1/clients/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(clientData)
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            console.error('Error response:', error);
            // Handle validation errors
            if (error.detail && Array.isArray(error.detail)) {
                const messages = error.detail.map(err => `${err.loc.join('.')}: ${err.msg}`).join('\n');
                alert('Validation error:\n' + messages);
            } else {
                alert('Error creating client: ' + (error.detail || JSON.stringify(error)));
            }
        }
    } catch (error) {
        console.error('Request error:', error);
        alert('Error creating client: ' + error.message);
    } finally {
        if (window.hideGlobalLoading) window.hideGlobalLoading();
    }
}

async function confirmDeleteClient(clientId, clientName) {
    if (!confirm(`Are you sure you want to delete client "${clientName}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/clients/${clientId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error deleting client');
        }
    } catch (error) {
        alert('Error deleting client: ' + error.message);
    }
}

function enableSyncButton() {
    const url = document.getElementById('supabaseUrl').value;
    const key = document.getElementById('supabaseServiceKey').value;
    const syncBtn = document.getElementById('syncSettingsBtn');
    
    if (url && key) {
        syncBtn.disabled = false;
    } else {
        syncBtn.disabled = true;
    }
}

async function syncSettingsFromSupabase() {
    const url = document.getElementById('supabaseUrl').value;
    const serviceKey = document.getElementById('supabaseServiceKey').value;
    
    if (!url || !serviceKey) {
        alert('Please enter both Supabase URL and Service Role Key first');
        return;
    }
    
    const syncBtn = document.getElementById('syncSettingsBtn');
    syncBtn.disabled = true;
    syncBtn.innerHTML = '<svg class="animate-spin -ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Syncing...';
    
    try {
        const response = await fetch('/api/v1/clients/sync-settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                url: url,
                service_role_key: serviceKey
            })
        });
        
        if (response.ok) {
            const settings = await response.json();
            
            // Populate API keys if they exist
            if (settings.api_keys && Object.keys(settings.api_keys).some(k => settings.api_keys[k])) {
                const apiKeysSection = document.getElementById('apiKeysSection');
                const apiKeysList = document.getElementById('apiKeysList');
                
                // Clear existing content
                apiKeysList.innerHTML = '';
                
                // Add each API key that has a value
                const apiKeyLabels = {
                    // LLM Providers
                    'openai_api_key': 'OpenAI API Key',
                    'groq_api_key': 'Groq API Key',
                    'deepinfra_api_key': 'DeepInfra API Key',
                    'replicate_api_key': 'Replicate API Key',
                    // Voice/Speech Providers
                    'deepgram_api_key': 'Deepgram API Key',
                    'elevenlabs_api_key': 'ElevenLabs API Key',
                    'cartesia_api_key': 'Cartesia API Key',
                    'speechify_api_key': 'Speechify API Key',
                    // Embedding/Reranking Providers
                    'novita_api_key': 'Novita API Key',
                    'cohere_api_key': 'Cohere API Key',
                    'siliconflow_api_key': 'SiliconFlow API Key',
                    'jina_api_key': 'Jina API Key'
                };
                
                for (const [key, value] of Object.entries(settings.api_keys)) {
                    if (value) {
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <label class="block text-sm font-medium text-gray-700">${apiKeyLabels[key] || key}</label>
                            <input type="password" value="${value}" readonly
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm px-3 py-2 border bg-gray-50"
                                   data-api-key="${key}">
                        `;
                        apiKeysList.appendChild(div);
                    }
                }
                
                // Show the API keys section
                apiKeysSection.classList.remove('hidden');
            }
            
            // Populate LiveKit settings if they exist
            if (settings.livekit) {
                if (settings.livekit.server_url) {
                    document.getElementById('livekitUrl').value = settings.livekit.server_url;
                }
                if (settings.livekit.api_key) {
                    document.getElementById('livekitApiKey').value = settings.livekit.api_key;
                }
                if (settings.livekit.api_secret) {
                    document.getElementById('livekitApiSecret').value = settings.livekit.api_secret;
                }
            }
            
            // Show success message
            if (settings.message) {
                alert('Success: ' + settings.message);
            } else {
                alert('Successfully synced settings from Supabase');
            }
            
        } else {
            const error = await response.json();
            alert('Error syncing settings: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error syncing settings: ' + error.message);
    } finally {
        syncBtn.disabled = false;
        syncBtn.innerHTML = '<svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Sync Settings from Supabase';
        enableSyncButton(); // Re-check if button should be enabled
    }
}
</script>
{% endblock %}