{% extends "admin/base.html" %}

{% block title %}Abilities{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold text-dark-text">Abilities</h1>
    <button class="btn-primary px-4 py-2 rounded" onclick="openCreateToolModal()">Add Ability</button>
  </div>

  <div class="mb-4 flex gap-2 items-center flex-wrap">
    <select id="clientFilter" data-default="{{ default_client_id or '' }}" class="px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" onchange="onClientFilterChange()">
      <option value="">All clients</option>
      {% for client in clients or [] %}
      <option value="{{ client.id }}">{{ client.name }}</option>
      {% endfor %}
    </select>
    <input id="searchInput" class="px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" placeholder="Search abilities..." oninput="refreshTools()" />
    <select id="typeFilter" class="px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" onchange="refreshTools()">
      <option value="">All types</option>
      <option value="mcp">MCP</option>
      <option value="n8n">n8n</option>
      <option value="sidekick">Sidekick</option>
      <option value="code">Code</option>
      <option value="asana">Asana</option>
    </select>
    <select id="scopeFilter" class="px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" onchange="refreshTools()">
      <option value="">All scopes</option>
      <option value="global">Global</option>
      <option value="client">Client</option>
    </select>
  </div>

  <div id="toolsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
</div>

<div id="createToolModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
  <div class="bg-dark-surface rounded-lg border border-dark-border w-full max-w-2xl p-4 max-h-[88vh] overflow-y-auto mx-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl text-dark-text">Create Ability</h2>
      <button class="text-dark-text-secondary" onclick="closeCreateToolModal()">✕</button>
    </div>
    <div class="space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-dark-text">Name</label>
          <input id="ct_name" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" />
        </div>
        <div>
          <label class="text-sm text-dark-text">Slug</label>
          <input id="ct_slug" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" />
        </div>
      </div>
      <div>
        <label class="text-sm text-dark-text">Description</label>
        <textarea id="ct_desc" rows="2" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text"></textarea>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-dark-text">Type</label>
          <select id="ct_type" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" onchange="toggleTypeFields()">
            <option value="mcp">MCP</option>
            <option value="n8n">n8n</option>
            <option value="sidekick">Sidekick</option>
            <option value="code">Code</option>
            <option value="asana">Asana</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-dark-text">Scope</label>
          <select id="ct_scope" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" onchange="handleScopeChange()">
            <option value="client">Client</option>
            <option value="global">Global</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-dark-text">Icon URL</label>
          <input id="ct_icon" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" />
        </div>
        <div id="ct_client_group" class="hidden">
          <label class="text-sm text-dark-text">Client</label>
          <select id="ct_client_id" data-default="{{ default_client_id or '' }}" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text">
            <option value="">Select a client</option>
            {% for client in clients or [] %}
            <option value="{{ client.id }}">{{ client.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div id="ct_typeFields" class="space-y-2">
        <!-- Dynamic config inputs per type -->
      </div>
      <div id="ct_perplexity_client_panel" class="hidden text-sm text-dark-text-secondary">
        Client-specific Perplexity API keys can be managed from the Clients page after assigning this ability.
      </div>
      <div class="flex justify-end gap-2">
        <button class="px-4 py-2 rounded border border-dark-border text-dark-text-secondary" onclick="closeCreateToolModal()">Cancel</button>
        <button class="btn-primary px-4 py-2 rounded" onclick="createTool()">Create</button>
      </div>
    </div>
  </div>
  </div>

<div id="editToolModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
  <div class="bg-dark-surface rounded-lg border border-dark-border w-full max-w-2xl p-4 max-h-[88vh] overflow-y-auto mx-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl text-dark-text">Edit Ability</h2>
      <button class="text-dark-text-secondary" onclick="closeEditToolModal()">✕</button>
    </div>
    <div class="space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-dark-text">Name</label>
          <input id="et_name" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" />
        </div>
        <div>
          <label class="text-sm text-dark-text">Slug</label>
          <input id="et_slug" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" readonly />
        </div>
      </div>
      <div>
        <label class="text-sm text-dark-text">Description</label>
        <textarea id="et_desc" rows="2" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text"></textarea>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-dark-text">Type</label>
          <select id="et_type" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" disabled>
            <option value="mcp">MCP</option>
            <option value="n8n">n8n</option>
            <option value="sidekick">Sidekick</option>
            <option value="code">Code</option>
            <option value="asana">Asana</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-dark-text">Scope</label>
          <select id="et_scope" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" disabled>
            <option value="client">Client</option>
            <option value="global">Global</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-dark-text">Icon URL</label>
          <input id="et_icon" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" />
        </div>
      </div>
      <div id="et_client_group" class="hidden">
        <label class="text-sm text-dark-text">Client</label>
        <select id="et_client_id" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" disabled>
          <option value="">Select a client</option>
          {% for client in clients or [] %}
          <option value="{{ client.id }}">{{ client.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="et_typeFields" class="space-y-2"></div>
      <div id="et_perplexity_client_panel" class="hidden space-y-2">
        {% if clients %}
        <div id="et_perplexity_client_selector" class="hidden">
          <label class="text-sm text-dark-text">Client</label>
          <select id="et_perplexity_client_select" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text">
            <option value="">Select a client</option>
            {% for client in clients or [] %}
            <option value="{{ client.id }}">{{ client.name }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        <div>
          <label class="text-sm text-dark-text">Client API Key</label>
          <input id="et_mcp_client_api_key" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" placeholder="pplx-..." />
          <p class="text-xs text-dark-text-secondary mt-1">Stored per client and used whenever this ability runs. Leave blank to clear the saved key for this client.</p>
        </div>
        <div id="et_perplexity_client_notice" class="text-xs text-brand-salmon hidden">Select a client using the page filter or the dropdown above to manage this Perplexity API key.</div>
      </div>
      <div class="flex items-center justify-between">
        <label class="flex items-center gap-2 text-sm text-dark-text">
          <input type="checkbox" id="et_enabled" class="w-4 h-4" /> Enabled
        </label>
        <div class="flex gap-2">
          <button class="px-4 py-2 rounded border border-dark-border text-dark-text-secondary" onclick="closeEditToolModal()">Cancel</button>
          <button class="btn-primary px-4 py-2 rounded" onclick="updateTool()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const ADMIN_TOOLS_BASE = '/admin/api/tools';
const ADMIN_CLIENTS_BASE = '/admin/api/clients';
const toolsCache = {};
let editingToolId = null;

async function fetchJSON(url, options){
  const response = await fetch(url, Object.assign({ credentials: 'include' }, options));
  if(!response.ok){
    const text = await response.text();
    throw new Error(text || 'request failed');
  }
  const contentType = response.headers.get('content-type') || '';
  if(contentType.includes('application/json')){
    return response.json();
  }
  return null;
}

function openCreateToolModal(){
  document.getElementById('ct_name').value = '';
  document.getElementById('ct_slug').value = '';
  document.getElementById('ct_desc').value = '';
  document.getElementById('ct_icon').value = '';
  document.getElementById('ct_type').value = 'mcp';
  document.getElementById('ct_scope').value = 'client';
  handleScopeChange('ct');
  renderTypeFields('ct', 'mcp');
  togglePerplexityClientPanel('ct', false);
  document.getElementById('createToolModal').classList.remove('hidden');
  document.getElementById('createToolModal').classList.add('flex');
}

function closeCreateToolModal(){
  document.getElementById('createToolModal').classList.add('hidden');
  document.getElementById('createToolModal').classList.remove('flex');
}

function closeEditToolModal(){
  document.getElementById('editToolModal').classList.add('hidden');
  document.getElementById('editToolModal').classList.remove('flex');
  editingToolId = null;
}

function renderTypeFields(prefix, toolType, existingConfig = {}){
  const wrap = document.getElementById(`${prefix}_typeFields`);
  if(!wrap) return;
  const safeConfig = existingConfig || {};
  if(toolType === 'n8n'){
    const headersJson = safeConfig.headers ? JSON.stringify(safeConfig.headers, null, 2) : '';
    const payloadJson = safeConfig.default_payload ? JSON.stringify(safeConfig.default_payload, null, 2) : '';
    const includeContext = safeConfig.include_context !== false;
    const stripNulls = safeConfig.strip_nulls !== false;
    const timeoutValue = safeConfig.timeout !== undefined ? safeConfig.timeout : 20;
    const inquiryField = safeConfig.user_inquiry_field || 'userInquiry';

    wrap.innerHTML = `
    <div class="space-y-3">
      <div>
        <label class="text-sm text-dark-text">Webhook URL</label>
        <input id="${prefix}_n8n_url" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${safeConfig.webhook_url || ''}" placeholder="https://example.com/webhook/abc" />
      </div>
      <div>
        <label class="text-sm text-dark-text">Method</label>
        <input id="${prefix}_n8n_method" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${safeConfig.method || 'POST'}" />
      </div>
      <div>
        <label class="text-sm text-dark-text">Request Headers (JSON)</label>
        <textarea id="${prefix}_n8n_headers" rows="4" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text font-mono text-xs" placeholder="{\n  \"Authorization\": \"Bearer ...\"\n}">${headersJson}</textarea>
        <p class="text-xs text-dark-text-secondary mt-1">Optional object of HTTP headers to include with each webhook call.</p>
      </div>
      <div>
        <label class="text-sm text-dark-text">Default Payload (JSON)</label>
        <textarea id="${prefix}_n8n_payload" rows="5" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text font-mono text-xs" placeholder="{\n  \"executionMode\": \"production\"\n}">${payloadJson}</textarea>
        <p class="text-xs text-dark-text-secondary mt-1">This JSON object is merged into every webhook call before runtime context and tool parameters.</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-dark-text">Timeout (seconds)</label>
          <input id="${prefix}_n8n_timeout" type="number" min="1" step="1" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${timeoutValue}" />
        </div>
        <div>
          <label class="text-sm text-dark-text">User Inquiry Field Name</label>
          <input id="${prefix}_n8n_inquiry_field" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${inquiryField}" />
          <p class="text-xs text-brand-salmon mt-1">The agent must provide this field when invoking the ability. No automatic fallback is performed.</p>
        </div>
      </div>
      <div class="flex flex-col md:flex-row gap-4">
        <label class="flex items-center gap-2 text-sm text-dark-text">
          <input id="${prefix}_n8n_include_context" type="checkbox" class="rounded border-dark-border" ${includeContext ? 'checked' : ''} />
          Include session context (user_id, conversation_id, session_id, agent_slug, client_id)
        </label>
        <label class="flex items-center gap-2 text-sm text-dark-text">
          <input id="${prefix}_n8n_strip_nulls" type="checkbox" class="rounded border-dark-border" ${stripNulls ? 'checked' : ''} />
          Strip <code>null</code> values before sending
        </label>
      </div>
      <p class="text-xs text-dark-text-secondary">At runtime the tool also accepts a <code>metadata</code> object from the agent to add extra fields to the webhook payload.</p>
    </div>`;
    appendHiddenInstructions(prefix, wrap, safeConfig);
    return;
  }
  if(toolType === 'sidekick'){
    wrap.innerHTML = `
    <div>
      <label class="text-sm text-dark-text">Target Agent Slug</label>
      <input id="${prefix}_sidekick_agent" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${safeConfig.agent_slug || ''}" />
    </div>`;
    appendHiddenInstructions(prefix, wrap, safeConfig);
    return;
  }
  if(toolType === 'asana'){
    const workspace = escapeHtml(safeConfig.workspace_gid || '');
    const assignee = escapeHtml(safeConfig.default_assignee || '');
    const maxTasks = Number.isFinite(Number(safeConfig.max_tasks_per_project)) ? Number(safeConfig.max_tasks_per_project) : 10;
    const lookupLimit = Number.isFinite(Number(safeConfig.lookup_limit)) ? Number(safeConfig.lookup_limit) : Math.max(maxTasks, 25);
    const includeCompleted = safeConfig.list_include_completed === true;
    const defaultAction = escapeHtml(safeConfig.default_action || 'list');
    const projectsJsonRaw = safeConfig.projects ? JSON.stringify(safeConfig.projects, null, 2) : (safeConfig.project_gids ? JSON.stringify(safeConfig.project_gids, null, 2) : '');
    const projectsJson = escapeHtml(projectsJsonRaw);

    wrap.innerHTML = `
    <div class="space-y-3">
      <p class="text-sm text-dark-text-secondary">Connect Asana via OAuth for each client. Use the client filter above to choose a tenant before connecting.</p>
      <div id="${prefix}_asana_status" class="px-3 py-2 bg-dark-elevated border border-dark-border rounded text-sm text-dark-text-secondary">Select a client to view connection status.</div>
      <div class="flex flex-wrap gap-2">
        <button type="button" class="btn-primary px-4 py-2 rounded" onclick="connectAsana('${prefix}')">Connect Asana</button>
        <button type="button" class="px-4 py-2 rounded border border-dark-border text-dark-text-secondary" onclick="disconnectAsana('${prefix}')">Disconnect</button>
      </div>
      <div>
        <label class="text-sm text-dark-text">Default Projects (JSON or newline list)</label>
        <textarea id="${prefix}_asana_projects" rows="5" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text font-mono text-xs" placeholder='[\n  "1201234567890",\n  {"gid": "1201234567891", "name": "Marketing"}\n]'>${projectsJson}</textarea>
        <p class="text-xs text-dark-text-secondary mt-1">Provide project gids (JSON array or newline separated). The first entry becomes the default if users do not specify a project.</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-dark-text">Workspace GID</label>
          <input id="${prefix}_asana_workspace" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${workspace}" placeholder="1200..." />
        </div>
        <div>
          <label class="text-sm text-dark-text">Default Assignee GID</label>
          <input id="${prefix}_asana_assignee" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${assignee}" placeholder="me or user gid" />
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-dark-text">Max Tasks per Project</label>
          <input id="${prefix}_asana_max_tasks" type="number" min="1" max="50" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${maxTasks}" />
        </div>
        <div>
          <label class="text-sm text-dark-text">Lookup Limit</label>
          <input id="${prefix}_asana_lookup_limit" type="number" min="5" max="100" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${lookupLimit}" />
        </div>
        <div>
          <label class="text-sm text-dark-text">Default Action</label>
          <select id="${prefix}_asana_default_action" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text">
            <option value="list" ${defaultAction === 'list' ? 'selected' : ''}>List tasks</option>
            <option value="create" ${defaultAction === 'create' ? 'selected' : ''}>Create task</option>
            <option value="update" ${defaultAction === 'update' ? 'selected' : ''}>Update task</option>
          </select>
        </div>
      </div>
      <label class="flex items-center gap-2 text-sm text-dark-text">
        <input id="${prefix}_asana_include_completed" type="checkbox" class="rounded border-dark-border" ${includeCompleted ? 'checked' : ''} />
        Include recently completed tasks when listing.
      </label>
    </div>`;
    appendHiddenInstructions(prefix, wrap, safeConfig);
    setTimeout(() => loadAsanaStatus(prefix), 0);
    return;
  }
  if(toolType === 'code'){
    wrap.innerHTML = `<div class="text-sm text-dark-text-secondary">Provide implementation via managed code abilities.</div>`;
    appendHiddenInstructions(prefix, wrap, safeConfig);
    return;
  }
  if(toolType !== 'mcp'){
    wrap.innerHTML = '';
    appendHiddenInstructions(prefix, wrap, safeConfig);
    return;
  }

  const provider = safeConfig.provider || 'generic';
  const schema = JSON.stringify(safeConfig.parameters || {}, null, 2);

  wrap.innerHTML = `
    <div>
      <label class="text-sm text-dark-text">Integration</label>
      <select id="${prefix}_mcp_provider" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" onchange="updateMcpProvider('${prefix}')">
        <option value="generic" ${provider === 'generic' ? 'selected' : ''}>External MCP server (HTTP/SSE)</option>
        <option value="perplexity" ${provider === 'perplexity' ? 'selected' : ''}>Perplexity Ask (hosted)</option>
      </select>
    </div>
    <div id="${prefix}_mcp_server_block" class="${provider === 'perplexity' ? 'hidden' : ''}">
      <label class="text-sm text-dark-text">Server URL</label>
      <input id="${prefix}_mcp_server_url" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${safeConfig.server_url || ''}" placeholder="https://example.com/mcp" />
    </div>
    <div>
      <label class="text-sm text-dark-text">Auth Token (optional)</label>
      <input id="${prefix}_mcp_api_key" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${safeConfig.api_key || ''}" placeholder="Bearer ..." />
    </div>
    <div>
      <label class="text-sm text-dark-text">Client API Key Name</label>
      <input id="${prefix}_mcp_api_key_name" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${safeConfig.api_key_name || 'perplexity_api_key'}" placeholder="perplexity_api_key" />
      <p class="text-xs text-dark-text-secondary">Lookup order: ability override → agent tools configuration → client API keys (column name above) → optional environment variable.</p>
    </div>
    <div>
      <label class="text-sm text-dark-text">Namespace (optional)</label>
      <input id="${prefix}_mcp_namespace" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${safeConfig.namespace || ''}" placeholder="tools" />
    </div>
    <div id="${prefix}_mcp_toolname_block" class="${provider === 'perplexity' ? '' : 'hidden'}">
      <label class="text-sm text-dark-text">Remote Tool Name</label>
      <input id="${prefix}_mcp_tool_name" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${safeConfig.tool_name || 'perplexity_ask'}" placeholder="perplexity_ask" />
    </div>
    <div id="${prefix}_mcp_model_block" class="${provider === 'perplexity' ? '' : 'hidden'}">
      <label class="text-sm text-dark-text">Model (optional)</label>
      <input id="${prefix}_mcp_model" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" value="${safeConfig.model || 'sonar-pro'}" placeholder="sonar-pro" />
    </div>
    <div>
      <label class="text-sm text-dark-text">Parameters JSON Schema</label>
      <textarea id="${prefix}_mcp_schema" rows="6" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text font-mono text-xs">${schema}</textarea>
      <p class="text-xs text-dark-text-secondary">Provide the JSON schema for tool parameters as described in the LiveKit Agents documentation.</p>
    </div>`;

  appendHiddenInstructions(prefix, wrap, safeConfig);
  updateMcpProvider(prefix);
}

function updateMcpProvider(prefix){
  const provider = document.getElementById(`${prefix}_mcp_provider`);
  if(!provider) return;
  const mode = provider.value;
  const serverBlock = document.getElementById(`${prefix}_mcp_server_block`);
  const toolNameBlock = document.getElementById(`${prefix}_mcp_toolname_block`);
  const modelBlock = document.getElementById(`${prefix}_mcp_model_block`);
  if(serverBlock){
    if(mode === 'perplexity') serverBlock.classList.add('hidden'); else serverBlock.classList.remove('hidden');
  }
  if(toolNameBlock){
    if(mode === 'perplexity') toolNameBlock.classList.remove('hidden'); else toolNameBlock.classList.add('hidden');
  }
  if(modelBlock){
    if(mode === 'perplexity') modelBlock.classList.remove('hidden'); else modelBlock.classList.add('hidden');
  }
  togglePerplexityClientPanel(prefix, mode === 'perplexity');
}

function togglePerplexityClientPanel(prefix, enabled) {
  const panel = document.getElementById(`${prefix}_perplexity_client_panel`);
  const notice = document.getElementById(`${prefix}_perplexity_client_notice`);
  const inlineWrapper = document.getElementById(`${prefix}_perplexity_client_selector`);
  const inlineSelect = document.getElementById(`${prefix}_perplexity_client_select`);
  if (!panel) { return; }
  if (prefix === 'ct') {
    panel.classList.add('hidden');
    if (inlineWrapper) { inlineWrapper.classList.add('hidden'); }
    return;
  }
  const scopeEl = document.getElementById(`${prefix}_scope`);
  const isGlobal = scopeEl ? scopeEl.value === 'global' : true;
  if (!enabled || !isGlobal) {
    panel.classList.add('hidden');
    if (notice) { notice.classList.add('hidden'); }
    if (inlineWrapper) { inlineWrapper.classList.add('hidden'); }
    if (inlineSelect) { inlineSelect.value = ''; inlineSelect.disabled = true; }
    const resetInput = document.getElementById(`${prefix}_mcp_client_api_key`);
    if (resetInput) { resetInput.value = ''; resetInput.disabled = true; }
    return;
  }
  panel.classList.remove('hidden');
  const clientFilter = document.getElementById('clientFilter');
  let clientId = clientFilter ? clientFilter.value : '';
  if (!clientId && inlineSelect) {
    if (inlineWrapper) { inlineWrapper.classList.remove('hidden'); }
    inlineSelect.disabled = false;
    if (!inlineSelect.dataset.bound) {
      inlineSelect.addEventListener('change', () => togglePerplexityClientPanel(prefix, true));
      inlineSelect.dataset.bound = '1';
    }
    clientId = inlineSelect.value;
  } else if (inlineWrapper) {
    inlineWrapper.classList.add('hidden');
  }
  const input = document.getElementById(`${prefix}_mcp_client_api_key`);
  if (!input) { return; }
  if (clientId) {
    input.disabled = false;
    input.placeholder = 'pplx-...';
    if (notice) { notice.classList.add('hidden'); }
    loadPerplexityClientKey(prefix);
  } else {
    input.disabled = true;
    input.value = '';
    input.placeholder = 'Select a client to manage this key';
    if (notice) { notice.classList.remove('hidden'); }
  }
}

async function loadPerplexityClientKey(prefix) {
  const input = document.getElementById(`${prefix}_mcp_client_api_key`);
  if (!input) { return; }
  const clientSelect = document.getElementById('clientFilter');
  const inlineSelect = document.getElementById(`${prefix}_perplexity_client_select`);
  const clientId = (clientSelect && clientSelect.value) || (inlineSelect ? inlineSelect.value : '');
  if (!clientId) { return; }
  try {
    const data = await fetchJSON(`${ADMIN_CLIENTS_BASE}/${clientId}/perplexity-key`);
    input.value = data.api_key || '';
  } catch (err) {
    console.error('Failed to load Perplexity key', err);
  }
}

async function savePerplexityClientKey(clientId, value) {
  await fetch(`${ADMIN_CLIENTS_BASE}/${clientId}/perplexity-key`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ api_key: value })
  });
}

function handleScopeChange(prefix){
  const scopeSelect = document.getElementById(`${prefix}_scope`);
  const group = document.getElementById(`${prefix}_client_group`);
  if(!scopeSelect || !group) return;
  const scope = scopeSelect.value;
  if(scope === 'client'){
    group.classList.remove('hidden');
    const clientSelect = document.getElementById(`${prefix}_client_id`);
    const filterSelect = document.getElementById('clientFilter');
    if(clientSelect){
      const defaultClient = clientSelect.dataset.default || '';
      const selected = filterSelect && filterSelect.value ? filterSelect.value : defaultClient;
      if(selected){ clientSelect.value = selected; }
    }
  } else {
    group.classList.add('hidden');
  }
}

function onClientFilterChange(){
  refreshTools();
  const createType = document.getElementById('ct_type');
  if(createType && createType.value === 'asana'){
    loadAsanaStatus('ct');
  }
  const editType = document.getElementById('et_type');
  if(editType && editType.value === 'asana'){
    loadAsanaStatus('et');
  }
}

function escapeHtml(value){
  if(value === undefined || value === null){
    return '';
  }
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function applyHiddenInstructions(prefix, config){
  const instructionsEl = document.getElementById(`${prefix}_system_prompt_instructions`);
  if(!instructionsEl){
    return config;
  }
  const value = instructionsEl.value.trim();
  if(value){
    config.system_prompt_instructions = value;
  } else {
    delete config.system_prompt_instructions;
  }
  return config;
}

function appendHiddenInstructions(prefix, wrap, safeConfig){
  if(!wrap) return;
  const rawValue = (safeConfig && safeConfig.system_prompt_instructions) || '';
  const value = escapeHtml(rawValue);
  const container = document.createElement('div');
  container.className = 'space-y-2 mt-4';
  container.innerHTML = `
    <label class="text-sm text-dark-text">Hidden System Prompt Instructions</label>
    <textarea id="${prefix}_system_prompt_instructions" rows="5" class="w-full px-3 py-2 bg-dark-elevated border border-dark-border rounded text-dark-text" placeholder="Explain exactly how the model should invoke this ability.">${value}</textarea>
    <p class="text-xs text-dark-text-secondary">Appended to the agent's system prompt automatically whenever this ability is active. Operators never see this block in the UI.</p>
  `;
  wrap.appendChild(container);
}

function getSelectedClientId(){
  const clientSelect = document.getElementById('clientFilter');
  return clientSelect ? clientSelect.value : '';
}

async function loadAsanaStatus(prefix){
  const statusEl = document.getElementById(`${prefix}_asana_status`);
  if(!statusEl){ return; }
  const clientId = getSelectedClientId();
  if(!clientId){
    statusEl.textContent = 'Select a client to view Asana connection status.';
    return;
  }
  try{
    const resp = await fetch(`/admin/api/asana/status?client_id=${encodeURIComponent(clientId)}`, { credentials: 'include' });
    if(!resp.ok){
      const text = await resp.text();
      statusEl.textContent = text || 'Failed to load connection status.';
      return;
    }
    const data = await resp.json();
    if(data.connected){
      const parts = [];
      if(data.user_name){ parts.push(`Connected as ${data.user_name}`); }
      if(data.expires_at){ parts.push(`expires ${data.expires_at}`); }
      statusEl.textContent = parts.join(' • ') || 'Asana connection active.';
    } else {
      statusEl.textContent = 'Not connected yet.';
    }
  } catch(err){
    statusEl.textContent = `Failed to load connection status: ${err.message}`;
  }
}

async function connectAsana(prefix){
  const clientId = getSelectedClientId();
  if(!clientId){
    alert('Select a client using the filter before connecting Asana.');
    return;
  }
  try{
    const resp = await fetch(`/admin/api/asana/oauth/start?client_id=${encodeURIComponent(clientId)}`, { credentials: 'include' });
    if(!resp.ok){
      const text = await resp.text();
      alert(text || 'Failed to initiate Asana OAuth.');
      return;
    }
    const data = await resp.json();
    if(data.authorization_url){
      const width = 600;
      const height = 780;
      const left = window.screenX + Math.max(0, (window.outerWidth - width) / 2);
      const top = window.screenY + Math.max(0, (window.outerHeight - height) / 2);
      window.open(
        data.authorization_url,
        'asana-oauth',
        `width=${width},height=${height},left=${left},top=${top}`
      );
    } else {
      alert('Missing authorization URL from server response.');
    }
  } catch(err){
    alert(`Failed to start Asana OAuth: ${err.message}`);
  }
}

async function disconnectAsana(prefix){
  const clientId = getSelectedClientId();
  if(!clientId){
    alert('Select a client to disconnect.');
    return;
  }
  if(!confirm('Disconnect Asana for this client?')){
    return;
  }
  try{
    const resp = await fetch(`/admin/api/asana/connection?client_id=${encodeURIComponent(clientId)}`, {
      method: 'DELETE',
      credentials: 'include'
    });
    if(!resp.ok){
      const text = await resp.text();
      alert(text || 'Failed to disconnect Asana.');
    }
  } catch(err){
    alert(`Failed to disconnect Asana: ${err.message}`);
  }
  loadAsanaStatus(prefix);
}

if(!window.__asanaOAuthListener){
  window.addEventListener('message', (event) => {
    if(event.data === 'asana-connected'){
      loadAsanaStatus('ct');
      loadAsanaStatus('et');
      refreshTools();
    }
  });
  window.__asanaOAuthListener = true;
}

function toggleTypeFields(){
  const select = document.getElementById('ct_type');
  if(select){
    const scopeSelect = document.getElementById('ct_scope');
    if(scopeSelect && select.value === 'asana' && scopeSelect.value !== 'global'){
      scopeSelect.value = 'global';
      handleScopeChange('ct');
    }
    renderTypeFields('ct', select.value);
    if(select.value === 'asana'){
      loadAsanaStatus('ct');
    }
  }
}

function buildConfigFromForm(prefix, type){
  if(type === 'n8n'){
    const webhookUrl = document.getElementById(`${prefix}_n8n_url`).value.trim();
    if(!webhookUrl){
      throw new Error('Webhook URL is required for n8n abilities.');
    }

    const headersField = document.getElementById(`${prefix}_n8n_headers`);
    const payloadField = document.getElementById(`${prefix}_n8n_payload`);
    let headers = {};
    if(headersField && headersField.value.trim()){
      try {
        headers = JSON.parse(headersField.value);
      } catch(err){
        throw new Error('Headers JSON is invalid.');
      }
      if(typeof headers !== 'object' || Array.isArray(headers)){
        throw new Error('Headers JSON must be an object.');
      }
    }

    let defaultPayload = {};
    if(payloadField && payloadField.value.trim()){
      try {
        defaultPayload = JSON.parse(payloadField.value);
      } catch(err){
        throw new Error('Default payload JSON is invalid.');
      }
      if(typeof defaultPayload !== 'object' || Array.isArray(defaultPayload)){
        throw new Error('Default payload JSON must be an object.');
      }
    }

    const timeoutInput = document.getElementById(`${prefix}_n8n_timeout`);
    const timeoutSeconds = timeoutInput ? parseFloat(timeoutInput.value) || 20 : 20;
    const inquiryField = document.getElementById(`${prefix}_n8n_inquiry_field`).value.trim() || 'userInquiry';
    const includeContextEl = document.getElementById(`${prefix}_n8n_include_context`);
    const stripNullsEl = document.getElementById(`${prefix}_n8n_strip_nulls`);

    const cfg = {
      webhook_url: webhookUrl,
      method: document.getElementById(`${prefix}_n8n_method`).value.trim() || 'POST',
      headers,
      default_payload: defaultPayload,
      timeout: timeoutSeconds,
      user_inquiry_field: inquiryField,
      include_context: includeContextEl ? includeContextEl.checked : true,
      strip_nulls: stripNullsEl ? stripNullsEl.checked : true,
    };
    return applyHiddenInstructions(prefix, cfg);
  }
  if(type === 'sidekick'){
    const cfg = {
      agent_slug: document.getElementById(`${prefix}_sidekick_agent`).value.trim(),
    };
    return applyHiddenInstructions(prefix, cfg);
  }
  if(type === 'asana'){
    const projectsField = document.getElementById(`${prefix}_asana_projects`);
    const projectsRaw = projectsField ? projectsField.value.trim() : '';
    let projectsValue = null;
    if(projectsRaw){
      try {
        projectsValue = JSON.parse(projectsRaw);
      } catch(err){
        const lines = projectsRaw.split(/\\r?\\n/).map(line => line.trim()).filter(Boolean);
        if(lines.length){
          projectsValue = lines;
        } else {
          throw new Error('Projects field must be valid JSON (array or object) or newline separated gids.');
        }
      }
      if(typeof projectsValue !== 'object'){
        throw new Error('Projects field must resolve to an array or object.');
      }
    }
    const workspaceInput = document.getElementById(`${prefix}_asana_workspace`);
    const workspace = workspaceInput ? workspaceInput.value.trim() : '';
    const assigneeInput = document.getElementById(`${prefix}_asana_assignee`);
    const assignee = assigneeInput ? assigneeInput.value.trim() : '';
    const maxTasksInput = document.getElementById(`${prefix}_asana_max_tasks`);
    const lookupInput = document.getElementById(`${prefix}_asana_lookup_limit`);
    const maxTasks = maxTasksInput ? parseInt(maxTasksInput.value, 10) : NaN;
    const lookupLimit = lookupInput ? parseInt(lookupInput.value, 10) : NaN;
    const includeCompletedEl = document.getElementById(`${prefix}_asana_include_completed`);
    const defaultActionSelect = document.getElementById(`${prefix}_asana_default_action`);

    const cfg = {};
    if(projectsValue){ cfg.projects = projectsValue; }
    if(workspace){ cfg.workspace_gid = workspace; }
    if(assignee){ cfg.default_assignee = assignee; }
    if(!Number.isNaN(maxTasks)){ cfg.max_tasks_per_project = maxTasks; }
    if(!Number.isNaN(lookupLimit)){ cfg.lookup_limit = lookupLimit; }
    cfg.list_include_completed = includeCompletedEl ? includeCompletedEl.checked : false;
    if(defaultActionSelect && defaultActionSelect.value){ cfg.default_action = defaultActionSelect.value; }
    cfg.oauth_provider = 'asana';
    return applyHiddenInstructions(prefix, cfg);
  }
  if(type === 'mcp'){
    const providerSelect = document.getElementById(`${prefix}_mcp_provider`);
    const provider = providerSelect ? providerSelect.value : 'generic';
    const serverUrlInput = document.getElementById(`${prefix}_mcp_server_url`);
    const serverUrl = serverUrlInput ? serverUrlInput.value.trim() : '';
    if(provider !== 'perplexity' && !serverUrl){
      throw new Error('Server URL is required for MCP abilities.');
    }
    const apiKey = document.getElementById(`${prefix}_mcp_api_key`).value.trim();
    const apiKeyName = document.getElementById(`${prefix}_mcp_api_key_name`).value.trim();
    const namespace = document.getElementById(`${prefix}_mcp_namespace`).value.trim();
    const toolNameInput = document.getElementById(`${prefix}_mcp_tool_name`);
    const toolName = toolNameInput ? toolNameInput.value.trim() : '';
    const modelInput = document.getElementById(`${prefix}_mcp_model`);
    const model = modelInput ? modelInput.value.trim() : '';
    const schemaText = document.getElementById(`${prefix}_mcp_schema`).value.trim();
    let parameters = {};
    if(schemaText){
      try {
        parameters = JSON.parse(schemaText);
      } catch (err) {
        throw new Error('Parameters JSON Schema is invalid JSON.');
      }
    }
    const cfg = { provider, parameters };
    if(serverUrl) cfg.server_url = serverUrl;
    if(apiKey) cfg.api_key = apiKey;
    if(apiKeyName) cfg.api_key_name = apiKeyName;
    if(namespace) cfg.namespace = namespace;
    if(toolName) cfg.tool_name = toolName;
    if(model) cfg.model = model;
    Object.keys(cfg).forEach(key => { if(cfg[key] === undefined || cfg[key] === '') delete cfg[key]; });
    return applyHiddenInstructions(prefix, cfg);
  }
  return applyHiddenInstructions(prefix, {});
}

async function refreshTools(){
  const search = document.getElementById('searchInput').value.trim();
  const type = document.getElementById('typeFilter').value;
  const scope = document.getElementById('scopeFilter').value;
  const clientSelect = document.getElementById('clientFilter');
  const clientId = clientSelect ? clientSelect.value : '';
  const grid = document.getElementById('toolsGrid');
  grid.innerHTML = '';

  if(scope === 'client' && !clientId){
    grid.innerHTML = '<div class="col-span-full text-sm text-dark-text-secondary">Select a client to view client-scoped abilities.</div>';
    return;
  }

  const qs = new URLSearchParams();
  if(search) qs.set('search', search);
  if(type) qs.set('type', type);
  if(scope) qs.set('scope', scope);
  if(clientId) qs.set('client_id', clientId);

  let data = [];
  try{
    const query = qs.toString();
    const url = `${ADMIN_TOOLS_BASE}${query ? `?${query}` : ''}`;
    data = await fetchJSON(url);
  }catch(err){
    grid.innerHTML = `<div class="col-span-full text-sm text-brand-salmon">Failed to load abilities: ${err.message}</div>`;
    return;
  }

  if(!Array.isArray(data) || data.length === 0){
    grid.innerHTML = '<div class="col-span-full text-sm text-dark-text-secondary">No abilities found for the current filters.</div>';
    return;
  }

  Object.keys(toolsCache).forEach(k => delete toolsCache[k]);

  for(const t of data){
    toolsCache[t.id] = t;
    const card = document.createElement('div');
    card.className = 'bg-dark-surface border border-dark-border rounded p-4 flex gap-3 items-start';
    const icon = document.createElement('img');
    icon.src = t.icon_url || '/static/images/ability-default.png';
    icon.className = 'w-10 h-10 rounded';
    const body = document.createElement('div');
    body.className = 'flex-1';
    body.innerHTML = `<div class="flex items-center gap-2"><span class="text-dark-text font-semibold">${t.name}</span><span class="text-xs px-2 py-0.5 rounded border border-dark-border text-dark-text-secondary">${t.type}</span><span class="text-xs px-2 py-0.5 rounded border border-dark-border text-dark-text-secondary">${t.scope}</span></div><div class="text-sm text-dark-text-secondary mt-1">${t.description||''}</div>`;
    const actions = document.createElement('div');
    actions.innerHTML = `
      <div class="flex flex-col gap-2">
        <button class="text-sm text-brand-teal" onclick="openEditToolModal('${t.id}')">Edit</button>
        <button class="text-sm text-brand-salmon" onclick="deleteTool('${t.id}', '${t.scope}', '${t.client_id || ''}')">Remove</button>
      </div>`;
    card.appendChild(icon);
    card.appendChild(body);
    card.appendChild(actions);
    grid.appendChild(card);
  }
}

async function createTool(){
  const name = document.getElementById('ct_name').value.trim();
  const slug = document.getElementById('ct_slug').value.trim();
  const description = document.getElementById('ct_desc').value.trim();
  const type = document.getElementById('ct_type').value;
  const scope = document.getElementById('ct_scope').value;
  const icon_url = document.getElementById('ct_icon').value.trim();
  const clientSelect = document.getElementById('ct_client_id');
  const clientId = clientSelect ? clientSelect.value : '';
  let config = {};
  try{
    config = buildConfigFromForm('ct', type);
  }catch(err){
    alert(err.message);
    return;
  }
  if(scope === 'client' && !clientId){
    alert('Select a client for client-scoped abilities.');
    return;
  }
  const body = { name, slug, description, type, scope, icon_url, config, enabled: true };
  if(scope === 'client'){
    body.client_id = clientId;
  }
  const response = await fetch(ADMIN_TOOLS_BASE, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(body)
  });
  if(response.ok){
    closeCreateToolModal();
    await refreshTools();
  } else {
    const errText = await response.text();
    alert(errText || 'Failed to create ability');
  }
}

async function deleteTool(id, scope, clientId){
  const qs = scope === 'client' && clientId ? `?client_id=${encodeURIComponent(clientId)}` : '';
  const response = await fetch(`${ADMIN_TOOLS_BASE}/${id}${qs}`, { method: 'DELETE', credentials: 'include' });
  if(response.ok){
    await refreshTools();
  } else {
    const errText = await response.text();
    alert(errText || 'Failed to delete ability');
  }
}

function openEditToolModal(id){
  const tool = toolsCache[id];
  if(!tool){
    alert('Unable to load ability details.');
    return;
  }
  editingToolId = id;
  document.getElementById('et_name').value = tool.name || '';
  document.getElementById('et_slug').value = tool.slug || '';
  document.getElementById('et_desc').value = tool.description || '';
  document.getElementById('et_icon').value = tool.icon_url || '';
  document.getElementById('et_type').value = tool.type || 'mcp';
  document.getElementById('et_scope').value = tool.scope || 'client';
  document.getElementById('et_enabled').checked = tool.enabled !== false;
  const clientSelect = document.getElementById('et_client_id');
  if(clientSelect){ clientSelect.value = tool.client_id || ''; }
  handleScopeChange('et');
  renderTypeFields('et', tool.type || 'mcp', tool.config || {});
  const providerSelect = document.getElementById('et_mcp_provider');
  if(providerSelect){ togglePerplexityClientPanel('et', providerSelect.value === 'perplexity'); }
  if(tool.type === 'asana'){
    loadAsanaStatus('et');
  }
  const inlineClientSelect = document.getElementById('et_perplexity_client_select');
  const filterSelect = document.getElementById('clientFilter');
  if(inlineClientSelect && filterSelect && filterSelect.value){ inlineClientSelect.value = filterSelect.value; loadPerplexityClientKey('et'); }
  document.getElementById('editToolModal').classList.remove('hidden');
  document.getElementById('editToolModal').classList.add('flex');
}

async function updateTool(){
  if(!editingToolId){
    alert('No ability selected for update.');
    return;
  }
  const tool = toolsCache[editingToolId];
  const name = document.getElementById('et_name').value.trim();
  const description = document.getElementById('et_desc').value.trim();
  const icon_url = document.getElementById('et_icon').value.trim();
  const enabled = document.getElementById('et_enabled').checked;
  let config = {};
  try{
    config = buildConfigFromForm('et', tool.type);
  }catch(err){
    alert(err.message);
    return;
  }
  const payload = { name, description, icon_url, config, enabled };
  const clientFilter = document.getElementById('clientFilter');
  const inlineClientSelect = document.getElementById('et_perplexity_client_select');
  const selectedClientId = (clientFilter && clientFilter.value) ? clientFilter.value : (inlineClientSelect ? inlineClientSelect.value : '');
  const clientId = tool.scope === 'client' ? (tool.client_id || selectedClientId || '') : selectedClientId || '';
  const providerEl = document.getElementById('et_mcp_provider');
  const provider = providerEl ? providerEl.value : (tool.config && tool.config.provider ? tool.config.provider : 'generic');
  if(tool.type === 'mcp' && provider === 'perplexity' && clientId){
    const keyInput = document.getElementById('et_mcp_client_api_key');
    if(keyInput){
      try {
        await savePerplexityClientKey(clientId, keyInput.value.trim());
      } catch (err) {
        console.error('Failed to store Perplexity API key', err);
        alert('Saved ability changes but failed to persist the Perplexity API key.');
      }
    }
  } else if (tool.type === 'mcp' && provider === 'perplexity' && !clientId) {
    alert('Ability updated. Reminder: select a client to store the Perplexity API key.');
  }
  const clientIdForPatch = tool.scope === 'client' ? (tool.client_id || selectedClientId || '') : '';
  const qs = clientIdForPatch ? `?client_id=${encodeURIComponent(clientIdForPatch)}` : '';
  const response = await fetch(`${ADMIN_TOOLS_BASE}/${editingToolId}${qs}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(payload)
  });
  if(response.ok){
    closeEditToolModal();
    await refreshTools();
  } else {
    const errText = await response.text();
    alert(errText || 'Failed to update ability');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const clientSelect = document.getElementById('clientFilter');
  if(clientSelect){
    const defaultClient = clientSelect.dataset.default;
    if(defaultClient && !clientSelect.value){
      clientSelect.value = defaultClient;
    }
  }
  handleScopeChange('ct');
  renderTypeFields('ct', document.getElementById('ct_type').value);
  refreshTools();
});
</script>
{% endblock %}
