<!-- Step 5: Knowledge Base -->
<div class="space-y-8">
    <div class="text-center space-y-3">
        <h1 class="text-4xl md:text-5xl font-light text-white">
            Give <span class="text-brand-teal" x-text="stepData.name || 'your sidekick'"></span> some knowledge
        </h1>
        <p class="text-dark-text-secondary text-lg">
            Upload documents or add websites for your sidekick to learn from
        </p>
    </div>

    <div class="max-w-xl mx-auto space-y-6">
        <!-- File Upload Zone -->
        <div
            @dragover.prevent="$el.classList.add('dragover')"
            @dragleave="$el.classList.remove('dragover')"
            @drop.prevent="handleFileDrop($event)"
            @click="$refs.fileInput.click()"
            class="drop-zone">
            <input
                type="file"
                x-ref="fileInput"
                @change="handleFileSelect($event)"
                accept=".pdf,.doc,.docx,.txt,.md,.srt"
                multiple
                class="hidden"
            />
            <svg class="w-12 h-12 mx-auto text-dark-text-secondary mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <p class="text-white font-medium">Drop files here or click to upload</p>
            <p class="text-sm text-dark-text-secondary mt-1">PDF, DOC, DOCX, TXT, MD (max 100MB)</p>
        </div>

        <!-- Website URL Input -->
        <div class="flex gap-3">
            <input
                type="url"
                x-model="websiteUrl"
                @keyup.enter="addWebsite()"
                placeholder="https://example.com/docs"
                class="wizard-input flex-1 text-base"
            />
            <button
                @click="addWebsite()"
                :disabled="!websiteUrl"
                class="btn-wizard-secondary whitespace-nowrap">
                Add Site
            </button>
        </div>

        <!-- Pending Documents List -->
        <div x-show="pendingDocuments.length > 0" class="space-y-3">
            <p class="text-sm text-dark-text-secondary">Your Knowledge Base:</p>
            <div class="glass-container rounded-xl divide-y divide-white/10">
                <template x-for="doc in pendingDocuments" :key="doc.id">
                    <div class="flex items-center gap-3 p-4">
                        <!-- Icon -->
                        <div class="w-10 h-10 rounded-lg bg-dark-elevated flex items-center justify-center flex-shrink-0">
                            <svg x-show="doc.source_type === 'file'" class="w-5 h-5 text-brand-teal" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                            </svg>
                            <svg x-show="doc.source_type === 'website'" class="w-5 h-5 text-brand-orange" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                            </svg>
                        </div>

                        <!-- Info -->
                        <div class="flex-1 min-w-0">
                            <p class="text-white truncate text-sm" x-text="doc.source_name"></p>
                            <p x-show="doc.pages_crawled" class="text-xs text-dark-text-secondary" x-text="`${doc.pages_crawled} pages`"></p>
                        </div>

                        <!-- Status Badge -->
                        <span :class="{
                            'status-pending': doc.status === 'pending',
                            'status-processing': doc.status === 'processing',
                            'status-ready': doc.status === 'ready',
                            'status-error': doc.status === 'error'
                        }" class="status-badge">
                            <svg x-show="doc.status === 'processing'" class="w-3 h-3 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <svg x-show="doc.status === 'ready'" class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                            <svg x-show="doc.status === 'error'" class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                            <span x-text="doc.status.charAt(0).toUpperCase() + doc.status.slice(1)"></span>
                        </span>

                        <!-- Remove Button -->
                        <button
                            @click="removeDocument(doc.id)"
                            class="text-dark-text-secondary hover:text-red-400 transition p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Processing Status -->
        <div x-show="processingCount > 0" class="text-center text-sm text-brand-teal">
            <span class="inline-flex items-center gap-2">
                <svg class="w-4 h-4 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Processing <span x-text="processingCount"></span> item<span x-show="processingCount !== 1">s</span>...
            </span>
            <p class="text-dark-text-secondary text-xs mt-1">
                You can continue while processing happens in the background
            </p>
        </div>

        <!-- Skip Option -->
        <p class="text-center text-sm text-dark-text-secondary">
            You can skip this step and add knowledge later from your dashboard
        </p>
    </div>
</div>

<script>
    // Extend wizardController with knowledge methods
    document.addEventListener('alpine:init', () => {
        const originalController = window.wizardControllerConfig || {};

        Object.assign(originalController, {
            websiteUrl: '',
            processingCount: 0,

            async handleFileDrop(event) {
                const files = event.dataTransfer.files;
                for (const file of files) {
                    await this.uploadFile(file);
                }
            },

            async handleFileSelect(event) {
                const files = event.target.files;
                for (const file of files) {
                    await this.uploadFile(file);
                }
                event.target.value = '';
            },

            async uploadFile(file) {
                if (!this.sessionId) return;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const token = localStorage.getItem('admin_token');
                    const response = await fetch(`/api/v1/wizard/sessions/${this.sessionId}/documents`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.pendingDocuments.push({
                            id: result.pending_doc_id,
                            source_type: 'file',
                            source_name: file.name,
                            status: result.status
                        });
                        this.startPolling();
                    }
                } catch (e) {
                    console.error('Failed to upload file:', e);
                }
            },

            async addWebsite() {
                if (!this.websiteUrl || !this.sessionId) return;

                const url = this.websiteUrl;
                this.websiteUrl = '';

                const formData = new FormData();
                formData.append('url', url);

                try {
                    const token = localStorage.getItem('admin_token');
                    const response = await fetch(`/api/v1/wizard/sessions/${this.sessionId}/websites`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.pendingDocuments.push({
                            id: result.pending_doc_id,
                            source_type: 'website',
                            source_name: url,
                            status: result.status
                        });
                        this.startPolling();
                    }
                } catch (e) {
                    console.error('Failed to add website:', e);
                }
            },

            async removeDocument(docId) {
                try {
                    const token = localStorage.getItem('admin_token');
                    await fetch(`/api/v1/wizard/sessions/${this.sessionId}/documents/${docId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    this.pendingDocuments = this.pendingDocuments.filter(d => d.id !== docId);
                } catch (e) {
                    console.error('Failed to remove document:', e);
                }
            },

            startPolling() {
                if (this.knowledgePolling) return;

                this.knowledgePolling = setInterval(async () => {
                    await this.pollKnowledgeStatus();
                }, 3000);
            },

            async pollKnowledgeStatus() {
                if (!this.sessionId) return;

                try {
                    const token = localStorage.getItem('admin_token');
                    const response = await fetch(`/api/v1/wizard/sessions/${this.sessionId}/knowledge-status`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const status = await response.json();
                        this.pendingDocuments = status.items;
                        this.processingCount = status.processing_count;

                        if (status.all_complete && this.knowledgePolling) {
                            clearInterval(this.knowledgePolling);
                            this.knowledgePolling = null;
                        }
                    }
                } catch (e) {
                    console.error('Failed to poll knowledge status:', e);
                }
            }
        });

        window.wizardControllerConfig = originalController;
    });
</script>
