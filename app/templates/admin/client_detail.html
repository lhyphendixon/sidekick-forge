{% extends "admin/base.html" %}

{% block title %}{{ client.name }} - Client Configuration{% endblock %}

{% block extra_head %}
<!-- Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-dark-text flex items-center">
                <a href="/admin/clients" class="text-dark-text-secondary hover:text-brand-teal mr-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                {{ client.name }}
            </h1>
            <p class="text-dark-text-secondary mt-1">Client ID: {{ client.id }}</p>
        </div>
        <div class="flex items-center space-x-3">
            <span class="px-3 py-1 rounded-full text-sm font-medium {% if client.status == 'active' %}bg-brand-teal/20 text-brand-teal{% else %}bg-dark-elevated text-dark-text-secondary{% endif %}">
                {{ client.status|capitalize }}
            </span>
            <button type="submit" form="clientForm" class="btn-primary font-medium py-2 px-4 rounded-lg flex items-center transition-all">
                <i class="bi bi-save mr-2"></i>Save Changes
            </button>
            <button onclick="syncAgents()" class="btn-secondary font-medium py-2 px-4 rounded-lg flex items-center transition-all">
                <i class="bi bi-arrow-repeat mr-2"></i>Sync Sidekicks
            </button>
        </div>
    </div>

    {% set channels = client.get('additional_settings', {}).get('channels', {}) if client.get('additional_settings') else {} %}
    {% set telegram = channels.get('telegram', {}) %}

    <form id="clientForm" action="/admin/clients/{{ client.id }}/update" method="POST">
        <!-- Basic Information -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text">Basic Information</h5>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Client Name</label>
                        <input type="text" id="clientName" name="name" value="{{ client.name }}" required
                               class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Domain</label>
                        <input type="text" id="clientDomain" name="domain" value="{{ client.domain or '' }}" 
                               placeholder="e.g., myclient.com"
                               class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-dark-text mb-2">Description</label>
                    <textarea id="clientDescription" name="description" rows="2"
                              class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">{{ client.description or '' }}</textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="clientActive" {% if client.status == 'active' %}checked{% endif %}
                           class="w-4 h-4 text-brand-teal border-dark-border rounded focus:ring-brand-teal">
                    <label for="clientActive" class="ml-2 text-sm text-dark-text">
                        Client is active
                    </label>
                </div>
            </div>
        </div>

        {% if not user.is_adventurer_only %}
        <!-- Supabase Configuration (hidden for Adventurer users) -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text">Supabase Configuration</h5>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-dark-text mb-2">Supabase URL</label>
                    <input type="url" id="supabaseUrl" name="supabase_url" value="{{ client.settings.get('supabase', {}).get('url', '') }}" required
                           class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Anonymous Key</label>
                        <div class="relative">
                            <input type="password" id="supabaseAnonKey" name="supabase_anon_key"
                                   value="{{ client.settings.get('supabase', {}).get('anon_key', '') }}" required
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('supabaseAnonKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Service Role Key</label>
                        <div class="relative">
                            <input type="password" id="supabaseServiceKey" name="supabase_service_key"
                                   value="{{ client.settings.get('supabase', {}).get('service_role_key', '') }}" required
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('supabaseServiceKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LiveKit Configuration (hidden for Adventurer users) -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text">LiveKit Configuration</h5>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-dark-text mb-2">LiveKit Server URL</label>
                    <input type="url" id="livekitUrl" name="livekit_server_url" value="{{ client.settings.get('livekit', {}).get('server_url', '') }}" required
                           class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">API Key</label>
                        <input type="text" id="livekitApiKey" name="livekit_api_key" value="{{ client.settings.get('livekit', {}).get('api_key', '') }}" required
                               class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">API Secret</label>
                        <div class="relative">
                            <input type="password" id="livekitApiSecret" name="livekit_api_secret"
                                   value="{{ client.settings.get('livekit', {}).get('api_secret', '') }}" required
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('livekitApiSecret')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Channels -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text">Channels</h5>
            </div>
            <div class="p-6">
                {% set telegram_enabled = telegram.get('enabled') %}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label for="telegramEnabled"
                           class="block cursor-pointer rounded-lg border transition-all duration-200 bg-dark-elevated px-4 py-3 flex items-center space-x-3
                           {% if telegram_enabled %}border-brand-teal shadow-[0_0_16px_rgba(45,212,191,0.35)]{% else %}border-dark-border hover:border-brand-teal/60{% endif %}">
                        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-sky-500/20 border border-sky-400/40">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" class="h-6 w-6 text-sky-400 fill-current">
                                <path d="M120 0C53.8 0 0 53.8 0 120s53.8 120 120 120 120-53.8 120-120S186.2 0 120 0zm58.3 83.7l-19.6 92.4c-1.5 6.7-5.7 8.3-11.5 5.2l-31.8-23.5-15.3 14.8c-1.7 1.7-3.1 3.1-6.3 3.1l2.3-32.6 59.4-53.6c2.6-2.3-0.6-3.6-4-1.3l-73.5 46.2-31.7-9.9c-6.9-2.2-7.1-6.9 1.5-10.2l124.1-47.8c5.7-2.1 10.7 1.3 8.9 10.1z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-semibold text-dark-text">Telegram</span>
                                <span class="text-[10px] px-2 py-0.5 rounded-full {% if telegram_enabled %}bg-brand-teal/20 text-brand-teal{% else %}bg-dark-elevated text-dark-text-secondary{% endif %}">
                                    {% if telegram_enabled %}Enabled{% else %}Disabled{% endif %}
                                </span>
                            </div>
                            <p class="text-xs text-dark-text-secondary mt-1">Toggle availability for sidekicks in this workspace. Bot tokens are set per sidekick.</p>
                        </div>
                        <input type="checkbox" id="telegramEnabled" name="telegram_enabled"
                               {% if telegram_enabled %}checked{% endif %}
                               class="w-4 h-4 text-brand-teal border-dark-border rounded focus:ring-brand-teal">
                    </label>
                </div>
            </div>
        </div>

        {% if user.is_adventurer_only %}
        <!-- Usage & Quotas (Adventurer only) -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text flex items-center">
                    <svg class="h-5 w-5 text-brand-teal mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Monthly Usage
                </h5>
                <p class="text-sm text-dark-text-secondary mt-1">Your usage resets on the 1st of each month</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Voice Minutes -->
                    <div class="bg-dark-elevated rounded-lg p-4 border border-dark-border">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <svg class="h-5 w-5 text-brand-teal mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                                </svg>
                                <span class="text-sm font-medium text-dark-text">Voice Minutes</span>
                            </div>
                            <span class="text-xs text-dark-text-secondary">{{ usage.voice.minutes_used if usage else 0 }} / {{ usage.voice.minutes_limit if usage else 100 }} min</span>
                        </div>
                        <div class="w-full bg-dark-border rounded-full h-2.5">
                            <div class="bg-brand-teal h-2.5 rounded-full transition-all duration-300" style="width: {{ usage.voice.percent_used if usage else 0 }}%"></div>
                        </div>
                        <p class="text-xs text-dark-text-secondary mt-2">{{ usage.voice.remaining if usage else 100 }} minutes remaining</p>
                    </div>

                    <!-- Text Messages -->
                    <div class="bg-dark-elevated rounded-lg p-4 border border-dark-border">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <svg class="h-5 w-5 text-brand-orange mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                                <span class="text-sm font-medium text-dark-text">Text Messages</span>
                            </div>
                            <span class="text-xs text-dark-text-secondary">{{ usage.text.used if usage else 0 }} / {{ usage.text.limit if usage else 1000 }}</span>
                        </div>
                        <div class="w-full bg-dark-border rounded-full h-2.5">
                            <div class="bg-brand-orange h-2.5 rounded-full transition-all duration-300" style="width: {{ usage.text.percent_used if usage else 0 }}%"></div>
                        </div>
                        <p class="text-xs text-dark-text-secondary mt-2">{{ usage.text.remaining if usage else 1000 }} messages remaining</p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-dark-elevated/50 rounded-lg border border-dark-border">
                    <div class="flex items-start">
                        <svg class="h-5 w-5 text-brand-teal mr-3 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="text-sm text-dark-text-secondary">
                            <p>Your Adventurer plan includes <strong class="text-dark-text">100 voice minutes</strong> and <strong class="text-dark-text">1,000 text messages</strong> per month.</p>
                            <p class="mt-2">Need more? <a href="/pricing" class="text-brand-teal hover:underline">Upgrade to Champion</a> for higher limits.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Platform Configuration Info (Adventurer only) -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text flex items-center">
                    <svg class="h-5 w-5 text-green-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    AI Configuration
                </h5>
            </div>
            <div class="p-6">
                <div class="flex items-start p-4 bg-green-500/10 border border-green-500/30 rounded-lg mb-4">
                    <svg class="h-5 w-5 text-green-500 mr-3 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <div>
                        <p class="text-sm text-green-400 font-medium">All set! Your AI services are automatically configured.</p>
                        <p class="text-xs text-green-300/80 mt-1">You're using Sidekick Forge's managed AI infrastructure - no API keys needed.</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-3 bg-dark-elevated rounded-lg border border-dark-border">
                        <div class="text-xs text-dark-text-secondary mb-1">Language Model</div>
                        <div class="text-sm font-medium text-dark-text">Cerebras GLM</div>
                    </div>
                    <div class="text-center p-3 bg-dark-elevated rounded-lg border border-dark-border">
                        <div class="text-xs text-dark-text-secondary mb-1">Voice</div>
                        <div class="text-sm font-medium text-dark-text">Cartesia</div>
                    </div>
                    <div class="text-center p-3 bg-dark-elevated rounded-lg border border-dark-border">
                        <div class="text-xs text-dark-text-secondary mb-1">Embeddings</div>
                        <div class="text-sm font-medium text-dark-text">SiliconFlow</div>
                    </div>
                    <div class="text-center p-3 bg-dark-elevated rounded-lg border border-dark-border">
                        <div class="text-xs text-dark-text-secondary mb-1">Reranking</div>
                        <div class="text-sm font-medium text-dark-text">Qwen3</div>
                    </div>
                </div>

                <details class="mt-4">
                    <summary class="text-sm text-dark-text-secondary cursor-pointer hover:text-brand-teal">
                        Want to use your own API keys? (Advanced)
                    </summary>
                    <div class="mt-3 p-4 bg-dark-elevated rounded-lg border border-dark-border">
                        <p class="text-sm text-dark-text-secondary mb-3">
                            You can optionally provide your own API keys to use your own accounts. This bypasses the monthly quota limits.
                        </p>
        {% endif %}

        <!-- API Keys -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6 {% if user.is_adventurer_only %}border-0 shadow-none bg-transparent p-0{% endif %}">
            {% if not user.is_adventurer_only %}
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text">API Keys</h5>
            </div>
            {% endif %}
            <div class="{% if not user.is_adventurer_only %}p-6{% endif %}">
                <!-- LLM Providers -->
                <h6 class="text-md font-medium text-dark-text mb-4">LLM Providers</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">OpenAI API Key</label>
                        <div class="relative">
                            <input type="password" id="openaiKey" name="openai_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('openai_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('openaiKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Groq API Key</label>
                        <div class="relative">
                            <input type="password" id="groqKey" name="groq_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('groq_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('groqKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Cerebras API Key</label>
                        <div class="relative">
                            <input type="password" id="cerebrasKey" name="cerebras_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('cerebras_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('cerebrasKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">DeepInfra API Key</label>
                        <div class="relative">
                            <input type="password" id="deepinfraKey" name="deepinfra_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('deepinfra_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('deepinfraKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Replicate API Key</label>
                        <div class="relative">
                            <input type="password" id="replicateKey" name="replicate_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('replicate_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('replicateKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Voice Providers -->
                <h6 class="text-md font-medium text-dark-text mb-4">Voice Providers</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Deepgram API Key</label>
                        <div class="relative">
                            <input type="password" id="deepgramKey" name="deepgram_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('deepgram_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('deepgramKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">ElevenLabs API Key</label>
                        <div class="relative">
                            <input type="password" id="elevenlabsKey" name="elevenlabs_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('elevenlabs_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('elevenlabsKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Cartesia API Key</label>
                        <div class="relative">
                            <input type="password" id="cartesiaKey" name="cartesia_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('cartesia_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('cartesiaKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Speechify API Key</label>
                        <div class="relative">
                            <input type="password" id="speechifyKey" name="speechify_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('speechify_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('speechifyKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Avatar/Video Providers -->
                <h6 class="text-md font-medium text-dark-text mb-4">Avatar/Video Providers</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Bithuman API Secret</label>
                        <div class="relative">
                            <input type="password" id="bithumanKey" name="bithuman_api_secret"
                                   value="{{ client.settings.get('api_keys', {}).get('bithuman_api_secret') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('bithumanKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <p class="text-xs text-dark-text-secondary mt-1">Required for Bithuman video avatars</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Beyond Presence API Key</label>
                        <div class="relative">
                            <input type="password" id="beyKey" name="bey_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('bey_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('beyKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <p class="text-xs text-dark-text-secondary mt-1">Required for Beyond Presence video avatars</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">HeyGen LiveAvatar API Key</label>
                        <div class="relative">
                            <input type="password" id="liveavatarKey" name="liveavatar_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('liveavatar_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('liveavatarKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <p class="text-xs text-dark-text-secondary mt-1">Required for HeyGen LiveAvatar video avatars</p>
                    </div>
                </div>

                <!-- Embedding & Reranking Providers -->
                <h6 class="text-md font-medium text-dark-text mb-4">Embedding & Reranking Providers</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Novita API Key</label>
                        <div class="relative">
                            <input type="password" id="novitaKey" name="novita_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('novita_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('novitaKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Cohere API Key</label>
                        <div class="relative">
                            <input type="password" id="cohereKey" name="cohere_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('cohere_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('cohereKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">SiliconFlow API Key</label>
                        <div class="relative">
                            <input type="password" id="siliconflowKey" name="siliconflow_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('siliconflow_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('siliconflowKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Jina API Key</label>
                        <div class="relative">
                            <input type="password" id="jinaKey" name="jina_api_key"
                                   value="{{ client.settings.get('api_keys', {}).get('jina_api_key') or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('jinaKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Firecrawl API Key</label>
                        <div class="relative">
                            <input type="password" id="firecrawlKey" name="firecrawl_api_key"
                                   value="{{ client.firecrawl_api_key or '' }}"
                                   class="w-full px-3 py-2 pr-10 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <button type="button" onclick="togglePassword('firecrawlKey')"
                                    class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <p class="mt-1 text-xs text-dark-text-secondary">Required for scraping websites in Knowledge Base. Get one at <a href="https://firecrawl.dev" target="_blank" class="text-brand-teal hover:underline">firecrawl.dev</a></p>
                    </div>
                </div>
            </div>
        </div>

        {% if user.is_adventurer_only %}
                    </div>
                </details>
            </div>
        </div>
        {% endif %}

        {% if not user.is_adventurer_only %}
        <!-- Embedding Configuration -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text">Embedding Configuration</h5>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Embedding Provider</label>
                        <select id="embeddingProvider" name="embedding_provider"
                                class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <option value="local" {% if client.settings.get('embedding', {}).get('provider') in ['local', 'on-prem', 'bge-local', 'bge', 'bge-m3'] %}selected{% endif %}>Local (BGE-M3 On-Prem)</option>
                            <option value="openai" {% if client.settings.get('embedding', {}).get('provider') == 'openai' %}selected{% endif %}>OpenAI</option>
                            <option value="deepinfra" {% if client.settings.get('embedding', {}).get('provider') == 'deepinfra' %}selected{% endif %}>DeepInfra</option>
                            <option value="novita" {% if client.settings.get('embedding', {}).get('provider') == 'novita' %}selected{% endif %}>Novita AI</option>
                            <option value="siliconflow" {% if client.settings.get('embedding', {}).get('provider') == 'siliconflow' %}selected{% endif %}>SiliconFlow</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Document Embedding Model</label>
                        <select id="documentEmbeddingModel" name="document_embedding_model"
                                class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <!-- Local On-Prem Model -->
                            <option value="bge-m3" {% if client.settings.get('embedding', {}).get('document_model') == 'bge-m3' %}selected{% endif %} data-provider="local">BGE-M3 (1024 dimensions, On-Prem)</option>
                            <!-- OpenAI Models -->
                            <option value="text-embedding-3-small" {% if client.settings.get('embedding', {}).get('document_model') == 'text-embedding-3-small' %}selected{% endif %} data-provider="openai">text-embedding-3-small (OpenAI)</option>
                            <option value="text-embedding-3-large" {% if client.settings.get('embedding', {}).get('document_model') == 'text-embedding-3-large' %}selected{% endif %} data-provider="openai">text-embedding-3-large (OpenAI)</option>
                            <!-- DeepInfra/SiliconFlow/Novita Models -->
                            <option value="Qwen/Qwen2.5-72B-Instruct" {% if client.settings.get('embedding', {}).get('document_model') == 'Qwen/Qwen2.5-72B-Instruct' %}selected{% endif %} data-provider="deepinfra">Qwen/Qwen2.5-72B-Instruct</option>
                            <option value="Qwen/Qwen3-Embedding-0.6B" {% if client.settings.get('embedding', {}).get('document_model') == 'Qwen/Qwen3-Embedding-0.6B' %}selected{% endif %} data-provider="deepinfra,novita,siliconflow">Qwen3-Embedding-0.6B (Fastest)</option>
                            <option value="Qwen/Qwen3-Embedding-4B" {% if client.settings.get('embedding', {}).get('document_model') == 'Qwen/Qwen3-Embedding-4B' %}selected{% endif %} data-provider="deepinfra,novita,siliconflow">Qwen3-Embedding-4B (Balanced)</option>
                            <option value="Qwen/Qwen3-Embedding-8B" {% if client.settings.get('embedding', {}).get('document_model') == 'Qwen/Qwen3-Embedding-8B' %}selected{% endif %} data-provider="deepinfra,novita,siliconflow">Qwen3-Embedding-8B (Highest Quality)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">Conversation Embedding Model</label>
                        <select id="conversationEmbeddingModel" name="conversation_embedding_model"
                                class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <!-- Local On-Prem Model -->
                            <option value="bge-m3" {% if client.settings.get('embedding', {}).get('conversation_model') == 'bge-m3' %}selected{% endif %} data-provider="local">BGE-M3 (1024 dimensions, On-Prem)</option>
                            <!-- OpenAI Models -->
                            <option value="text-embedding-3-small" {% if client.settings.get('embedding', {}).get('conversation_model') == 'text-embedding-3-small' %}selected{% endif %} data-provider="openai">text-embedding-3-small (OpenAI)</option>
                            <option value="text-embedding-3-large" {% if client.settings.get('embedding', {}).get('conversation_model') == 'text-embedding-3-large' %}selected{% endif %} data-provider="openai">text-embedding-3-large (OpenAI)</option>
                            <!-- DeepInfra/SiliconFlow/Novita Models -->
                            <option value="Qwen/Qwen2.5-72B-Instruct" {% if client.settings.get('embedding', {}).get('conversation_model') == 'Qwen/Qwen2.5-72B-Instruct' %}selected{% endif %} data-provider="deepinfra">Qwen/Qwen2.5-72B-Instruct</option>
                            <option value="Qwen/Qwen3-Embedding-0.6B" {% if client.settings.get('embedding', {}).get('conversation_model') == 'Qwen/Qwen3-Embedding-0.6B' %}selected{% endif %} data-provider="deepinfra,novita,siliconflow">Qwen3-Embedding-0.6B (Fastest)</option>
                            <option value="Qwen/Qwen3-Embedding-4B" {% if client.settings.get('embedding', {}).get('conversation_model') == 'Qwen/Qwen3-Embedding-4B' %}selected{% endif %} data-provider="deepinfra,novita,siliconflow">Qwen3-Embedding-4B (Balanced)</option>
                            <option value="Qwen/Qwen3-Embedding-8B" {% if client.settings.get('embedding', {}).get('conversation_model') == 'Qwen/Qwen3-Embedding-8B' %}selected{% endif %} data-provider="deepinfra,novita,siliconflow">Qwen3-Embedding-8B (Highest Quality)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Embedding Dimension for Qwen Models -->
                <div class="mt-6" id="embeddingDimensionSection" style="display: none;">
                    <label class="block text-sm font-medium text-dark-text mb-2">Embedding Dimension</label>
                    <select id="embeddingDimension" name="embedding_dimension" 
                            class="w-full md:w-1/3 px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                        <option value="">Auto (Model Default)</option>
                        <option value="1024" {% if client.settings.get('embedding', {}).get('dimension') == 1024 %}selected{% endif %}>1024 dimensions</option>
                        <option value="2048" {% if client.settings.get('embedding', {}).get('dimension') == 2048 %}selected{% endif %}>2048 dimensions</option>
                        <option value="4096" {% if client.settings.get('embedding', {}).get('dimension') == 4096 %}selected{% endif %}>4096 dimensions</option>
                    </select>
                    <div class="mt-2 text-xs text-dark-text-secondary">
                        <p><strong>Model Dimension Support:</strong></p>
                        <p>• Qwen3-Embedding-0.6B: Up to 1024 dimensions (recommended: 1024)</p>
                        <p>• Qwen3-Embedding-4B: Up to 2048 dimensions (recommended: 1024 or 2048)</p>
                        <p>• Qwen3-Embedding-8B: Up to 4096 dimensions (recommended: 1024, 2048, or 4096)</p>
                        <p class="mt-1">Lower dimensions = faster processing, smaller storage. Higher dimensions = better accuracy.</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <p class="text-sm text-dark-text-secondary">
                        <i class="bi bi-info-circle mr-1"></i>
                        Make sure you have the appropriate API key configured for your selected embedding provider above.
                    </p>
                </div>
            </div>
        </div>

        <!-- Reranking Configuration -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text">Reranking Configuration</h5>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="rerankEnabled" name="rerank_enabled" 
                               {% if client.settings.get('rerank', {}).get('enabled') %}checked{% endif %}
                               class="w-4 h-4 text-brand-teal border-dark-border rounded focus:ring-brand-teal mr-2">
                        <span class="text-sm font-medium text-dark-text">Enable Reranking</span>
                    </label>
                    <p class="text-sm text-dark-text-secondary mt-1 ml-6">Improve search relevance by reranking results</p>
                </div>
                
                <div id="rerankingOptions" class="{% if not client.settings.get('rerank', {}).get('enabled') %}opacity-50{% endif %}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-dark-text mb-2">Reranking Provider</label>
                            <select id="rerankProvider" name="rerank_provider"
                                    {% if not client.settings.get('rerank', {}).get('enabled') %}disabled{% endif %}
                                    class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                                <option value="none" {% if client.settings.get('rerank', {}).get('provider') == 'none' %}selected{% endif %}>None</option>
                                <option value="local" {% if client.settings.get('rerank', {}).get('provider') in ['local', 'on-prem', 'bge-local', 'bge', 'bge-reranker'] %}selected{% endif %}>Local (BGE-Reranker On-Prem)</option>
                                <option value="siliconflow" {% if client.settings.get('rerank', {}).get('provider') == 'siliconflow' %}selected{% endif %}>SiliconFlow</option>
                                <option value="cohere" {% if client.settings.get('rerank', {}).get('provider') == 'cohere' %}selected{% endif %}>Cohere</option>
                                <option value="jina" {% if client.settings.get('rerank', {}).get('provider') == 'jina' %}selected{% endif %}>Jina</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-dark-text mb-2">Reranking Model</label>
                            <select id="rerankModel" name="rerank_model"
                                    {% if not client.settings.get('rerank', {}).get('enabled') %}disabled{% endif %}
                                    class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                                <!-- Local On-Prem Model -->
                                <option value="bge-reranker-v2-m3" {% if client.settings.get('rerank', {}).get('model') == 'bge-reranker-v2-m3' %}selected{% endif %} data-provider="local">BGE-Reranker-v2-M3 (On-Prem)</option>
                                <!-- SiliconFlow Models -->
                                <option value="Qwen/Qwen3-Reranker-0.6B" {% if client.settings.get('rerank', {}).get('model') == 'Qwen/Qwen3-Reranker-0.6B' %}selected{% endif %} data-provider="siliconflow">Qwen3-Reranker-0.6B (Fastest)</option>
                                <option value="Qwen/Qwen3-Reranker-2B" {% if client.settings.get('rerank', {}).get('model') == 'Qwen/Qwen3-Reranker-2B' %}selected{% endif %} data-provider="siliconflow">Qwen3-Reranker-2B (Balanced)</option>
                                <option value="BAAI/bge-reranker-base" {% if client.settings.get('rerank', {}).get('model') == 'BAAI/bge-reranker-base' %}selected{% endif %} data-provider="siliconflow">BGE Reranker Base</option>
                                <!-- Cohere Models -->
                                <option value="rerank-english-v3.0" {% if client.settings.get('rerank', {}).get('model') == 'rerank-english-v3.0' %}selected{% endif %} data-provider="cohere">Rerank English v3.0</option>
                                <option value="rerank-multilingual-v3.0" {% if client.settings.get('rerank', {}).get('model') == 'rerank-multilingual-v3.0' %}selected{% endif %} data-provider="cohere">Rerank Multilingual v3.0</option>
                                <!-- Jina Models -->
                                <option value="jina-reranker-v2-base-multilingual" {% if client.settings.get('rerank', {}).get('model') == 'jina-reranker-v2-base-multilingual' %}selected{% endif %} data-provider="jina">Jina Reranker v2 Multilingual</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-dark-text mb-2">Top K Results</label>
                            <input type="number" id="rerankTopK" name="rerank_top_k" 
                                   value="{{ client.settings.get('rerank', {}).get('top_k') }}" min="1" max="20"
                                   {% if not client.settings.get('rerank', {}).get('enabled') %}disabled{% endif %}
                                   class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <p class="text-xs text-dark-text-secondary mt-1">Number of results to return after reranking (1-20)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-dark-text mb-2">Rerank Candidates</label>
                            <input type="number" id="rerankCandidates" name="rerank_candidates" 
                                   value="{{ client.settings.get('rerank', {}).get('candidates') }}" min="5" max="50"
                                   {% if not client.settings.get('rerank', {}).get('enabled') %}disabled{% endif %}
                                   class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                            <p class="text-xs text-dark-text-secondary mt-1">Number of candidates to consider for reranking (5-50)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Supertab Voice Paywall Section -->
        <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
            <div class="border-b border-dark-border px-6 py-4">
                <h5 class="text-lg font-semibold text-dark-text flex items-center">
                    <svg class="h-5 w-5 text-emerald-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                    Supertab Voice Paywall
                </h5>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-dark-text mb-2">
                            Supertab Client ID
                        </label>
                        <input type="text" id="supertabClientId" name="supertab_client_id"
                               value="{{ client.supertab_client_id or '' }}"
                               placeholder="client.xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                               class="w-full px-3 py-2 bg-dark-elevated border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <p class="text-xs text-dark-text-secondary mt-1">
                            Found in your <a href="https://business.supertab.co" target="_blank" class="text-emerald-500 hover:underline">Supertab Business Portal</a> under Settings → API Keys
                        </p>
                    </div>

                    <div class="rounded-md bg-dark-elevated/50 border border-dark-border px-4 py-3">
                        <p class="text-sm text-dark-text-secondary">
                            Supertab enables per-session microtransaction paywalls for voice chat. Text chat remains free; users pay or "Put it on my Tab" to access voice.
                        </p>
                        <p class="text-sm text-dark-text-secondary mt-2">
                            The Client ID is shared across all sidekicks. Enable/disable and set pricing per-sidekick in each agent's configuration.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- WordPress Plugin Access -->
    <div class="bg-dark-surface rounded-lg border border-dark-border mb-6">
        <div class="border-b border-dark-border px-6 py-4 flex items-center justify-between">
            <div>
                <h5 class="text-lg font-semibold text-dark-text">WordPress Plugin Access</h5>
                <p class="text-sm text-dark-text-secondary mt-1">
                    Use these values to connect the Sidekick Forge WordPress plugin for this client.
                </p>
            </div>
            <div class="text-sm text-dark-text-secondary">
                Endpoint:
                <span class="font-mono text-dark-text break-all">{{ wordpress_api_endpoint }}</span>
            </div>
        </div>
        <div class="p-6 space-y-6">
            {% if wordpress_message %}
            <div class="bg-brand-teal/10 border border-brand-teal/30 text-brand-teal px-3 py-2 rounded text-sm">
                {{ wordpress_message }}
            </div>
            {% endif %}
            {% if wordpress_error %}
            <div class="bg-brand-salmon/10 border border-brand-salmon/30 text-brand-salmon px-3 py-2 rounded text-sm">
                {{ wordpress_error }}
            </div>
            {% endif %}

            {% if wordpress_sites %}
            <div class="space-y-4">
                {% for site in wordpress_sites %}
                {% set origins = [] %}
                {% if site.metadata %}
                    {% if site.metadata.allowed_origins is defined %}
                        {% set origins = site.metadata.allowed_origins %}
                    {% elif site.metadata.get('allowed_origins') %}
                        {% set origins = site.metadata.get('allowed_origins') %}
                    {% endif %}
                {% endif %}
                <div class="bg-dark-elevated rounded-lg border border-dark-border p-5">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <div class="text-xs uppercase tracking-wide text-dark-text-secondary mb-1">Domain</div>
                            <div class="text-lg font-semibold text-dark-text leading-tight">{{ site.domain }}</div>
                            <div class="text-sm text-dark-text-secondary">{{ site.site_name }}</div>
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                            <form method="post" action="/admin/clients/{{ client.id }}/wordpress-sites/{{ site.id }}/regenerate">
                                <button type="submit" class="px-3 py-1.5 text-sm rounded bg-brand-teal hover:bg-brand-salmon text-white transition-colors">
                                    Regenerate Shared Secret
                                </button>
                            </form>
                            <button type="button" onclick="deleteWordpressSite('{{ site.id }}', '{{ client.id }}')" class="px-3 py-1.5 text-sm rounded bg-red-600 hover:bg-red-700 text-white transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-xs font-medium text-dark-text-secondary mb-1">API Endpoint</label>
                            <div class="font-mono text-sm text-dark-text break-all bg-dark-surface border border-dark-border rounded px-3 py-2">
                                {{ wordpress_api_endpoint }}
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-dark-text-secondary mb-1">Shared Secret</label>
                            <div class="relative">
                                <input type="password" id="wpSecret-{{ site.id }}" value="{{ site.api_secret }}" readonly
                                       class="w-full px-3 py-2 pr-10 bg-dark-surface border border-dark-border text-dark-text rounded-md text-sm font-mono">
                                <button type="button" onclick="togglePassword('wpSecret-{{ site.id }}')"
                                        class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-text-secondary hover:text-dark-text">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="text-xs font-medium text-dark-text-secondary mb-2">Allowed Embed Origins</div>
                        {% if origins %}
                            <div class="flex flex-wrap gap-2">
                                {% for origin in origins %}
                                    <span class="font-mono text-xs bg-dark-surface border border-dark-border rounded px-2 py-1">{{ origin }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-sm text-dark-text-secondary">Not set</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8 border border-dashed border-dark-border rounded-lg bg-dark-elevated">
                <i class="bi bi-wordpress text-dark-text-secondary text-3xl mb-3"></i>
                <p class="text-sm text-dark-text-secondary">No WordPress connections have been created yet.</p>
            </div>
            {% endif %}

            <div class="border-t border-dark-border pt-4">
                <h6 class="text-md font-semibold text-dark-text mb-3">Create WordPress Credentials</h6>
                <div class="bg-dark-elevated border border-dark-border rounded-lg p-4">
                    <form method="post" action="/admin/clients/{{ client.id }}/wordpress-sites" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-dark-text mb-1">Domain</label>
                            <input type="text" name="domain" required placeholder="example.com"
                                   class="w-full px-3 py-2 bg-dark-surface border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-dark-text mb-1">Site Name</label>
                            <input type="text" name="site_name" required placeholder="Marketing Site"
                                   class="w-full px-3 py-2 bg-dark-surface border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-dark-text mb-1">Admin Email</label>
                            <input type="email" name="admin_email" required placeholder="admin@example.com"
                                   class="w-full px-3 py-2 bg-dark-surface border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-dark-text mb-1">Allowed Embed Origins (comma-separated)</label>
                            <input type="text" name="allowed_origins" placeholder="https://your-site.com, https://subdomain.your-site.com"
                                   class="w-full px-3 py-2 bg-dark-surface border border-dark-border text-dark-text rounded-md focus:outline-none focus:ring-2 focus:ring-brand-teal">
                        </div>
                        <div class="md:col-span-3">
                            <button type="submit"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-brand-teal hover:bg-brand-salmon focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-teal">
                                Generate Shared Secret
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// Handle embedding provider change
document.getElementById('embeddingProvider').addEventListener('change', function() {
    updateEmbeddingModels();
});

// Handle embedding model changes to update dimension visibility
document.getElementById('documentEmbeddingModel').addEventListener('change', function() {
    updateDimensionVisibility();
});

document.getElementById('conversationEmbeddingModel').addEventListener('change', function() {
    updateDimensionVisibility();
});

// Handle reranking enable/disable
document.getElementById('rerankEnabled').addEventListener('change', function() {
    const options = document.getElementById('rerankingOptions');
    const inputs = options.querySelectorAll('select, input');
    
    if (this.checked) {
        options.classList.remove('opacity-50');
        inputs.forEach(input => input.disabled = false);
    } else {
        options.classList.add('opacity-50');
        inputs.forEach(input => input.disabled = true);
    }
});

// Handle reranking provider change
document.getElementById('rerankProvider').addEventListener('change', function() {
    updateRerankingModels();
});

function updateEmbeddingModels() {
    const provider = document.getElementById('embeddingProvider').value;
    const docModelSelect = document.getElementById('documentEmbeddingModel');
    const convModelSelect = document.getElementById('conversationEmbeddingModel');

    // Store current selections
    const currentDocModel = docModelSelect.value;
    const currentConvModel = convModelSelect.value;

    // Clear options
    docModelSelect.innerHTML = '';
    convModelSelect.innerHTML = '';

    let options = [];

    if (provider === 'local') {
        options = [
            { value: 'bge-m3', text: 'BGE-M3 (1024 dimensions, On-Prem)' }
        ];
    } else if (provider === 'openai') {
        options = [
            { value: 'text-embedding-3-small', text: 'text-embedding-3-small' },
            { value: 'text-embedding-3-large', text: 'text-embedding-3-large' }
        ];
    } else if (provider === 'deepinfra' || provider === 'novita') {
        options = [
            { value: 'Qwen/Qwen3-Embedding-0.6B', text: 'Qwen3-Embedding-0.6B (Fastest)' },
            { value: 'Qwen/Qwen3-Embedding-4B', text: 'Qwen3-Embedding-4B (Balanced)' },
            { value: 'Qwen/Qwen3-Embedding-8B', text: 'Qwen3-Embedding-8B (Highest Quality)' }
        ];
    } else if (provider === 'siliconflow') {
        options = [
            { value: 'Qwen/Qwen3-Embedding-0.6B', text: 'Qwen3-Embedding-0.6B (Fastest)' },
            { value: 'Qwen/Qwen3-Embedding-4B', text: 'Qwen3-Embedding-4B (Balanced)' },
            { value: 'Qwen/Qwen3-Embedding-8B', text: 'Qwen3-Embedding-8B (Highest Quality)' }
        ];
    }

    // Add options to both selects
    options.forEach(opt => {
        const docOption = new Option(opt.text, opt.value);
        const convOption = new Option(opt.text, opt.value);

        // Restore selection if possible
        if (opt.value === currentDocModel) docOption.selected = true;
        if (opt.value === currentConvModel) convOption.selected = true;

        docModelSelect.appendChild(docOption);
        convModelSelect.appendChild(convOption);
    });

    // If no selection was restored, select the first option
    if (!docModelSelect.value && options.length > 0) {
        docModelSelect.value = options[0].value;
    }
    if (!convModelSelect.value && options.length > 0) {
        convModelSelect.value = options[0].value;
    }

    // Update dimension visibility
    updateDimensionVisibility();
}

function updateDimensionVisibility() {
    const provider = document.getElementById('embeddingProvider').value;
    const docModel = document.getElementById('documentEmbeddingModel').value;
    const convModel = document.getElementById('conversationEmbeddingModel').value;
    const dimensionSection = document.getElementById('embeddingDimensionSection');

    // Local BGE-M3 uses fixed 1024 dimensions - no selector needed
    if (provider === 'local') {
        dimensionSection.style.display = 'none';
        return;
    }

    // Show dimension selector if provider is deepinfra/siliconflow and either model is a Qwen embedding model
    const isEligibleProvider = provider === 'deepinfra' || provider === 'siliconflow';
    const hasQwenEmbedding = (docModel && docModel.includes('Qwen') && docModel.includes('Embedding')) ||
                            (convModel && convModel.includes('Qwen') && convModel.includes('Embedding'));

    if (isEligibleProvider && hasQwenEmbedding) {
        dimensionSection.style.display = 'block';
    } else {
        dimensionSection.style.display = 'none';
    }
}

function updateRerankingModels() {
    const provider = document.getElementById('rerankProvider').value;
    const modelSelect = document.getElementById('rerankModel');
    const currentModel = modelSelect.value;

    // Show/hide options based on provider
    const options = modelSelect.querySelectorAll('option');
    options.forEach(option => {
        const optionProvider = option.getAttribute('data-provider');
        if (provider === 'none' || optionProvider === provider) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    });

    // If current selection is hidden, select first visible option
    const currentOption = modelSelect.querySelector(`option[value="${currentModel}"]`);
    if (currentOption && currentOption.style.display === 'none') {
        const firstVisible = modelSelect.querySelector(`option[data-provider="${provider}"]:not([style*="display: none"])`);
        if (firstVisible) {
            modelSelect.value = firstVisible.value;
        }
    }

    // For local provider, automatically select the BGE model
    if (provider === 'local') {
        modelSelect.value = 'bge-reranker-v2-m3';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateEmbeddingModels();
    updateDimensionVisibility();
    updateRerankingModels();
});

// Form will submit naturally when Save Changes button is clicked

function showNotification(type, message) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-0 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-x-circle'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(notification);
    
    // Fade in
    setTimeout(() => notification.classList.add('opacity-100'), 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('opacity-0', 'translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

async function syncAgents() {
    showNotification('success', 'Starting agent sync...');
    
    try {
        const response = await fetch(`/api/v1/agents/sync?client_id={{ client.id }}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification('success', result.message || 'Agents synced successfully!');
            
            // Refresh the page after a moment to show updated agents
            setTimeout(() => {
                window.location.href = '/admin/agents';
            }, 2000);
        } else {
            const error = await response.json();
            showNotification('error', 'Error syncing agents: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        showNotification('error', 'Error syncing agents: ' + error.message);
    }
}

async function deleteWordpressSite(siteId, clientId) {
    if (!confirm('Delete this WordPress site? This cannot be undone.')) {
        return;
    }
    try {
        const res = await fetch(`/admin/wordpress-sites/${siteId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
            showNotification('success', 'WordPress site deleted');
            setTimeout(() => window.location.href = `/admin/clients/${clientId}`, 500);
        } else {
            showNotification('error', data.error || 'Failed to delete site');
        }
    } catch (err) {
        showNotification('error', 'Error deleting site: ' + err.message);
    }
}

// =============================================
// Embedding Migration Modal
// =============================================
const originalEmbeddingProvider = '{{ client.settings.get("embedding", {}).get("provider", "openai") }}';
const originalDocModel = '{{ client.settings.get("embedding", {}).get("document_model", "") }}';
const originalConvModel = '{{ client.settings.get("embedding", {}).get("conversation_model", "") }}';
let migrationJobId = null;
let migrationPollInterval = null;

// Track embedding config changes
function hasEmbeddingConfigChanged() {
    const currentProvider = document.getElementById('embeddingProvider').value;
    const currentDocModel = document.getElementById('documentEmbeddingModel').value;
    const currentConvModel = document.getElementById('conversationEmbeddingModel').value;

    return currentProvider !== originalEmbeddingProvider ||
           currentDocModel !== originalDocModel ||
           currentConvModel !== originalConvModel;
}

// Show migration modal
function showMigrationModal() {
    document.getElementById('migrationModal').classList.remove('hidden');
}

// Hide migration modal
function hideMigrationModal() {
    document.getElementById('migrationModal').classList.add('hidden');
    if (migrationPollInterval) {
        clearInterval(migrationPollInterval);
        migrationPollInterval = null;
    }
}

// Start embedding migration
async function startEmbeddingMigration() {
    const clientId = '{{ client.id }}';

    try {
        document.getElementById('migrationStartBtn').disabled = true;
        document.getElementById('migrationStartBtn').textContent = 'Starting...';

        const response = await fetch('/api/v1/knowledge-base/embedding-migration/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ client_id: clientId })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to start migration');
        }

        const result = await response.json();
        migrationJobId = result.job_id;

        // Show progress section
        document.getElementById('migrationInitial').classList.add('hidden');
        document.getElementById('migrationProgress').classList.remove('hidden');
        document.getElementById('migrationTotalDocs').textContent = result.total_documents;
        document.getElementById('migrationProcessedDocs').textContent = '0';

        // Start polling for status
        migrationPollInterval = setInterval(pollMigrationStatus, 2000);

    } catch (error) {
        showNotification('error', 'Error starting migration: ' + error.message);
        document.getElementById('migrationStartBtn').disabled = false;
        document.getElementById('migrationStartBtn').textContent = 'Start Migration';
    }
}

// Poll migration status
async function pollMigrationStatus() {
    if (!migrationJobId) return;

    try {
        const response = await fetch(`/api/v1/knowledge-base/embedding-migration/status/${migrationJobId}`);
        if (!response.ok) {
            throw new Error('Failed to get migration status');
        }

        const status = await response.json();

        // Update UI
        document.getElementById('migrationProcessedDocs').textContent = status.processed_documents;
        document.getElementById('migrationFailedDocs').textContent = status.failed_documents;

        // Update progress bar
        const progressBar = document.getElementById('migrationProgressBar');
        progressBar.style.width = `${status.progress_percent}%`;
        progressBar.textContent = `${Math.round(status.progress_percent)}%`;

        // Check if completed
        if (status.status === 'completed' || status.status === 'completed_with_errors') {
            clearInterval(migrationPollInterval);
            migrationPollInterval = null;

            // Show completion
            document.getElementById('migrationProgress').classList.add('hidden');
            document.getElementById('migrationComplete').classList.remove('hidden');

            if (status.status === 'completed') {
                document.getElementById('migrationCompleteMessage').textContent =
                    `Successfully migrated ${status.processed_documents} documents.`;
                document.getElementById('migrationCompleteMessage').className = 'text-green-500 font-medium';
            } else {
                document.getElementById('migrationCompleteMessage').textContent =
                    `Migrated ${status.processed_documents} documents. ${status.failed_documents} failed.`;
                document.getElementById('migrationCompleteMessage').className = 'text-yellow-500 font-medium';
            }
        }

    } catch (error) {
        console.error('Error polling migration status:', error);
    }
}

// Skip migration and submit form
function skipMigration() {
    hideMigrationModal();
    document.getElementById('clientForm').submit();
}

// Close modal after migration complete
function closeMigrationAndSubmit() {
    hideMigrationModal();
    document.getElementById('clientForm').submit();
}

// Intercept form submission to check for embedding changes
document.getElementById('clientForm').addEventListener('submit', function(e) {
    if (hasEmbeddingConfigChanged()) {
        e.preventDefault();
        showMigrationModal();
    }
});
</script>

<!-- Embedding Migration Modal -->
<div id="migrationModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60">
    <div class="bg-dark-surface rounded-xl border border-dark-border shadow-2xl max-w-lg w-full mx-4">
        <div class="border-b border-dark-border px-6 py-4">
            <h3 class="text-lg font-semibold text-dark-text flex items-center">
                <svg class="h-5 w-5 text-brand-teal mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Embedding Configuration Changed
            </h3>
        </div>

        <div class="p-6">
            <!-- Initial state -->
            <div id="migrationInitial">
                <p class="text-dark-text-secondary mb-4">
                    You've changed your embedding configuration. All existing documents need to be re-embedded
                    with the new settings for search to work correctly.
                </p>

                <div class="bg-dark-elevated rounded-lg p-4 mb-4">
                    <p class="text-sm text-dark-text-secondary">
                        <i class="bi bi-info-circle mr-1"></i>
                        This process will run in the background and may take several minutes depending on the
                        number of documents.
                    </p>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="skipMigration()"
                            class="px-4 py-2 text-dark-text-secondary hover:text-dark-text transition-colors">
                        Skip for now
                    </button>
                    <button type="button" id="migrationStartBtn" onclick="startEmbeddingMigration()"
                            class="px-4 py-2 bg-brand-teal text-white rounded-lg hover:bg-brand-teal/80 transition-colors">
                        Start Migration
                    </button>
                </div>
            </div>

            <!-- Progress state -->
            <div id="migrationProgress" class="hidden">
                <p class="text-dark-text-secondary mb-4">
                    Re-embedding documents with new configuration...
                </p>

                <div class="mb-4">
                    <div class="flex justify-between text-sm text-dark-text-secondary mb-2">
                        <span>Progress: <span id="migrationProcessedDocs">0</span> / <span id="migrationTotalDocs">0</span></span>
                        <span class="text-red-400">Failed: <span id="migrationFailedDocs">0</span></span>
                    </div>
                    <div class="w-full bg-dark-elevated rounded-full h-4 overflow-hidden">
                        <div id="migrationProgressBar"
                             class="h-full bg-brand-teal text-xs text-white text-center leading-4 transition-all duration-300"
                             style="width: 0%">0%</div>
                    </div>
                </div>

                <p class="text-xs text-dark-text-secondary">
                    <i class="bi bi-clock mr-1"></i>
                    This may take several minutes. You can close this modal and the migration will continue in the background.
                </p>
            </div>

            <!-- Complete state -->
            <div id="migrationComplete" class="hidden">
                <div class="text-center mb-4">
                    <svg class="h-12 w-12 text-green-500 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p id="migrationCompleteMessage" class="text-green-500 font-medium">
                        Migration complete!
                    </p>
                </div>

                <div class="flex justify-center">
                    <button type="button" onclick="closeMigrationAndSubmit()"
                            class="px-6 py-2 bg-brand-teal text-white rounded-lg hover:bg-brand-teal/80 transition-colors">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
